<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: Build System Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="Build-system">Build System Overview </a></h1><p>The AVR software framework includes its own build system consisting of a large number of Makefiles. This page intends to explain how those Makefiles work together, and how they are used to build applications.</p>
<h2><a class="anchor" id="Building-applications">
Building an Application</a></h2>
<p>To build an application, simply enter the appropriate directory under apps/ and type "make". This results in a new directory being created under build/ where the results of the build process will be stored, if it didn't exist already. After performing this step once, subsequent builds can be done either by running "make" from the application directory as before, or by running "make" from the build directory.</p>
<p>Each application has a default board for which the application will be built unless otherwise specified, as well as a default toolchain to use. To build the application for a different board, simply set the <code>CONFIG</code> environment variable to the name of the desired board when running "make", for example like this:</p>
<div class="fragment"><pre class="fragment">make CONFIG=atstk1005 </pre></div><p>To use a different toolchain than the default, set the <code>TOOLCHAIN</code> variable to either "GNU" or "IAR", for example like this:</p>
<div class="fragment"><pre class="fragment">make TOOLCHAIN=GNU </pre></div><p>The build results will be placed in <b>build/<em>application</em>/<em>board</em>/<em>toolchain</em></b>. For example, when building the <em>led-chaser</em> application for the <em>ATEVK1104</em> board using the IAR toolchain, the result will end up in the directory <b>build/led-chaser/atevk1104/IAR</b></p>
<p>By default, the build process is quite silent, only listing which files are being built, not the full command lines used to build them. To see the full commands, enable <em>verbose mode</em> by setting the environment variable <code>V</code> to 1:</p>
<div class="fragment"><pre class="fragment">make V=1 </pre></div><h3><a class="anchor" id="Build-targets">
Build Targets</a></h3>
<p>If no target is specified on the "make" command line, the application will simply be built as an ELF file. Other possibilities are:</p>
<ul>
<li><em>clean</em> - Delete the ELF file and all intermediate build products.</li>
<li><em>docs</em> - Generate documentation tailored to the selected configuration.</li>
<li><em>program</em> - Build the ELF file and program it into flash on the target.</li>
<li><em>reset</em> - Reset the target.</li>
<li><em>run</em> - Start executing code on the target.</li>
</ul>
<p>Several targets may be specified on the command line -- they will be executed in the order specified. For example, the following command will build the ELF file, program it into the target, and start running from the reset vector:</p>
<div class="fragment"><pre class="fragment">make program reset run </pre></div><h2><a class="anchor" id="Configuration">
Configuration</a></h2>
<p>Each application must provide one or more configuration files for the build system. These are named <b>config-<em>board</em>.mk</b>, for each supported board. All applications must provide a configuration file for the default board; configuration files for any other boards is optional.</p>
<p>The configuration files may contain all kinds of Makefile variable definitions, but its primary purpose is to specify configuration variables. These variables are available both to the build system and to the source files, so they need to follow a few special rules:</p>
<ul>
<li>The variable name must begin with <code>CONFIG_</code> </li>
<li>The variable name must be followed by a '=' character and a value with no spaces in between.</li>
<li>String values must be surrounded by double quotes.</li>
<li>Boolean values must be either 'y' or 'n'.</li>
<li>Integer values are expressed using any valid C syntax.</li>
</ul>
<p>During the build process, this file is used as a source for generating the <b>autoconf.h</b> file, which is included implicitly in all source files. The variables are converted as follows:</p>
<ul>
<li>Boolean variables set to 'y' become preprocessor symbols defined as 1.</li>
<li>Boolean variables set to 'n' are not defined (so #ifdef can be used to test the value of boolean configuration variables.)</li>
<li>String and integer variables become preprocessor symbols defined as their respective literal values (including the quotes for string variables.)</li>
</ul>
<p>There are also similar configuration files for each supported board, chip, cpu and architecture named config.mk and placed in the respective board-, chip-, cpu- and architecture-specific subdirectories. These provide reasonable defaults which can be overridden by the application config file.</p>
<h3><a class="anchor" id="Config-optimization">
Optimization</a></h3>
<p>Compiler and linker optimization is controlled through configuration symbols. By default, all files are compiled with maximum size optimization, but this can be customized on a per-application basis.</p>
<p>To optimize for speed instead of size, set <b>CONFIG_OPTIMIZE_SIZE</b> to 'n'. To select a different optimization level, set <b>CONFIG_OPTIMIZE_LEVEL</b> to the desired level (a number from 0 to 3). The following table summarizes the various possibilities</p>
<table class="doxtable">
<tr>
<td><b>CONFIG_OPTIMIZE_SIZE</b> </td><td><b>CONFIG_OPTIMIZE_LEVEL</b> </td><td><b>GCC option</b> </td><td><b>IAR option</b>  </td></tr>
<tr>
<td>y</td><td>0</td><td>-Os</td><td>-z2 </td></tr>
<tr>
<td>y</td><td>1</td><td>-Os</td><td>-z3 </td></tr>
<tr>
<td>y</td><td>2</td><td>-Os</td><td>-z6 </td></tr>
<tr>
<td>y</td><td>3</td><td>-Os</td><td>-z9 </td></tr>
<tr>
<td>n</td><td>0</td><td>-O0</td><td>-s2 </td></tr>
<tr>
<td>n</td><td>1</td><td>-O1</td><td>-s3 </td></tr>
<tr>
<td>n</td><td>2</td><td>-O2</td><td>-s6 </td></tr>
<tr>
<td>n</td><td>3</td><td>-O3</td><td>-s9 </td></tr>
</table>
<p>In addition, two forms of link-time optimizations are enabled by default when using the GNU toolchain. These are:</p>
<ul>
<li><b>CONFIG_RELAX</b>: Link-time relaxation. Try to replace certain instructions by shorter alternatives.</li>
<li><b>CONFIG_GC_SECTIONS</b>: Link-time garbage collection. This will eliminate all functions and data items that aren't referenced.</li>
</ul>
<p>To disable any of those optimizations, set the corresponding configuration symbol to 'n'.</p>
<h2><a class="anchor" id="Subdir-makefiles">
Subdirectory Makefiles</a></h2>
<p>Each subdirectory contains a Makefile fragment specifying which source files that are to be built into objects, and sometimes which additional subdirectories to include in the build. This Makefile fragment is usually called <b>subdir.mk</b>, but there are some exceptions to this rule:</p>
<ul>
<li>Application subdirectory Makefiles are named <b>$(app).mk</b></li>
<li>Chip-, cpu-, arch- and board-specific Makefiles are named <b>chip.mk</b>, <b>cpu.mk</b>, <b>arch.mk</b> and <b>board.mk</b> respectively.</li>
</ul>
<p>The subdirectory Makefiles are usually very small, only appending to a single variable, <em>obj-y</em>, which specifies which objects to build, but there are other variables that may be altered by subdirectory Makefiles as well:</p>
<ul>
<li><b>cppflags-<em>toolchain</em>-y</b> - C preprocessor flags for all files</li>
<li><b>cflags-<em>toolchain</em>-y</b> - C compiler flags for all files</li>
<li><b>ldflags-<em>toolchain</em>-y</b> - Linker flags for the final link</li>
<li><b>ldlibs-<em>toolchain</em>-y</b> - Libraries to include in the final link</li>
</ul>
<p>The reason why all these variables have the suffix -y is to make it easier to support conditional compilation and conditional flags. For example, if a certain object is to be built only when CONFIG_USB is set to 'y', this can be achieved as follows: </p>
<div class="fragment"><pre class="fragment">obj-$(CONFIG_USB)	+= drivers/usb/usb.o </pre></div><h2><a class="anchor" id="Application-makefiles">
Makefiles Provided by the Application</a></h2>
<h3><a class="anchor" id="Top-level-makefile">
The Top-level Application Makefile</a></h3>
<p>Each application found under the apps/ subdirectory contains its own top-level Makefile which can be used to build that particular application. It is usually very simple, delegating the vast majority of the work to the build system core.</p>
<dl class="user"><dt><b>Example: apps/hello/Makefile</b></dt><dd><div class="fragment"><pre class="fragment">src                     := ../..
app                     := led-chaser
DEFAULT_CONFIG          := xplain
DEFAULT_TOOLCHAIN       := GNU

include $(src)/make/app.mk
</pre></div></dd></dl>
<p>The following variables must be defined by the top-level Application Makefile:</p>
<ul>
<li><em>src</em> - The relative path to the top-level source directory</li>
<li><em>app</em> - The name of the application. <b>$(src)/apps/$(app)</b> must resolve to the directory in which the Makefile resides.</li>
<li><em>DEFAULT_CONFIG</em> - The name of the board to build for when the user doesn't specify any particular board.</li>
<li><em>DEFAULT_TOOLCHAIN</em> - The toolchain to use when the user doesn't specify any particular toolchain.</li>
</ul>
<p>After defining these variables, the Makefile should simply include <b>$(src)/make/app.mk</b> to take care of the rest.</p>
<h3><a class="anchor" id="App-subdir-makefile">
Application Subdirectory Makefile</a></h3>
<p>The application must include a file named <b>$(app).mk</b> specifying any application-specific object files and flags. This file follows the syntax described in the section <a class="el" href="Build-system.html#Subdir-makefiles">Subdirectory Makefiles</a>. </p>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 15:18:22 2010 for display-training by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
