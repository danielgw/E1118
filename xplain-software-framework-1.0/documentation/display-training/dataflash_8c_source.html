<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: drivers/block/dataflash.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/block/dataflash.c</h1><a href="dataflash_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html" title="Run-time and build-time assertion support.">assert.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2bitops_8h.html" title="AVR-specific implementation of bit operations.">bitops.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html" title="Debug console.">debug.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html" title="AVR-specific interrupt masking/unmasking.">interrupt.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="malloc_8h.html" title="Standard dynamic memory allocator.">malloc.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="status__codes_8h.html" title="Status code definitions.">status_codes.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2string_8h.html" title="Standard string operations for AVR.">string.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="util_8h.html" title="Misc utility functions and definitions.">util.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2string_8h.html" title="Standard string operations for AVR.">string.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="board_2xplain_2include_2board_2spi_8h.html" title="Board-specific SPI control.">spi.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="device_8h.html" title="Block Device interface.">block/device.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="dataflash_8h.html" title="DataFlash&amp;reg; block device driver interface.">block/dataflash.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="workqueue_8h.html" title="Workqueue interface.">workqueue.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="mempool_8h.html" title="Memory pool allocator.">mempool.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="at45__device_8h.html" title="AT45 DataFlash(R) Device Driver.">flash/at45_device.h</a>&gt;</span>
<a name="l00053"></a>00053 
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gace3c7d07529675286a196500466ed36e">00107</a> <span class="preprocessor">#define DATAFLASH_BLOCK_SIZE 512</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>
<a name="l00110"></a><a class="code" href="structdataflash__breq.html">00110</a> <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> {
<a name="l00112"></a><a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b">00112</a>         <span class="keyword">struct </span><a class="code" href="structblock__request.html" title="A block device request.">block_request</a>  <a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>;
<a name="l00114"></a><a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5">00114</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> <a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>;
<a name="l00116"></a><a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184">00116</a>         <a class="code" href="group__block__device__group.html#ga7495726fae831c474d600b34d8d81bf5" title="Type for holding a logical block address (LBA).">block_addr_t</a>          <a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a>;
<a name="l00118"></a><a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c">00118</a>         <a class="code" href="group__block__device__group.html#ga11f0187c28890586d4eca78ee289c97f" title="Type for holding a block length (i.e. number of blocks).">block_len_t</a>           <a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a>;
<a name="l00120"></a><a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f">00120</a>         <span class="keyword">enum</span> <a class="code" href="group__block__device__group.html#ga154d08031ee1f7e8312fc53355eb47e7" title="Block device operation codes.">block_operation</a>  <a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a>;
<a name="l00122"></a><a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12">00122</a>         <span class="keywordtype">bool</span>                  <a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12" title="Indicates if operation is waiting for free buffers.">sleeping</a>;
<a name="l00123"></a>00123 };
<a name="l00124"></a>00124 
<a name="l00126"></a><a class="code" href="structdataflash__bdev.html">00126</a> <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> {
<a name="l00128"></a><a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215">00128</a>         <span class="keyword">struct </span><a class="code" href="structblock__device.html" title="A block device.">block_device</a>   <a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>;
<a name="l00130"></a><a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8">00130</a>         <span class="keyword">struct </span><a class="code" href="structat45__device.html" title="AT45 DataFlash device.">at45_device</a>    <a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>;
<a name="l00132"></a><a class="code" href="structdataflash__bdev.html#aacc639066f20e0990bde973c3be3be5c">00132</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__bdev.html#aacc639066f20e0990bde973c3be3be5c" title="Workqueue task to run on events.">event_task</a>;
<a name="l00134"></a><a class="code" href="structdataflash__bdev.html#a4b18ef4a635ccc02d8a64c388bef40b2">00134</a>         <span class="keyword">struct </span><a class="code" href="structmem__pool.html" title="Memory pool.">mem_pool</a>       <a class="code" href="structdataflash__bdev.html#a4b18ef4a635ccc02d8a64c388bef40b2" title="Memory pool used to allocate memory for dataflash_breq.">req_pool</a>;
<a name="l00136"></a><a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71">00136</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> <a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>;
<a name="l00143"></a><a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">00143</a>         <a class="code" href="group__stdint__group.html#ga20c38cc5aac7cc6b0a3c6ab05428436d" title="8-bit signed integer">int8_t</a>                <a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">page_block_shift</a>;
<a name="l00145"></a><a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a">00145</a>         <span class="keyword">struct </span><a class="code" href="structslist.html" title="A singly linked list.">slist</a>          <a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>;
<a name="l00147"></a><a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b">00147</a>         <span class="keywordtype">int</span>                   <a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a>;
<a name="l00148"></a>00148 };
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *dataflash_breq_of(
<a name="l00151"></a>00151                 <span class="keyword">struct</span> <a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *req)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153         <span class="keywordflow">return</span> <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(req, <span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a>, <a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *dataflash_bdev_of(
<a name="l00157"></a>00157                 <span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *dev)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159         <span class="keywordflow">return</span> <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(dev, <span class="keyword">struct</span> <a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a>, <a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>);
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *dataflash_breq_of_task(
<a name="l00163"></a>00163                 <span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         <span class="keywordflow">return</span> <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(task, <span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a>, task);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00180"></a><a class="code" href="group__block__device__dataflash__internals__group.html#ga2233acc299e7f539b184ccd8eeb3bfd0">00180</a> <span class="keyword">static</span> <a class="code" href="group__stdint__group.html#ga20c38cc5aac7cc6b0a3c6ab05428436d" title="8-bit signed integer">int8_t</a> <a class="code" href="group__block__device__dataflash__internals__group.html#ga2233acc299e7f539b184ccd8eeb3bfd0" title="Get DataFlash page size vs. block size shift value.">dataflash_get_page_block_shift</a>(<span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">return</span> df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">page_block_shift</a>;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00197"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gac5c4caa45f2c66c026f8d01b23229d23">00197</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gac5c4caa45f2c66c026f8d01b23229d23" title="Test if request currently is aligned into whole page.">dataflash_is_page_aligned</a>(<span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199         <a class="code" href="group__stdint__group.html#ga20c38cc5aac7cc6b0a3c6ab05428436d" title="8-bit signed integer">int8_t</a> shift;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         shift = <a class="code" href="group__block__device__dataflash__internals__group.html#ga2233acc299e7f539b184ccd8eeb3bfd0" title="Get DataFlash page size vs. block size shift value.">dataflash_get_page_block_shift</a>(df_breq);
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (shift == 0)
<a name="l00203"></a>00203                 <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Always true for same size page and block</span>
<a name="l00204"></a>00204         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shift == 1) {
<a name="l00205"></a>00205                 <span class="comment">/* For a page size the double of block size; the block address</span>
<a name="l00206"></a>00206 <span class="comment">                 * (lba) must be on a even address and ramining block must be</span>
<a name="l00207"></a>00207 <span class="comment">                 * larger than 2 for the remaining data transfer to cover a</span>
<a name="l00208"></a>00208 <span class="comment">                 * whole page.</span>
<a name="l00209"></a>00209 <span class="comment">                 */</span>
<a name="l00210"></a>00210                 <span class="keywordflow">if</span> (!(df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &amp; 1) &amp;&amp; (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a> &gt;= 2))
<a name="l00211"></a>00211                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00212"></a>00212                 <span class="keywordflow">else</span>
<a name="l00213"></a>00213                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00214"></a>00214         } <span class="keywordflow">else</span>
<a name="l00215"></a>00215                 <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Always true for page size smaller than block</span>
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00226"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gae12991bcaa1d47c05e9d21856f13b025">00226</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gae12991bcaa1d47c05e9d21856f13b025" title="Store DataFlash page size into shift value.">dataflash_store_page_size</a>(<span class="keyword">struct</span> <a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev,
<a name="l00227"></a>00227                 <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> page_size)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229         <span class="keywordflow">switch</span> (page_size) {
<a name="l00230"></a>00230         <span class="keywordflow">case</span> 256:
<a name="l00231"></a>00231                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">page_block_shift</a> = -1;
<a name="l00232"></a>00232                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00233"></a>00233         <span class="keywordflow">case</span> 512:
<a name="l00234"></a>00234                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">page_block_shift</a> = 0;
<a name="l00235"></a>00235                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00236"></a>00236         <span class="keywordflow">case</span> 1024:
<a name="l00237"></a>00237                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4d6e8cba754c60ecab1fa1af7309ce01">page_block_shift</a> = 1;
<a name="l00238"></a>00238                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00239"></a>00239         <span class="keywordflow">default</span>:
<a name="l00240"></a>00240                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00251"></a><a class="code" href="group__block__device__dataflash__internals__group.html#ga911ea90d6f1b0f6a23d11d39ed605007">00251</a> <span class="keyword">static</span> <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> <a class="code" href="group__block__device__dataflash__internals__group.html#ga911ea90d6f1b0f6a23d11d39ed605007" title="Get DataFlash remaining partial page size.">dataflash_get_remaining_page_size</a>(
<a name="l00252"></a>00252                 <span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq)
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254         <a class="code" href="group__stdint__group.html#ga20c38cc5aac7cc6b0a3c6ab05428436d" title="8-bit signed integer">int8_t</a> shift;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         shift = <a class="code" href="group__block__device__dataflash__internals__group.html#ga2233acc299e7f539b184ccd8eeb3bfd0" title="Get DataFlash page size vs. block size shift value.">dataflash_get_page_block_shift</a>(df_breq);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="comment">// We only support 256, 512 and 1024 byte page size</span>
<a name="l00259"></a>00259         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>((shift &gt;= -1) &amp;&amp; (shift &lt;= 1));
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (shift == 0) <span class="comment">// Equal page size and block size</span>
<a name="l00262"></a>00262                 <span class="keywordflow">return</span> 512;
<a name="l00263"></a>00263         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shift == 1) {
<a name="l00264"></a>00264                 <span class="comment">/* Page size if bigger than block size.</span>
<a name="l00265"></a>00265 <span class="comment">                 * Check if address is even and ramining transfer is large</span>
<a name="l00266"></a>00266 <span class="comment">                 * enough to cover a full page or not.</span>
<a name="l00267"></a>00267 <span class="comment">                 */</span>
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> (!(df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &amp; 1) &amp;&amp; (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a> &gt;= 2))
<a name="l00269"></a>00269                         <span class="keywordflow">return</span> 1024;
<a name="l00270"></a>00270                 <span class="keywordflow">else</span>
<a name="l00271"></a>00271                         <span class="keywordflow">return</span> 512;
<a name="l00272"></a>00272         } <span class="keywordflow">else</span> {
<a name="l00273"></a>00273                 <span class="comment">// Page size smaller than block size</span>
<a name="l00274"></a>00274                 <span class="keywordflow">return</span> 256;
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_read_setup(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>);
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_setup(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_page_done(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00284"></a>00284         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.buf_list_done(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>, &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>,
<a name="l00287"></a>00287                         &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00288"></a>00288         df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.bytes_xfered += df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a>;
<a name="l00289"></a>00289         df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a> -=
<a name="l00290"></a>00290                         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a> / <a class="code" href="group__block__device__dataflash__internals__group.html#gace3c7d07529675286a196500466ed36e" title="The DataFlash block device block size.">DATAFLASH_BLOCK_SIZE</a>;
<a name="l00291"></a>00291         df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> += df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a> / <a class="code" href="group__block__device__dataflash__internals__group.html#gace3c7d07529675286a196500466ed36e" title="The DataFlash block device block size.">DATAFLASH_BLOCK_SIZE</a>;
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a>) {
<a name="l00293"></a>00293                 <span class="keywordflow">if</span> (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a> == <a class="code" href="group__block__device__group.html#gga154d08031ee1f7e8312fc53355eb47e7ad38ff3dc6aa2daa5f52712ca12fe18a7" title="Read data from the device.">BLK_OP_READ</a>)
<a name="l00294"></a>00294                         dataflash_read_setup(task);
<a name="l00295"></a>00295                 <span class="keywordflow">else</span>
<a name="l00296"></a>00296                         dataflash_write_setup(task);
<a name="l00297"></a>00297         } <span class="keywordflow">else</span> {
<a name="l00298"></a>00298                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: req done\n&quot;</span>);
<a name="l00299"></a>00299                 <a class="code" href="group__at45__device__group.html#gac00f784a9b33e954436f476d72b46533" title="Release exclusive access to AT45 device.">at45_release</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00300"></a>00300                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a2635bd33014193b5e077eec42dae60cb">status</a> = <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00301"></a>00301                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a7b02b7ad2aa6012902678b6a9684e639">req_done</a>(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>, &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>);
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_read_done(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task);
<a name="l00306"></a>00306 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_done(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_transfer(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00311"></a>00311         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00312"></a>00312         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>         *buf;
<a name="l00313"></a>00313         <span class="keywordtype">int</span>                   next_pos;
<a name="l00314"></a>00314         <span class="keywordtype">int</span>                   end_pos;
<a name="l00315"></a>00315         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a59a24f6c541d2c1b20d7c897ed7bdbca" title="Type used for holding the current interrupt state.">irqflags_t</a>            flags;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (!<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>)) {
<a name="l00318"></a>00318                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.buf_list_done(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>, &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>,
<a name="l00319"></a>00319                                 &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00320"></a>00320                 <a class="code" href="slist_8h.html#a430c94443e9ea2bc2dbaf3c3ab0e29db" title="Initialize a singly linked list.">slist_init</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         flags = <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#ad0c5a270013dca8848f9902ec131c51f" title="Save the current interrupt state and disable interrupts.">cpu_irq_save</a>();
<a name="l00324"></a>00324         <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a3955c8db68dda49d34ecc35b78f614d3">buf_list</a>)) {
<a name="l00325"></a>00325                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: sleep\n&quot;</span>);
<a name="l00326"></a>00326                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12" title="Indicates if operation is waiting for free buffers.">sleeping</a> = <span class="keyword">true</span>;
<a name="l00327"></a>00327                 <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(flags);
<a name="l00328"></a>00328                 <span class="keywordflow">return</span>;
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(flags);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         next_pos = df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a>;
<a name="l00333"></a>00333         end_pos = <a class="code" href="group__block__device__dataflash__internals__group.html#ga911ea90d6f1b0f6a23d11d39ed605007" title="Get DataFlash remaining partial page size.">dataflash_get_remaining_page_size</a>(df_breq);
<a name="l00334"></a>00334         <span class="keywordflow">while</span> (next_pos &lt; end_pos) {
<a name="l00335"></a>00335                 flags = <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#ad0c5a270013dca8848f9902ec131c51f" title="Save the current interrupt state and disable interrupts.">cpu_irq_save</a>();
<a name="l00336"></a>00336                 <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a3955c8db68dda49d34ecc35b78f614d3">buf_list</a>)) {
<a name="l00337"></a>00337                         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(flags);
<a name="l00338"></a>00338                         <span class="keywordflow">break</span>;
<a name="l00339"></a>00339                 } <span class="keywordflow">else</span>
<a name="l00340"></a>00340                         buf = <a class="code" href="group__buffer__group.html#ga204cf3ab1d8dc73993f3d68c08743bee" title="Return the first buffer in list and remove it.">buf_list_pop_head</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a3955c8db68dda49d34ecc35b78f614d3">buf_list</a>);
<a name="l00341"></a>00341                 <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(flags);
<a name="l00342"></a>00342                 <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>((next_pos + buf-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>) &lt;= end_pos);
<a name="l00343"></a>00343                 <a class="code" href="slist_8h.html#acd0f70535b445ece86170eb70bd54365" title="Insert node as the last node in list.">slist_insert_tail</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>, &amp;buf-&gt;<a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00344"></a>00344                 next_pos += buf-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>;
<a name="l00345"></a>00345         }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a> = next_pos;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a> == <a class="code" href="group__block__device__group.html#gga154d08031ee1f7e8312fc53355eb47e7ad38ff3dc6aa2daa5f52712ca12fe18a7" title="Read data from the device.">BLK_OP_READ</a>) {
<a name="l00350"></a>00350                 <span class="keywordflow">if</span> (next_pos == end_pos) {
<a name="l00351"></a>00351                         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>,
<a name="l00352"></a>00352                                         dataflash_read_done);
<a name="l00353"></a>00353                 }
<a name="l00354"></a>00354                 <a class="code" href="group__at45__device__group.html#gaac455ed7e90213b411d69fdd0bffd81e" title="Read from AT45 device into buffer list.">at45_read_buf_list</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00355"></a>00355         } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356                 <span class="keywordflow">if</span> (next_pos == end_pos) {
<a name="l00357"></a>00357                         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>,
<a name="l00358"></a>00358                                         dataflash_write_done);
<a name="l00359"></a>00359                 }
<a name="l00360"></a>00360                 <a class="code" href="group__at45__device__group.html#gaf9f6a1db0bef53cd79b1736083901af6" title="Write from buffer list into AT45 device.">at45_write_buf_list</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_read_done(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00367"></a>00367         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <a class="code" href="group__at45__device__group.html#ga87ed992a0661dc92ba848d296e3b85e4" title="De-select AT45 device (Chip de-select).">at45_deselect</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00370"></a>00370         dataflash_page_done(task);
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_read_setup(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00376"></a>00376         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>, dataflash_transfer);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a> = 0;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <a class="code" href="group__at45__device__group.html#ga3d95f27343b2fd462ba8f36fc1b4ceb8" title="Select AT45 device (Chip select).">at45_select</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00383"></a>00383         <a class="code" href="group__at45__device__group.html#gaf4daf5946660b9188800ecd6bac79f16" title="Write AT45 device command: continous array read.">at45_cmd_cont_array_read</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &gt;&gt; 1,
<a name="l00384"></a>00384                         (df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &amp; 1) &lt;&lt; 9);
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_wait(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00390"></a>00390         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00391"></a>00391         <span class="keywordtype">bool</span>                  done;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         done = <a class="code" href="group__at45__device__group.html#gabafbdb27b90d1184865d9d29a9cb90a6" title="Actively wait for AT45 device to be ready.">at45_wait_ready</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00394"></a>00394         <span class="keywordflow">if</span> (!done) {
<a name="l00395"></a>00395                 <span class="comment">// task will be re-sceduled on new wait event so just return</span>
<a name="l00396"></a>00396                 <span class="keywordflow">return</span>;
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398         dataflash_page_done(task);
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_wait_begin(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00402"></a>00402 {
<a name="l00403"></a>00403         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00404"></a>00404         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <a class="code" href="group__at45__device__group.html#ga87ed992a0661dc92ba848d296e3b85e4" title="De-select AT45 device (Chip de-select).">at45_deselect</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00407"></a>00407         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>,
<a name="l00408"></a>00408                         dataflash_write_wait);
<a name="l00409"></a>00409         dataflash_write_wait(task);
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_done(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00415"></a>00415         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>,
<a name="l00418"></a>00418                         dataflash_write_wait_begin);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <a class="code" href="group__at45__device__group.html#ga87ed992a0661dc92ba848d296e3b85e4" title="De-select AT45 device (Chip de-select).">at45_deselect</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00421"></a>00421         <a class="code" href="group__at45__device__group.html#ga3d95f27343b2fd462ba8f36fc1b4ceb8" title="Select AT45 device (Chip select).">at45_select</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00422"></a>00422         <a class="code" href="group__at45__device__group.html#ga851af42756c18987d9c136e6a0b432fd" title="Write AT45 device command: buffer 1 main memory program with erase.">at45_cmd_buffer_1_main_memory_program_with_erase</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>,
<a name="l00423"></a>00423                         df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &gt;&gt; 1);
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_ready(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00429"></a>00429         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>, dataflash_transfer);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433         <a class="code" href="group__at45__device__group.html#ga3d95f27343b2fd462ba8f36fc1b4ceb8" title="Select AT45 device (Chip select).">at45_select</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00434"></a>00434         <a class="code" href="group__at45__device__group.html#ga4a61c7aa3618ad4364c85b155b962bc1" title="Write AT45 device command: buffer 1 write.">at45_cmd_buffer_1_write</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, (df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &amp; 1) &lt;&lt; 9);
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_buffered_wait(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00440"></a>00440         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00441"></a>00441         <span class="keywordtype">bool</span>                  done;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         done = <a class="code" href="group__at45__device__group.html#gabafbdb27b90d1184865d9d29a9cb90a6" title="Actively wait for AT45 device to be ready.">at45_wait_ready</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (!done) {
<a name="l00445"></a>00445                 <span class="comment">// task will be re-sceduled on new wait event so just return</span>
<a name="l00446"></a>00446                 <span class="keywordflow">return</span>;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448         dataflash_write_ready(task);
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_buffered(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00454"></a>00454         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         <a class="code" href="group__at45__device__group.html#ga87ed992a0661dc92ba848d296e3b85e4" title="De-select AT45 device (Chip de-select).">at45_deselect</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00457"></a>00457         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>,
<a name="l00458"></a>00458                         dataflash_write_buffered_wait);
<a name="l00459"></a>00459         dataflash_write_buffered_wait(task);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_write_setup(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00465"></a>00465         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>, dataflash_write_buffered);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#affcffb4f83363a116bac5dc22d396b7b" title="Current transfer byte position.">transfer_pos</a> = 0;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         <span class="keywordflow">if</span> (<a class="code" href="group__block__device__dataflash__internals__group.html#gac5c4caa45f2c66c026f8d01b23229d23" title="Test if request currently is aligned into whole page.">dataflash_is_page_aligned</a>(df_breq))
<a name="l00472"></a>00472                 dataflash_write_ready(task);
<a name="l00473"></a>00473         <span class="keywordflow">else</span> {
<a name="l00474"></a>00474                 <span class="comment">/* For writes not covering a whole page it needs to read into</span>
<a name="l00475"></a>00475 <span class="comment">                 * buffer, modify buffer and write back page.</span>
<a name="l00476"></a>00476 <span class="comment">                 */</span>
<a name="l00477"></a>00477                 <a class="code" href="group__at45__device__group.html#ga3d95f27343b2fd462ba8f36fc1b4ceb8" title="Select AT45 device (Chip select).">at45_select</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00478"></a>00478                 <a class="code" href="group__at45__device__group.html#ga685aefa8fa2fefb33efb4ab5514e6eb8" title="Write AT45 device command: main memory to buffer 1 transfer.">at45_cmd_main_memory_to_buffer_1_transfer</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>,
<a name="l00479"></a>00479                                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> &gt;&gt; 1);
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="keyword">static</span> <span class="keywordtype">void</span> dataflash_start(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of_task(task);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="keywordflow">switch</span> (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a>) {
<a name="l00488"></a>00488         <span class="keywordflow">case</span> <a class="code" href="group__block__device__group.html#gga154d08031ee1f7e8312fc53355eb47e7ad38ff3dc6aa2daa5f52712ca12fe18a7" title="Read data from the device.">BLK_OP_READ</a>:
<a name="l00489"></a>00489                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: reading %ld blocks @ 0x%04lx ...\n&quot;</span>,
<a name="l00490"></a>00490                                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a>, df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a>);
<a name="l00491"></a>00491                 dataflash_read_setup(task);
<a name="l00492"></a>00492                 <span class="keywordflow">break</span>;
<a name="l00493"></a>00493         <span class="keywordflow">case</span> <a class="code" href="group__block__device__group.html#gga154d08031ee1f7e8312fc53355eb47e7a6df37ee16d86ac821be745ca77cef317" title="Write data to the device.">BLK_OP_WRITE</a>:
<a name="l00494"></a>00494                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: writing %ld blocks @ 0x%04lx ...\n&quot;</span>,
<a name="l00495"></a>00495                                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a>, df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a>);
<a name="l00496"></a>00496                 dataflash_write_setup(task);
<a name="l00497"></a>00497                 <span class="keywordflow">break</span>;
<a name="l00498"></a>00498         <span class="keywordflow">default</span>:
<a name="l00499"></a>00499                 <a class="code" href="group__assert__group.html#ga3ac92363f706f624b3ff8b5489f8af05" title="Assert that the case value will never need to be handled.">unhandled_case</a>(df_breq-&gt;<a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a>);
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00504"></a><a class="code" href="group__block__device__dataflash__internals__group.html#ga34ab87e763b43c3853ff81684c4ef3e2">00504</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__block__device__dataflash__internals__group.html#ga34ab87e763b43c3853ff81684c4ef3e2">dataflash_submit</a>(<span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *bdev,
<a name="l00505"></a>00505                 <span class="keyword">struct</span> <a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(bdev);
<a name="l00508"></a>00508         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of(breq);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <a class="code" href="group__at45__device__group.html#gacf61055777a5db5284b3cdc3226dbd05" title="Request exclusive access to AT45 device.">at45_request</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>);
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00514"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gaa2df3d3ded803aa00f1065163383c250">00514</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gaa2df3d3ded803aa00f1065163383c250">dataflash_submit_buf_list</a>(<span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *bdev,
<a name="l00515"></a>00515                 <span class="keyword">struct</span> <a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>, <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *buf_list)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of(breq);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: submit_buf_list\n&quot;</span>);
<a name="l00520"></a>00520         <a class="code" href="slist_8h.html#a3863d98974ba6363a3b906731e162c91" title="Move all the nodes in from to the tail of the list to.">slist_move_to_tail</a>(&amp;breq-&gt;<a class="code" href="structblock__request.html#a3955c8db68dda49d34ecc35b78f614d3">buf_list</a>, buf_list);
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (df_breq-&gt;<a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12" title="Indicates if operation is waiting for free buffers.">sleeping</a>) {
<a name="l00522"></a>00522                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;DataFlash: wakeup\n&quot;</span>);
<a name="l00523"></a>00523                 df_breq-&gt;<a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12" title="Indicates if operation is waiting for free buffers.">sleeping</a> = <span class="keyword">false</span>;
<a name="l00524"></a>00524                 <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>);
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00531"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gadadb4fa61053cb219150ec3fea8c6caa">00531</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gadadb4fa61053cb219150ec3fea8c6caa">dataflash_prepare_req</a>(<span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *bdev,
<a name="l00532"></a>00532                 <span class="keyword">struct</span> <a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>,
<a name="l00533"></a>00533                 <a class="code" href="group__block__device__group.html#ga7495726fae831c474d600b34d8d81bf5" title="Type for holding a logical block address (LBA).">block_addr_t</a> <a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a>, <a class="code" href="group__block__device__group.html#ga11f0187c28890586d4eca78ee289c97f" title="Type for holding a block length (i.e. number of blocks).">block_len_t</a> nr_blocks,
<a name="l00534"></a>00534                 <span class="keyword">enum</span> <a class="code" href="group__block__device__group.html#ga154d08031ee1f7e8312fc53355eb47e7" title="Block device operation codes.">block_operation</a> <a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a>)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of(breq);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         breq-&gt;<a class="code" href="structblock__request.html#a2635bd33014193b5e077eec42dae60cb">status</a> = <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a9b25aed7ac4ef4fc3c7250543bb113c0" title="Operation in progress.">OPERATION_IN_PROGRESS</a>;
<a name="l00539"></a>00539         breq-&gt;bytes_xfered = 0;
<a name="l00540"></a>00540         <a class="code" href="group__workqueue__group.html#gac6ff4c2fe890595f39cd7d67ce8a26ed" title="Initialize a work queue task.">workqueue_task_init</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#a3cbf019f315b619f4ebf42bbd19670f5" title="Task associated with this request.">task</a>, dataflash_start);
<a name="l00541"></a>00541         df_breq-&gt;<a class="code" href="structdataflash__breq.html#ac437db200d4552c2642e2065e55ff184" title="Logical block address of the block to process.">lba</a> = lba;
<a name="l00542"></a>00542         df_breq-&gt;<a class="code" href="structdataflash__breq.html#a7a67453e23b33d8273542333dc2a0c4c" title="Number of remaining blocks to process.">remaining_blocks</a> = nr_blocks;
<a name="l00543"></a>00543         df_breq-&gt;<a class="code" href="structdataflash__breq.html#a58f601dd82485a62ef8e7674cd03595f" title="Operation to process (read, write).">operation</a> = operation;
<a name="l00544"></a>00544         df_breq-&gt;<a class="code" href="structdataflash__breq.html#a311dcecd6b7a2cb18473741a5086ee12" title="Indicates if operation is waiting for free buffers.">sleeping</a> = <span class="keyword">false</span>;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00548"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gaaf699af20c5179c9b49291e3c828ffe5">00548</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *<a class="code" href="group__block__device__dataflash__internals__group.html#gaaf699af20c5179c9b49291e3c828ffe5">dataflash_alloc_req</a>(<span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a>)
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(bdev);
<a name="l00551"></a>00551         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         df_breq = <a class="code" href="group__mempool__group.html#ga5e7c4701fb65890927dc29ae4ee5e5c4" title="Allocate an object from a memory pool.">mem_pool_alloc</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4b18ef4a635ccc02d8a64c388bef40b2" title="Memory pool used to allocate memory for dataflash_breq.">req_pool</a>);
<a name="l00554"></a>00554         <span class="keywordflow">if</span> (!df_breq)
<a name="l00555"></a>00555                 <span class="keywordflow">return</span> NULL;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <a class="code" href="slist_8h.html#a430c94443e9ea2bc2dbaf3c3ab0e29db" title="Initialize a singly linked list.">slist_init</a>(&amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a3955c8db68dda49d34ecc35b78f614d3">buf_list</a>);
<a name="l00558"></a>00558         df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.<a class="code" href="structblock__request.html#a4a64d0d5be2e6c40921ae9fecf518379">bdev</a> = bdev;
<a name="l00559"></a>00559         df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.req_submit = <a class="code" href="group__block__device__dataflash__internals__group.html#ga34ab87e763b43c3853ff81684c4ef3e2">dataflash_submit</a>;
<a name="l00560"></a>00560         df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>.req_submit_buf_list = <a class="code" href="group__block__device__dataflash__internals__group.html#gaa2df3d3ded803aa00f1065163383c250">dataflash_submit_buf_list</a>;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562         <span class="keywordflow">return</span> &amp;df_breq-&gt;<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00566"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gae96c249bc18bb1b3e36da8bd84353702">00566</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gae96c249bc18bb1b3e36da8bd84353702">dataflash_free_req</a>(<span class="keyword">struct</span> <a class="code" href="structblock__device.html" title="A block device.">block_device</a> *bdev,
<a name="l00567"></a>00567                 <span class="keyword">struct</span> <a class="code" href="structblock__request.html" title="A block device request.">block_request</a> *<a class="code" href="structdataflash__breq.html#aa3f6f994f57dfead520b5f02fe81ab4b" title="Base block request.">breq</a>)
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of(bdev);
<a name="l00570"></a>00570         <span class="keyword">struct </span><a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a> *df_breq = dataflash_breq_of(breq);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <a class="code" href="group__mempool__group.html#gacf196ba6a68124e0560662840fa8b113" title="Free an object previously allocated from a memory pool.">mem_pool_free</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4b18ef4a635ccc02d8a64c388bef40b2" title="Memory pool used to allocate memory for dataflash_breq.">req_pool</a>, df_breq);
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *dataflash_bdev_of_task(
<a name="l00576"></a>00576                 <span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578         <span class="keywordflow">return</span> <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(task, <span class="keyword">struct</span> <a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a>, task);
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00586"></a><a class="code" href="group__block__device__dataflash__internals__group.html#gab9de78c39ed5525a27832927559ece7a">00586</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__block__device__dataflash__internals__group.html#gab9de78c39ed5525a27832927559ece7a" title="Scan for AT45 DataFlash device.">dataflash_detect</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev = dataflash_bdev_of_task(task);
<a name="l00589"></a>00589         <span class="keywordtype">bool</span>                  done;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         done = <a class="code" href="group__at45__device__group.html#ga9d7636f22593ed665c57b03447ed5f61" title="Identify AT45 device.">at45_identify</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>);
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (!done) {
<a name="l00593"></a>00593                 <span class="comment">/* task will be re-sceduled on new identify event so just</span>
<a name="l00594"></a>00594 <span class="comment">                 * return.</span>
<a name="l00595"></a>00595 <span class="comment">                 */</span>
<a name="l00596"></a>00596                 <span class="keywordflow">return</span>;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (<a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__at45__device__group.html#gga399702e2c9d82f2bf11fb153464d1b09aaa3e22cc3dd8231c8e1e39f6b91e6f77" title="Valid AT45 device detected.">AT45_FLAG_VALID</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>.<a class="code" href="structat45__device.html#a11813d28167078a7bb459f332b1385a8" title="at45_device_flag">flags</a>)) {
<a name="l00600"></a>00600                 <span class="keywordflow">if</span> (!<a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__at45__device__group.html#gga399702e2c9d82f2bf11fb153464d1b09a5a2710dcafb19ca70be4a2fee13b1809" title="Device is protected from write operations.">AT45_FLAG_PROTECTED</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>.<a class="code" href="structat45__device.html#a11813d28167078a7bb459f332b1385a8" title="at45_device_flag">flags</a>))
<a name="l00601"></a>00601                         <a class="code" href="group__bitops__group.html#ga8cefd6d3ccb7c621b76b8d58ccfd196e" title="Set bit nr in bitmap.">set_bit</a>(<a class="code" href="group__block__device__group.html#gga0264ef48c2d30f1da19d75e8c760cd22a0580dbc5de137d0e65ffaaa3956eb679" title="Device can be written to.">BDEV_WRITEABLE</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#ac5a8c54588871e35f74699f925e86fa6">flags</a>);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603                 <a class="code" href="group__block__device__group.html#ga3dffa10b76b0d3379cdf054fba12b390" title="Set the block size of bdev.">blkdev_set_block_size</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>, <a class="code" href="group__block__device__dataflash__internals__group.html#gace3c7d07529675286a196500466ed36e" title="The DataFlash block device block size.">DATAFLASH_BLOCK_SIZE</a>);
<a name="l00604"></a>00604                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#a12b9f948ec1e5a15f4029ac6c9b8f2fa">nr_blocks</a> =
<a name="l00605"></a>00605                                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>.<a class="code" href="structat45__device.html#ab2a26c0fec6318a9b36d8cd003d36b5a" title="Device size.">size</a> / <a class="code" href="group__block__device__dataflash__internals__group.html#gace3c7d07529675286a196500466ed36e" title="The DataFlash block device block size.">DATAFLASH_BLOCK_SIZE</a>;
<a name="l00606"></a>00606                 <span class="keywordflow">if</span> (!<a class="code" href="group__block__device__dataflash__internals__group.html#gae12991bcaa1d47c05e9d21856f13b025" title="Store DataFlash page size into shift value.">dataflash_store_page_size</a>(df_bdev,
<a name="l00607"></a>00607                                 df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>.<a class="code" href="structat45__device.html#a64917e2f8289d33701b415a1909a446a" title="Device page size.">page_size</a>))
<a name="l00608"></a>00608                         <a class="code" href="group__debug__console.html#ga1e39d164d3d05177c7793b1311f6d093" title="Display a warning message.">dbg_warning</a>(<span class="stringliteral">&quot;DataFlash: Unsupported page size!\n&quot;</span>);
<a name="l00609"></a>00609                 <span class="keywordflow">else</span>
<a name="l00610"></a>00610                         <a class="code" href="group__bitops__group.html#ga8cefd6d3ccb7c621b76b8d58ccfd196e" title="Set bit nr in bitmap.">set_bit</a>(<a class="code" href="group__block__device__group.html#gga0264ef48c2d30f1da19d75e8c760cd22a2c79d421c9d75189ce999d812fc9b9bd" title="Device is present.">BDEV_PRESENT</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#ac5a8c54588871e35f74699f925e86fa6">flags</a>);
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#aacc639066f20e0990bde973c3be3be5c" title="Workqueue task to run on events.">event_task</a>);
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00617"></a>00617 
<a name="l00634"></a>00634 <span class="keyword">struct </span><a class="code" href="structblock__device.html" title="A block device.">block_device</a> *<a class="code" href="group__block__device__dataflash__group.html#ga0f33e9894880e6d4df49e04ca1ff7654" title="Initialize a DataFlash block device.">dataflash_blkdev_init</a>(<a class="code" href="group__spi__xmega__internal__group.html#ga59eca0ea1cb53b57e414dbadee990e1e" title="SPI Module ID">spi_id_t</a> spi_id,
<a name="l00635"></a>00635                 <span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *master, <span class="keyword">struct</span> <a class="code" href="structspi__device.html" title="Polled SPI device defintion.">spi_device</a> *device,
<a name="l00636"></a>00636                 <span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *event_task)
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638         <span class="keyword">struct </span><a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a> *df_bdev;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         df_bdev = <a class="code" href="group__malloc__group.html#ga2e0860468869abb7a295224289454827" title="Allocate size bytes of zero-initialized dynamic memory.">zalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdataflash__bdev.html" title="DataFlash specific block device.">dataflash_bdev</a>));
<a name="l00641"></a>00641         <span class="keywordflow">if</span> (!df_bdev)
<a name="l00642"></a>00642                 <span class="keywordflow">return</span> NULL;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644         <a class="code" href="group__at45__device__group.html#ga95fdc6b4c4c4290340e279ad926ea59f" title="Initialize AT45 struct.">at45_device_init</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, spi_id, master, device);
<a name="l00645"></a>00645         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#a57d45c88561d52ab921122d719b30e71">prepare_req</a> = <a class="code" href="group__block__device__dataflash__internals__group.html#gadadb4fa61053cb219150ec3fea8c6caa">dataflash_prepare_req</a>;
<a name="l00646"></a>00646         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#ac679a637d73fbe22a5ebf9cf6850cc83">alloc_req</a> = <a class="code" href="group__block__device__dataflash__internals__group.html#gaaf699af20c5179c9b49291e3c828ffe5">dataflash_alloc_req</a>;
<a name="l00647"></a>00647         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>.<a class="code" href="structblock__device.html#ada661e053e0dfa9148af3845d021fdac">free_req</a> = <a class="code" href="group__block__device__dataflash__internals__group.html#gae96c249bc18bb1b3e36da8bd84353702">dataflash_free_req</a>;
<a name="l00648"></a>00648         df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#aacc639066f20e0990bde973c3be3be5c" title="Workqueue task to run on events.">event_task</a> = event_task;
<a name="l00649"></a>00649         <a class="code" href="slist_8h.html#a430c94443e9ea2bc2dbaf3c3ab0e29db" title="Initialize a singly linked list.">slist_init</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a955a1f300d487fb4f8b570a00319797a" title="Current buffer list beeing transfered.">current_buf_list</a>);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         <a class="code" href="group__mempool__group.html#ga9cfe0b11ce6861f8b0e2d32c8bf91299" title="Initialize a memory pool using the physmem allocator.">mem_pool_init_physmem</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a4b18ef4a635ccc02d8a64c388bef40b2" title="Memory pool used to allocate memory for dataflash_breq.">req_pool</a>, &amp;<a class="code" href="physmem__pools_8c.html#a860f4167365baf7bed36944aeecf3e55" title="Internal SRAM.">cpu_sram_pool</a>,
<a name="l00652"></a>00652                         4, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdataflash__breq.html" title="DataFlash specific block device request.">dataflash_breq</a>), 2);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         <span class="comment">// Start up detection task</span>
<a name="l00655"></a>00655         <a class="code" href="group__workqueue__group.html#gac6ff4c2fe890595f39cd7d67ce8a26ed" title="Initialize a work queue task.">workqueue_task_init</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>, <a class="code" href="group__block__device__dataflash__internals__group.html#gab9de78c39ed5525a27832927559ece7a" title="Scan for AT45 DataFlash device.">dataflash_detect</a>);
<a name="l00656"></a>00656         <a class="code" href="group__at45__device__group.html#gacf61055777a5db5284b3cdc3226dbd05" title="Request exclusive access to AT45 device.">at45_request</a>(&amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a74034ef89ae5eb77d45c420b310b74f8" title="AT45 device.">at45d</a>, &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>);
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         <span class="keywordflow">return</span> &amp;df_bdev-&gt;<a class="code" href="structdataflash__bdev.html#abe131f3e5ff89057fd2a41e47111a215" title="Base block device.">bdev</a>;
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 15:18:21 2010 for display-training by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
