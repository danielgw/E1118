<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: drivers/serial/spi/spi_mega_xmega.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/serial/spi/spi_mega_xmega.c</h1><a href="spi__mega__xmega_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html" title="Run-time and build-time assertion support.">assert.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2bitops_8h.html" title="AVR-specific implementation of bit operations.">bitops.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="board_2xplain_2include_2board_2spi_8h.html" title="Board-specific SPI control.">spi.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="board_2xplain_2include_2board_2spi_8h.html" title="Board-specific SPI control.">board/spi.h</a>&gt;</span>
<a name="l00042"></a>00042 
<a name="l00066"></a>00066 <span class="preprocessor">#ifdef CONFIG_SPI_POLL_MAXLOOPS</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor"># define MAXLOOPS CONFIG_SPI_POLL_MAXLOOPS</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00069"></a><a class="code" href="group__spi__mega__xmega__internal__group.html#ga1f977147000cd8a40ccfacafea826a8e">00069</a> <span class="preprocessor"></span><span class="preprocessor"># define MAXLOOPS 255</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="preprocessor">#if MAXLOOPS &lt; 256</span>
<a name="l00079"></a><a class="code" href="group__spi__mega__xmega__internal__group.html#ga9f920dc414690900ee3ad0049cd35f3a">00079</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> <a class="code" href="group__spi__mega__xmega__internal__group.html#ga9f920dc414690900ee3ad0049cd35f3a" title="Defintion of poll loop counter variable.">maxloops_t</a>;
<a name="l00080"></a>00080 <span class="preprocessor">#else</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#ga9f920dc414690900ee3ad0049cd35f3a" title="Defintion of poll loop counter variable.">maxloops_t</a>;
<a name="l00082"></a>00082 <span class="preprocessor">#endif</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="group__spi__mega__xmega__internal__group.html#ga48167d30395fdcb898f7055fb6feadf9">00102</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#ga48167d30395fdcb898f7055fb6feadf9" title="Poll SPI registers for required actions.">spi_poll</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structdataflash__bdev.html#a5f9b0abc2800f5ebb5198607ed072a71" title="Workqueue task for underlying driver use.">task</a>)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104         <span class="keyword">struct </span><a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a> *spim_poll =
<a name="l00105"></a>00105                 <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(task, <span class="keyword">struct</span> <a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a>, <a class="code" href="structspi__master__polled.html#a113be6095e48b1789ff72b1c18d6d6b3" title="Task to use for polling the spi hardware.">poll</a>);
<a name="l00106"></a>00106         <span class="keyword">struct </span><a class="code" href="structspi__master.html" title="SPI master.">spi_master</a>        *spim = &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#af0f9e37bf21ce4531da11267a76327ed" title="Base spi_master.">base</a>;
<a name="l00107"></a>00107         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                  *read;
<a name="l00108"></a>00108         <span class="keyword">const</span> <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>            *write;
<a name="l00109"></a>00109         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                  rx_byte;
<a name="l00110"></a>00110         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                  tx_byte;
<a name="l00111"></a>00111         <a class="code" href="group__spi__mega__xmega__internal__group.html#ga9f920dc414690900ee3ad0049cd35f3a" title="Defintion of poll loop counter variable.">maxloops_t</a>               i;
<a name="l00112"></a>00112         <span class="keywordtype">size_t</span>                   <a class="code" href="structspi__master.html#aa38b5c0c0431f0697bb3fd31e6325028" title="Number of bytes remaining.">residue</a>;
<a name="l00113"></a>00113         <span class="keywordtype">bool</span>                     read_op;
<a name="l00114"></a>00114         <span class="keywordtype">bool</span>                     write_op;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">/* Make sure that a lot of the variables are located in</span>
<a name="l00117"></a>00117 <span class="comment">         * registers in the loop.</span>
<a name="l00118"></a>00118 <span class="comment">         */</span>
<a name="l00119"></a>00119         residue = spim-&gt;<a class="code" href="structspi__master.html#aa38b5c0c0431f0697bb3fd31e6325028" title="Number of bytes remaining.">residue</a>;
<a name="l00120"></a>00120         read = spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a3f5db597b042b2fe66172b7add39cbe9" title="Current read data pointer.">read_data</a>;
<a name="l00121"></a>00121         write = spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a9fe8f30521218f1f3433f70acc5e69d1" title="Current write data pointer.">write_data</a>;
<a name="l00122"></a>00122         read_op = <a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a9f00d11e7d77bfc6716923d9f10bc63f" title="Read operation.">SPI_OP_READ</a>, &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags).">op</a>);
<a name="l00123"></a>00123         write_op = <a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a3cf63a98dcb6e6b1bf5c05cbce63ae36" title="Write operation.">SPI_OP_WRITE</a>, &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags).">op</a>);
<a name="l00124"></a>00124         i = <a class="code" href="group__spi__mega__xmega__internal__group.html#ga1f977147000cd8a40ccfacafea826a8e" title="Maximum number of polling loops.">MAXLOOPS</a>;
<a name="l00125"></a>00125         tx_byte = 0;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="comment">// First loop handles receiving and sending bytes.</span>
<a name="l00128"></a>00128         <span class="keywordflow">while</span> (residue &gt; 1) {
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (write_op)
<a name="l00130"></a>00130                         tx_byte = *write;
<a name="l00131"></a>00131                 <span class="keywordflow">while</span> (i--) {
<a name="l00132"></a>00132                         <span class="keywordflow">if</span> (<a class="code" href="group__spi__mega__xmega__internal__group.html#ga2624a1514d5b2f02a38c267b4e37cd85" title="Test if SPI interrupt flag is set.">spi_priv_is_int_flag_set</a>(spim)) {
<a name="l00133"></a>00133                                 rx_byte = <a class="code" href="group__spi__mega__xmega__internal__group.html#ga5eee8a14d502b835d45e5856306bdd5c" title="SPI read data register.">spi_priv_read_data</a>(spim);
<a name="l00134"></a>00134                                 <a class="code" href="group__spi__mega__xmega__internal__group.html#ga5490cf10be42068eda48d6a78e6a21a3" title="SPI write data register.">spi_priv_write_data</a>(spim, tx_byte);
<a name="l00135"></a>00135                                 residue--;
<a name="l00136"></a>00136                                 <span class="keywordflow">if</span> (read_op)
<a name="l00137"></a>00137                                         *read++ = rx_byte;
<a name="l00138"></a>00138                                 <span class="keywordflow">if</span> (write_op)
<a name="l00139"></a>00139                                         write++;
<a name="l00140"></a>00140                                 <span class="keywordflow">break</span>;
<a name="l00141"></a>00141                         }
<a name="l00142"></a>00142                 }
<a name="l00143"></a>00143                 <span class="keywordflow">if</span> (!i)
<a name="l00144"></a>00144                         <span class="keywordflow">goto</span> yield;
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="comment">// Second loop handles receiving of last byte.</span>
<a name="l00148"></a>00148         <span class="keywordflow">while</span> (i--) {
<a name="l00149"></a>00149                 <span class="keywordflow">if</span> (<a class="code" href="group__spi__mega__xmega__internal__group.html#ga2624a1514d5b2f02a38c267b4e37cd85" title="Test if SPI interrupt flag is set.">spi_priv_is_int_flag_set</a>(spim)) {
<a name="l00150"></a>00150                         rx_byte = <a class="code" href="group__spi__mega__xmega__internal__group.html#ga5eee8a14d502b835d45e5856306bdd5c" title="SPI read data register.">spi_priv_read_data</a>(spim);
<a name="l00151"></a>00151                         <span class="keywordflow">if</span> (read_op)
<a name="l00152"></a>00152                                 *read = rx_byte;
<a name="l00153"></a>00153                         <span class="keywordflow">if</span> (<a class="code" href="group__spi__polled__internal__group.html#ga65c233ac1d0b1272a2751bfb0305977d" title="Test if polled SPI operation is using buffer list.">spi_polled_is_buffer_op</a>(spim)) {
<a name="l00154"></a>00154                                 <a class="code" href="group__spi__polled__internal__group.html#gae416351a3011d653f416bc3d280527c6" title="Schedule buffer list handling.">spi_polled_sched_next_buffer</a>(spim);
<a name="l00155"></a>00155                                 <span class="keywordflow">return</span>;
<a name="l00156"></a>00156                         }
<a name="l00157"></a>00157                         spim-&gt;<a class="code" href="structspi__master.html#aa38b5c0c0431f0697bb3fd31e6325028" title="Number of bytes remaining.">residue</a> = 0;
<a name="l00158"></a>00158                         spim-&gt;<a class="code" href="structspi__master.html#a42f99080ac3761deb56f95b35f40dd56" title="Status of last operation.">status</a> = <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00159"></a>00159                         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>,
<a name="l00160"></a>00160                                         spim-&gt;<a class="code" href="structspi__master.html#a8cc961bbd42bacad8c29a30b4ade5b10" title="Nested workqueue for pending work.">nwq</a>.<a class="code" href="structnested__workqueue.html#a020bb30664c7a6d067da03cb6f938972" title="The currently running task.">current</a>);
<a name="l00161"></a>00161                         <span class="keywordflow">return</span>;
<a name="l00162"></a>00162                 }
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 yield:
<a name="l00166"></a>00166         spim-&gt;<a class="code" href="structspi__master.html#aa38b5c0c0431f0697bb3fd31e6325028" title="Number of bytes remaining.">residue</a> = residue;
<a name="l00167"></a>00167         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a3f5db597b042b2fe66172b7add39cbe9" title="Current read data pointer.">read_data</a> = read;
<a name="l00168"></a>00168         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a9fe8f30521218f1f3433f70acc5e69d1" title="Current write data pointer.">write_data</a> = write;
<a name="l00169"></a>00169         <a class="code" href="group__spi__polled__internal__group.html#ga6895978c1e045d2fa4db5e1ca1ad5a01" title="Schedule SPI poll operation.">spi_polled_sched_poll</a>(spim);
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keywordtype">void</span> spi_priv_start(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *spim,
<a name="l00173"></a>00173                 <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> tx_byte)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175         <a class="code" href="group__spi__mega__xmega__internal__group.html#ga5490cf10be42068eda48d6a78e6a21a3" title="SPI write data register.">spi_priv_write_data</a>(spim, tx_byte);
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="keywordtype">void</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#ga0a87144e120106f3a590f7d830c85016" title="Private setup SPI device.">spi_priv_master_setup_device</a>(<a class="code" href="group__spi__xmega__internal__group.html#ga59eca0ea1cb53b57e414dbadee990e1e" title="SPI Module ID">spi_id_t</a> spi_id, <span class="keyword">struct</span> <a class="code" href="structspi__device.html" title="Polled SPI device defintion.">spi_device</a> *device,
<a name="l00179"></a>00179                 <a class="code" href="group__spi__xmega__internal__group.html#ga781db101a4c4490735eb12d3cb92fde7" title="SPI setup flags.">spi_flags_t</a> flags, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> baud_rate,
<a name="l00180"></a>00180                 <a class="code" href="board_2xplain_2include_2board_2spi_8h.html#a2b0fdae4392e5ea70eb2c238bdf1feb4" title="Board SPI select identifier type.">board_spi_select_id_t</a> sel_id)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182         <a class="code" href="group__spi__mega__xmega__internal__group.html#gad23ed6948a24a822174bc5378efecabd" title="Setup SPI device register specifics.">spi_priv_master_setup_device_regs</a>(device, flags, baud_rate);
<a name="l00183"></a>00183         <a class="code" href="board_2xplain_2include_2board_2spi_8h.html#a2b229e1e3325a63263ec32e3fa3f9059" title="Init Board SPI select.">board_spi_init_select</a>(&amp;device-&gt;<a class="code" href="structspi__device.html#a16b6d1769cd3dc398e07a1bf53bcbf25" title="Board specific select id.">sel</a>, sel_id);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="keywordtype">void</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#gad4a6a264b2a801b45318c296edd89492" title="Private select SPI device.">spi_priv_select_device</a>(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *master,
<a name="l00187"></a>00187                 <span class="keyword">struct</span> <a class="code" href="structspi__device.html" title="Polled SPI device defintion.">spi_device</a> *device)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189         <a class="code" href="group__spi__mega__xmega__internal__group.html#ga5d3c00a024539014410d58c8def9e9c7" title="Select SPI device register specifics.">spi_priv_select_device_regs</a>(master, device);
<a name="l00190"></a>00190         <a class="code" href="board_2xplain_2include_2board_2spi_8h.html#abc8737092c19e9dac1d67054f3ebab63" title="Board SPI select given device.">board_spi_select_device</a>(master, &amp;device-&gt;<a class="code" href="structspi__device.html#a16b6d1769cd3dc398e07a1bf53bcbf25" title="Board specific select id.">sel</a>);
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keywordtype">void</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#gabfe0503428169df266243cc786c8fe3f" title="Private deselect SPI device.">spi_priv_deselect_device</a>(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *master,
<a name="l00194"></a>00194                 <span class="keyword">struct</span> <a class="code" href="structspi__device.html" title="Polled SPI device defintion.">spi_device</a> *device)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         <a class="code" href="board_2xplain_2include_2board_2spi_8h.html#a6b67034ef3f505798dfd8b6c668bfb29" title="Board SPI deselect given device.">board_spi_deselect_device</a>(master, &amp;device-&gt;<a class="code" href="structspi__device.html#a16b6d1769cd3dc398e07a1bf53bcbf25" title="Board specific select id.">sel</a>);
<a name="l00197"></a>00197         <a class="code" href="group__spi__mega__xmega__internal__group.html#gacdda1f2b4f005ed5f5372fdc5c3236d5" title="Deselect SPI device register specifics.">spi_priv_deselect_device_regs</a>(master, device);
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keywordtype">void</span> <a class="code" href="group__spi__mega__xmega__internal__group.html#gaca8f508d7a0052618f5f2059e4f0e9b6" title="Private init SPI master.">spi_priv_master_init</a>(<a class="code" href="group__spi__xmega__internal__group.html#ga59eca0ea1cb53b57e414dbadee990e1e" title="SPI Module ID">spi_id_t</a> spi_id, <span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *spim)
<a name="l00201"></a>00201 {
<a name="l00202"></a>00202         <a class="code" href="group__spi__polled__internal__group.html#gabad29d924942688b2ba2f50967849982" title="Initialize polled SPI master struct.">spi_polled_master_init</a>(spim, <a class="code" href="group__spi__mega__xmega__internal__group.html#ga48167d30395fdcb898f7055fb6feadf9" title="Poll SPI registers for required actions.">spi_poll</a>, spi_priv_start);
<a name="l00203"></a>00203         <a class="code" href="group__spi__mega__xmega__internal__group.html#gae9ff02e62d576e8f8a33e5a4534b79c6" title="Init SPI master register specifics.">spi_priv_master_init_regs</a>(spi_id, spim);
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 15:18:21 2010 for display-training by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
