<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>xplain-bc: board/xplain-bc/init.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>board/xplain-bc/init.c</h1><a href="init_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="board_2xplain-bc_2include_2board_2led_8h.html" title="Board-specific LED control.">led.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="chip_2at90usb1287_2include_2chip_2gpio_8h.html" title="GPIO chip specific implementation.">gpio.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="board_8h.html" title="Xplain AT90USB1287 board-specific declarations.">board.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html" title="AVR-specific interrupt masking/unmasking.">interrupt.h</a>&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="chip_2at90usb1287_2include_2chip_2regs_8h.html" title="Register definitions for the AT90USB1287.">chip/regs.h</a>&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keywordtype">void</span> board_init(<span class="keywordtype">void</span>)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>         mcucr;
<a name="l00048"></a>00048         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a59a24f6c541d2c1b20d7c897ed7bdbca" title="Type used for holding the current interrupt state.">irqflags_t</a>      iflags;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         <span class="comment">/*</span>
<a name="l00051"></a>00051 <span class="comment">         * Make sure no interrupts can come along and interfere with the cycle</span>
<a name="l00052"></a>00052 <span class="comment">         * critical operation to write the MCUCR register.</span>
<a name="l00053"></a>00053 <span class="comment">         */</span>
<a name="l00054"></a>00054         iflags = <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#ad0c5a270013dca8848f9902ec131c51f" title="Save the current interrupt state and disable interrupts.">cpu_irq_save</a>();
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         <span class="comment">/* Disable JTAG interface to make I/O lines available. */</span>
<a name="l00057"></a>00057         mcucr = avr_read_reg8(MCUCR) | AVR_BIT(MCUCR_JTD);
<a name="l00058"></a>00058         avr_write_reg8(MCUCR, mcucr);
<a name="l00059"></a>00059         avr_write_reg8(MCUCR, mcucr);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(iflags);
<a name="l00062"></a>00062 
<a name="l00063"></a>00063         <span class="comment">/* Start up by holding the XMEGA reset line. */</span>
<a name="l00064"></a>00064         <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2ebaa07a119a608b403884f2f373270bbbcc" title="Board output line wired to XMEGA chip reset pin.">BOARD_XMEGA_RESET_ID</a>,
<a name="l00065"></a>00065                         <a class="code" href="gpio__mega_8h.html#ae9bb804807d0819629660c6e97934e37" title="Set pin as output.">GPIO_DIR_OUTPUT</a> | <a class="code" href="gpio__mega_8h.html#a9cd8f65b90ba30e34601a72723783656">GPIO_INIT_LOW</a>);
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="comment">/*</span>
<a name="l00068"></a>00068 <span class="comment">         * Initialize the RED LED deactivated and configure the USB mode switch</span>
<a name="l00069"></a>00069 <span class="comment">         * pin as an input line with pull-up enabled.</span>
<a name="l00070"></a>00070 <span class="comment">         */</span>
<a name="l00071"></a>00071         <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(BOARD_LED_RED, <a class="code" href="gpio__mega_8h.html#ae9bb804807d0819629660c6e97934e37" title="Set pin as output.">GPIO_DIR_OUTPUT</a> | <a class="code" href="gpio__mega_8h.html#a9e4e6646b825b19128db21e092c2e44a" title="Set initial pin state to high.">GPIO_INIT_HIGH</a>);
<a name="l00072"></a>00072         <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba01bfccbb950732e9091193e684f43bf0" title="Board input line wired to TPI header pin used as user input to select between different...">BOARD_USB_MODE_ID</a>, <a class="code" href="gpio__mega_8h.html#a4956087e24b3fc0ccf1f667b74cb967f" title="Set pin as input.">GPIO_DIR_INPUT</a> | <a class="code" href="gpio__mega_8h.html#aaa7921da231fd2b96575fa522e2c1970" title="Enable pull-up.">GPIO_PULL_UP</a>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074         <span class="comment">/* Finally set the SPI I/O lines for SPI master functionality. */</span>
<a name="l00075"></a>00075         <a class="code" href="init_8c.html#a94d3d5667f8d4c8ab028b1550b2051b3" title="Set SPI I/O lines given the SPI mode.">board_gpio_set_spi_master_mode</a>(<span class="keyword">true</span>);
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00085"></a><a class="code" href="board_8h.html#ad688b4da85a19396bb5de847a5a3f44a">00085</a> <span class="keywordtype">void</span> <a class="code" href="init_8c.html#ad688b4da85a19396bb5de847a5a3f44a" title="Control the reset line to the XMEGA chip.">board_gpio_mcu_reset</a>(<span class="keywordtype">bool</span> <span class="keyword">set</span>)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087         <a class="code" href="gpio__mega_8h.html#af627002b25796c26a5c485fc0e6d6a6c" title="Set gpio pin value.">gpio_set_value</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2ebaa07a119a608b403884f2f373270bbbcc" title="Board output line wired to XMEGA chip reset pin.">BOARD_XMEGA_RESET_ID</a>, !<span class="keyword">set</span>);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00096"></a><a class="code" href="board_8h.html#a746bb31d6b60e7051f2dba26cac149d9">00096</a> <span class="keywordtype">bool</span> <a class="code" href="init_8c.html#a746bb31d6b60e7051f2dba26cac149d9" title="Read input line to get if the USB MSC interface should be enabled.">board_gpio_is_usb_msc_mode</a>(<span class="keywordtype">void</span>)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098         <span class="keywordflow">return</span> !<a class="code" href="gpio__mega_8h.html#ac5725c6d88998a783092e67a19765e5d" title="Read a GPIO pin value.">gpio_get_value</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba01bfccbb950732e9091193e684f43bf0" title="Board input line wired to TPI header pin used as user input to select between different...">BOARD_USB_MODE_ID</a>);
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00107"></a><a class="code" href="board_8h.html#a94d3d5667f8d4c8ab028b1550b2051b3">00107</a> <span class="keywordtype">void</span> <a class="code" href="init_8c.html#a94d3d5667f8d4c8ab028b1550b2051b3" title="Set SPI I/O lines given the SPI mode.">board_gpio_set_spi_master_mode</a>(<span class="keywordtype">bool</span> master_mode)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109         <span class="keywordflow">if</span> (master_mode) {
<a name="l00110"></a>00110                 <span class="comment">/* Set the SPI interface in master mode. \todo revisit. */</span>
<a name="l00111"></a>00111                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba06fff9558d2e001933dc79648b5cf45c" title="SPI clock line.">BOARD_SPI_SCK_ID</a>, <a class="code" href="gpio__mega_8h.html#ae9bb804807d0819629660c6e97934e37" title="Set pin as output.">GPIO_DIR_OUTPUT</a>);
<a name="l00112"></a>00112                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2ebad01289355c202d555f9345697c886b8f" title="SPI MOSI line.">BOARD_SPI_MOSI_ID</a>, <a class="code" href="gpio__mega_8h.html#ae9bb804807d0819629660c6e97934e37" title="Set pin as output.">GPIO_DIR_OUTPUT</a>);
<a name="l00113"></a>00113                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba3364892ce9fa73f2a859626c8de3c32b" title="SPI MISO line.">BOARD_SPI_MISO_ID</a>, <a class="code" href="gpio__mega_8h.html#a4956087e24b3fc0ccf1f667b74cb967f" title="Set pin as input.">GPIO_DIR_INPUT</a>);
<a name="l00114"></a>00114         } <span class="keywordflow">else</span> {
<a name="l00115"></a>00115                 <span class="comment">/* Set the SPI interface in slave mode. \todo revisit. */</span>
<a name="l00116"></a>00116                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba06fff9558d2e001933dc79648b5cf45c" title="SPI clock line.">BOARD_SPI_SCK_ID</a>, <a class="code" href="gpio__mega_8h.html#a4956087e24b3fc0ccf1f667b74cb967f" title="Set pin as input.">GPIO_DIR_INPUT</a>);
<a name="l00117"></a>00117                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2ebad01289355c202d555f9345697c886b8f" title="SPI MOSI line.">BOARD_SPI_MOSI_ID</a>, <a class="code" href="gpio__mega_8h.html#a4956087e24b3fc0ccf1f667b74cb967f" title="Set pin as input.">GPIO_DIR_INPUT</a>);
<a name="l00118"></a>00118                 <a class="code" href="gpio__mega_8h.html#a7e4c53227697709b10e483bc98fb950f" title="Configures a GPIO pin.">port_select_gpio_pin</a>(<a class="code" href="board_8h.html#ad7351de9df176f0b385437fb3086c2eba3364892ce9fa73f2a859626c8de3c32b" title="SPI MISO line.">BOARD_SPI_MISO_ID</a>, <a class="code" href="gpio__mega_8h.html#ae9bb804807d0819629660c6e97934e37" title="Set pin as output.">GPIO_DIR_OUTPUT</a>);
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:10:34 2010 for xplain-bc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
