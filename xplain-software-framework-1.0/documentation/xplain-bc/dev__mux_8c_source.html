<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>xplain-bc: drivers/usb/core/dev_mux.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/usb/core/dev_mux.c</h1><a href="dev__mux_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html" title="Run-time and build-time assertion support.">assert.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2byteorder_8h.html" title="AVR-specific byte order definitions.">byteorder.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html" title="Debug console.">debug.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2mega_2include_2cpu_2dmapool_8h.html" title="DMA memory pool allocator: AVR Mega-specifics.">dmapool.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html" title="AVR-specific interrupt masking/unmasking.">interrupt.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="malloc_8h.html" title="Standard dynamic memory allocator.">malloc.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="status__codes_8h.html" title="Status code definitions.">status_codes.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2string_8h.html" title="Standard string operations for AVR.">string.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="util_8h.html" title="Misc utility functions and definitions.">util.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="dev_8h.html" title="USB hardware-independent device layer.">usb/dev.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="dev__mux_8h.html" title="USB device multiplexing layer.">usb/dev_mux.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="request_8h.html" title="USB request structure and associated helper functions.">usb/request.h</a>&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="udc_8h.html" title="USB Device Controller interface.">usb/udc.h</a>&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="usb_8h.html" title="Application-specific USB configuration.">app/usb.h</a>&gt;</span>
<a name="l00057"></a>00057 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00190"></a>00190 <span class="preprocessor">#ifndef USB_STRING_DEV_MANUFACTURER</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor"># define USB_STRING_DEV_MANUFACTURER    0</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor">#ifndef USB_STRING_DEV_PRODUCT</span>
<a name="l00194"></a><a class="code" href="group__usb__dev__mux.html#gafa76f709eeccc9eaf1d3ba187a418c92">00194</a> <span class="preprocessor"></span><span class="preprocessor"># define USB_STRING_DEV_PRODUCT         0</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span><span class="preprocessor">#ifndef USB_STRING_DEV_SERIAL</span>
<a name="l00197"></a><a class="code" href="group__usb__dev__mux.html#ga47ed81085d545acb4ac8ab054959a44b">00197</a> <span class="preprocessor"></span><span class="preprocessor"># define USB_STRING_DEV_SERIAL          0</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structusb__device__descriptor.html" title="Standard USB device descriptor.">usb_device_descriptor</a> udm_device_desc = {
<a name="l00203"></a>00203         .bLength                = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structusb__device__descriptor.html" title="Standard USB device descriptor.">usb_device_descriptor</a>),
<a name="l00204"></a>00204         .bDescriptorType        = USB_DT_DEVICE,
<a name="l00205"></a>00205         .bcdUSB                 = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(0x0200),
<a name="l00206"></a>00206         .bDeviceClass           = APP_USB_DEVICE_CLASS,
<a name="l00207"></a>00207         .bDeviceSubClass        = APP_USB_DEVICE_SUBCLASS,
<a name="l00208"></a>00208         .bDeviceProtocol        = APP_USB_DEVICE_PROTOCOL,
<a name="l00209"></a>00209         .bMaxPacketSize0        = APP_UDC_MAXPACKETSIZE0,
<a name="l00210"></a>00210         .idVendor               = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(APP_USB_DEVICE_VENDOR_ID),
<a name="l00211"></a>00211         .idProduct              = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(<a class="code" href="usb_8h.html#aefa62b25013c5c89e539fb93bd7c66b4">APP_USB_DEVICE_PRODUCT_ID</a>),
<a name="l00212"></a>00212         .bcdDevice              = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>((APP_USB_DEVICE_MAJOR_VERSION &lt;&lt; 8)
<a name="l00213"></a>00213                                         | APP_USB_DEVICE_MINOR_VERSION),
<a name="l00214"></a>00214         .iManufacturer          = USB_STRING_DEV_MANUFACTURER,
<a name="l00215"></a>00215         .iProduct               = <a class="code" href="group__usb__dev__mux.html#gafa76f709eeccc9eaf1d3ba187a418c92" title="String ID representing the name of the product.">USB_STRING_DEV_PRODUCT</a>,
<a name="l00216"></a>00216         .iSerialNumber          = <a class="code" href="group__usb__dev__mux.html#ga47ed81085d545acb4ac8ab054959a44b" title="String ID representing the serial number of the device.">USB_STRING_DEV_SERIAL</a>,
<a name="l00217"></a>00217         .bNumConfigurations     = APP_USB_DEVICE_NR_CONFIGS,
<a name="l00218"></a>00218 };
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="preprocessor">#ifdef CONFIG_UDC_HIGH_SPEED</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structusb__device__qualifier__descriptor.html" title="Standard USB device qualifier descriptor.">usb_device_qualifier_descriptor</a> udm_device_qual = {
<a name="l00222"></a>00222         .bLength        = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structusb__device__qualifier__descriptor.html" title="Standard USB device qualifier descriptor.">usb_device_qualifier_descriptor</a>),
<a name="l00223"></a>00223         .bDescriptorType        = USB_DT_DEVICE_QUALIFIER,
<a name="l00224"></a>00224         .bcdUSB                 = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(0x0200),
<a name="l00225"></a>00225         .bDeviceClass           = APP_USB_DEVICE_CLASS,
<a name="l00226"></a>00226         .bDeviceSubClass        = APP_USB_DEVICE_SUBCLASS,
<a name="l00227"></a>00227         .bDeviceProtocol        = APP_USB_DEVICE_PROTOCOL,
<a name="l00228"></a>00228         .bMaxPacketSize0        = APP_UDC_MAXPACKETSIZE0,
<a name="l00229"></a>00229         .bNumConfigurations     = APP_USB_DEVICE_NR_CONFIGS,
<a name="l00230"></a>00230 };
<a name="l00231"></a>00231 <span class="preprocessor">#endif</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span>
<a name="l00233"></a>00233 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structusb__configuration__descriptor.html" title="Standard USB configuration descriptor.">usb_configuration_descriptor</a> udm_config_desc_template = {
<a name="l00234"></a>00234         .bLength                = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structusb__configuration__descriptor.html" title="Standard USB configuration descriptor.">usb_configuration_descriptor</a>),
<a name="l00235"></a>00235         .bDescriptorType        = USB_DT_CONFIGURATION,
<a name="l00236"></a>00236         .bmAttributes           = <a class="code" href="group__usb__protocol__group.html#gac7063e965def0eaeb4d45a6f9048dc53" title="Must always be set.">USB_CONFIG_ATTR_MUST_SET</a>
<a name="l00237"></a>00237                                         | <a class="code" href="group__usb__protocol__group.html#gaf1b445db8c331630bbedb383544ed80b" title="Self-powered.">USB_CONFIG_ATTR_SELF_POWERED</a>,
<a name="l00238"></a>00238         .bMaxPower              = <a class="code" href="group__usb__protocol__group.html#ga55d9db758a4f408eebf4b26c6001ac9b" title="Max power in mA.">USB_CONFIG_MAX_POWER</a>(4),
<a name="l00239"></a>00239 };
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structudm__config.html" title="A USB device configuration.">udm_config</a> *<a class="code" href="structudm__config.html" title="A USB device configuration.">udm_config</a>[APP_USB_DEVICE_NR_CONFIGS];
<a name="l00242"></a>00242 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> udm_control_req;
<a name="l00243"></a>00243 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a> udm_desc_buf;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keyword">static</span> <span class="keyword">struct </span>udm_config *udm_get_config(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247         <span class="keywordflow">return</span> udm_config[<span class="keywordtype">id</span> - 1];
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="keyword">static</span> <span class="keyword">struct </span>udm_config *udm_get_current_config(<span class="keyword">struct</span> <a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252         <span class="keywordflow">if</span> (!udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a>)
<a name="l00253"></a>00253                 <span class="keywordflow">return</span> NULL;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="keywordflow">return</span> udm_get_config(udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a>);
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> udm_nr_interfaces(<span class="keyword">struct</span> udm_config *config)
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260         <span class="keywordflow">return</span> config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bNumInterfaces;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00282"></a>00282 
<a name="l00307"></a>00307 <span class="keywordtype">void</span> <a class="code" href="group__usb__dev__mux.html#ga297f1a697e4aa8f4f8d450864b670165" title="Add an interface to a configuration.">udm_config_add_interface</a>(<span class="keyword">struct</span> udm_config *config,
<a name="l00308"></a>00308                 <span class="keyword">struct</span> <a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a> *iface)
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <span class="keywordtype">id</span> = iface-&gt;<a class="code" href="structudm__interface.html#a288bd5eb2855c8bde14d65275788747a" title="The interface number identifying this interface.">iface_number</a>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(<span class="keywordtype">id</span> &lt; udm_nr_interfaces(config));
<a name="l00313"></a>00313         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(!config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[<span class="keywordtype">id</span>]);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[id] = iface;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <a class="code" href="group__debug__console.html#ga7ea40a3701ec24dfbb88fb1a74c9d8f2" title="Display an informational message.">dbg_info</a>(<span class="stringliteral">&quot;udm: config %u: new interface %u\n&quot;</span>,
<a name="l00318"></a>00318                         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bConfigurationValue, <span class="keywordtype">id</span>);
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00341"></a>00341 <span class="keyword">struct </span>udm_config *<a class="code" href="group__usb__dev__mux.html#gaa323d6f0a542bd5e611634e89d0852b8" title="Create a new USB device configuration.">udm_create_config</a>(<a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> value,
<a name="l00342"></a>00342                 <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> nr_interfaces)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344         <span class="keyword">struct </span>udm_config       *config;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(value &gt; 0 &amp;&amp; value &lt;= APP_USB_DEVICE_NR_CONFIGS);
<a name="l00347"></a>00347         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(!udm_get_config(value));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         config = <a class="code" href="group__malloc__group.html#ga2e0860468869abb7a295224289454827" title="Allocate size bytes of zero-initialized dynamic memory.">zalloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> udm_config)
<a name="l00350"></a>00350                         + nr_interfaces * <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[0]));
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (<a class="code" href="group__compiler__group.html#ga1c0c89beb84d05c5ba0bc7ce527a3925" title="The expression exp is unlikely to be true.">unlikely</a>(!config))
<a name="l00352"></a>00352                 <span class="keywordflow">return</span> NULL;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>, &amp;udm_config_desc_template, <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>));
<a name="l00355"></a>00355         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bConfigurationValue = value;
<a name="l00356"></a>00356         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bNumInterfaces = nr_interfaces;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         udm_config[value - 1] = config;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         <span class="keywordflow">return</span> config;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00369"></a>00369 <span class="keywordtype">void</span> <a class="code" href="group__usb__dev__mux.html#ga665de55fcf0adbbb1b12a8ddaa313f04" title="Set the maximum power consumption of a configuration.">udm_config_set_max_power</a>(<span class="keyword">struct</span> udm_config *config,
<a name="l00370"></a>00370                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> milliamps)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(<a class="code" href="group__usb__protocol__group.html#ga55d9db758a4f408eebf4b26c6001ac9b" title="Max power in mA.">USB_CONFIG_MAX_POWER</a>(milliamps) &lt; 256);
<a name="l00373"></a>00373         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bMaxPower = <a class="code" href="group__usb__protocol__group.html#ga55d9db758a4f408eebf4b26c6001ac9b" title="Max power in mA.">USB_CONFIG_MAX_POWER</a>(milliamps);
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00381"></a>00381 <span class="keywordtype">void</span> <a class="code" href="group__usb__dev__mux.html#ga97ed794f81c25ad0fbf4176816ec1984" title="Mark a configuration as self-powered.">udm_config_set_self_powered</a>(<span class="keyword">struct</span> udm_config *config)
<a name="l00382"></a>00382 {
<a name="l00383"></a>00383         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a59a24f6c541d2c1b20d7c897ed7bdbca" title="Type used for holding the current interrupt state.">irqflags_t</a>      iflags;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">/* Maybe we should add size-aware atomic ops...? */</span>
<a name="l00386"></a>00386         iflags = <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#ad0c5a270013dca8848f9902ec131c51f" title="Save the current interrupt state and disable interrupts.">cpu_irq_save</a>();
<a name="l00387"></a>00387         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bmAttributes |= <a class="code" href="group__usb__protocol__group.html#gaf1b445db8c331630bbedb383544ed80b" title="Self-powered.">USB_CONFIG_ATTR_SELF_POWERED</a>;
<a name="l00388"></a>00388         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(iflags);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00396"></a>00396 <span class="keywordtype">void</span> <a class="code" href="group__usb__dev__mux.html#ga4e984caec69fa2faf55aa481afd92d56" title="Mark a configuration as bus-powered.">udm_config_set_bus_powered</a>(<span class="keyword">struct</span> udm_config *config)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a59a24f6c541d2c1b20d7c897ed7bdbca" title="Type used for holding the current interrupt state.">irqflags_t</a>      iflags;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400         <span class="comment">/* Maybe we should add size-aware atomic ops...? */</span>
<a name="l00401"></a>00401         iflags = <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#ad0c5a270013dca8848f9902ec131c51f" title="Save the current interrupt state and disable interrupts.">cpu_irq_save</a>();
<a name="l00402"></a>00402         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bmAttributes &amp;= ~<a class="code" href="group__usb__protocol__group.html#gaf1b445db8c331630bbedb383544ed80b" title="Self-powered.">USB_CONFIG_ATTR_SELF_POWERED</a>;
<a name="l00403"></a>00403         <a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html#a7a4dcaf82a88398e7da6fe6099ebfc10" title="Restore saved interrupt state.">cpu_irq_restore</a>(iflags);
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="keyword">static</span> <span class="keywordtype">void</span> udm_ctrl_in_done(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: Control IN request done\n&quot;</span>);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         <a class="code" href="group__udc__group.html#gaf10c1032b3770d4168bca3279d99c53c" title="Signal that a status OUT packet is expected on the default control endpoint.">udc_ep0_expect_status</a>(udc);
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 <span class="keyword">static</span> <span class="keywordtype">void</span> udm_config_desc_sent(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417         <span class="keyword">struct </span>udm_config       *config = req-&gt;<a class="code" href="structusb__request.html#ad96153dfc05da2ba35e7a815d43504d4" title="Arbitrary data pointer associated with this request, for use by the submitter.">context</a>;
<a name="l00418"></a>00418         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            i;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         <span class="comment">/* Pop the configuration descriptor */</span>
<a name="l00421"></a>00421         <a class="code" href="slist_8h.html#ae6c469901e971d0d33a6f8560d7a3352" title="Return the first node in list and remove it.">slist_pop_head_node</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="comment">/* Ask all interfaces to remove of their own buffers */</span>
<a name="l00424"></a>00424         <span class="keywordflow">for</span> (i = 0; i &lt; udm_nr_interfaces(config); i++) {
<a name="l00425"></a>00425                 <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>    *iface;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                 <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>))
<a name="l00428"></a>00428                         <span class="keywordflow">break</span>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                 iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[i];
<a name="l00431"></a>00431                 iface-&gt;<a class="code" href="structudm__interface.html#a8b232220849ae9b291114bd647ed8475" title="Free any data allocated by get_iface_descriptor().">free_descriptor</a>(iface, req);
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         udm_ctrl_in_done(udc, req);
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 <span class="keyword">static</span> <span class="keywordtype">void</span> udm_string_desc_in_done(<span class="keyword">struct</span> udc *udc,
<a name="l00438"></a>00438                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00439"></a>00439 {
<a name="l00440"></a>00440         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>   *buf;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         buf = <a class="code" href="slist_8h.html#a731714a0d75bc68ff1ecea1e921f9e17" title="Return the first item in list and remove it.">slist_pop_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>, <span class="keyword">struct</span> <a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>, <a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00443"></a>00443         buffer_dma_free(buf, <a class="code" href="group__usb__protocol__group.html#ga27dacd4e0b04d4ef7b8aadf6ea886f3c" title="Maximum length in bytes of a USB descriptor.">USB_MAX_DESC_LEN</a>);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         udm_ctrl_in_done(udc, req);
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 
<a name="l00462"></a>00462 
<a name="l00475"></a>00475 <span class="keywordtype">int</span> <a class="code" href="group__usb__dev__mux.html#gad6724e2a44b60605562e1b9e17717fbb" title="Add a string descriptor buffer initialized from a UTF-16LE encoded string.">udm_submit_utf16le_string_desc</a>(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req,
<a name="l00476"></a>00476                 <span class="keyword">const</span> <a class="code" href="types_8h.html#a467964c91885f34b69185f7356842d70" title="Unsigned 16-bit quantity, little endian byte order.">le16_t</a> *<a class="code" href="group__utility__group.html#gad8ab729381f270b100f3d05b6c6676fc" title="Stringify a macro argument without expansion.">str</a>, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> max_len)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478         <span class="keyword">struct </span><a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>    *desc;
<a name="l00479"></a>00479         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>                   *buf;
<a name="l00480"></a>00480         <span class="keyword">const</span> <a class="code" href="types_8h.html#a467964c91885f34b69185f7356842d70" title="Unsigned 16-bit quantity, little endian byte order.">le16_t</a>                    *src;
<a name="l00481"></a>00481         <a class="code" href="types_8h.html#a467964c91885f34b69185f7356842d70" title="Unsigned 16-bit quantity, little endian byte order.">le16_t</a>                          *dst;
<a name="l00482"></a>00482         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>                        <a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <span class="keywordflow">if</span> (max_len &lt; offsetof(<span class="keyword">struct</span> <a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>, bString))
<a name="l00485"></a>00485                 <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a70aa759d292a0e4be7123d01959357da" title="Invalid argument.">ERR_INVALID_ARG</a>;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         buf = buffer_dma_alloc(<a class="code" href="group__usb__protocol__group.html#ga27dacd4e0b04d4ef7b8aadf6ea886f3c" title="Maximum length in bytes of a USB descriptor.">USB_MAX_DESC_LEN</a>);
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (!buf)
<a name="l00489"></a>00489                 <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a308199736159a4f167ad4f58db8a3830" title="Insufficient memory.">ERR_NO_MEMORY</a>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         desc = buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00492"></a>00492         desc-&gt;bDescriptorType = USB_DT_STRING;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         src = str;
<a name="l00495"></a>00495         dst = desc-&gt;bString;
<a name="l00496"></a>00496         <span class="keywordflow">for</span> (len = offsetof(<span class="keyword">struct</span> <a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>, bString);
<a name="l00497"></a>00497                         len &lt; max_len; len += 2) {
<a name="l00498"></a>00498                 <a class="code" href="types_8h.html#a467964c91885f34b69185f7356842d70" title="Unsigned 16-bit quantity, little endian byte order.">le16_t</a>  c = *src++;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500                 <span class="keywordflow">if</span> (c == <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(0))
<a name="l00501"></a>00501                         <span class="keywordflow">break</span>;
<a name="l00502"></a>00502                 *dst++ = c;
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         desc-&gt;bLength = len;
<a name="l00506"></a>00506         <a class="code" href="group__buffer__group.html#ga7d7894a1f84fcf9a2d1f2f1a6f3ed133" title="Resize the buffer pointed to by buf. The caller must make sure the new size fit into...">buffer_resize</a>(buf, len);
<a name="l00507"></a>00507         <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, buf);
<a name="l00508"></a>00508         req-&gt;<a class="code" href="structusb__request.html#a8d437c59170791ca1598e440a4d4a353" title="Function to be called when this request is completed.">req_done</a> = udm_string_desc_in_done;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="keywordflow">return</span> len;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00525"></a>00525 <span class="keywordtype">int</span> <a class="code" href="group__usb__dev__mux.html#ga0cc47e29580273c6b6431ef287bdec51" title="Add a string descriptor buffer initialized from an 8-bit ASCII encoded string.">udm_submit_ascii_string_desc</a>(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req,
<a name="l00526"></a>00526                 <span class="keyword">const</span> <span class="keywordtype">char</span> *str, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> max_len)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528         <span class="keyword">struct </span><a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>    *desc;
<a name="l00529"></a>00529         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>                   *buf;
<a name="l00530"></a>00530         <span class="keyword">const</span> <span class="keywordtype">char</span>                      *src;
<a name="l00531"></a>00531         <a class="code" href="types_8h.html#a467964c91885f34b69185f7356842d70" title="Unsigned 16-bit quantity, little endian byte order.">le16_t</a>                          *dst;
<a name="l00532"></a>00532         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>                        len;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (max_len &lt; offsetof(<span class="keyword">struct</span> <a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>, bString))
<a name="l00535"></a>00535                 <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a70aa759d292a0e4be7123d01959357da" title="Invalid argument.">ERR_INVALID_ARG</a>;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537         buf = buffer_dma_alloc(<a class="code" href="group__usb__protocol__group.html#ga27dacd4e0b04d4ef7b8aadf6ea886f3c" title="Maximum length in bytes of a USB descriptor.">USB_MAX_DESC_LEN</a>);
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (!buf)
<a name="l00539"></a>00539                 <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a308199736159a4f167ad4f58db8a3830" title="Insufficient memory.">ERR_NO_MEMORY</a>;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541         desc = buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00542"></a>00542         desc-&gt;bDescriptorType = USB_DT_STRING;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         src = str;
<a name="l00545"></a>00545         dst = desc-&gt;bString;
<a name="l00546"></a>00546         <span class="keywordflow">for</span> (len = offsetof(<span class="keyword">struct</span> <a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>, bString);
<a name="l00547"></a>00547                         len &lt; max_len; len += 2) {
<a name="l00548"></a>00548                 <span class="keywordtype">char</span>    c = *src++;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                 <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\0&#39;</span>)
<a name="l00551"></a>00551                         <span class="keywordflow">break</span>;
<a name="l00552"></a>00552                 *dst++ = <a class="code" href="group__byte__order__group.html#gaa0dabdefd84fa1180f9a332e8e34a73f" title="Convert a 16-bit word from native to little endian byte order.">cpu_to_le16</a>(c);
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         desc-&gt;bLength = len;
<a name="l00556"></a>00556         <a class="code" href="group__buffer__group.html#ga7d7894a1f84fcf9a2d1f2f1a6f3ed133" title="Resize the buffer pointed to by buf. The caller must make sure the new size fit into...">buffer_resize</a>(buf, len);
<a name="l00557"></a>00557         <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, buf);
<a name="l00558"></a>00558         req-&gt;<a class="code" href="structusb__request.html#a8d437c59170791ca1598e440a4d4a353" title="Function to be called when this request is completed.">req_done</a> = udm_string_desc_in_done;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">return</span> len;
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00586"></a>00586 <span class="preprocessor">#ifndef HAVE_APP_USB_GET_STRING_DESCRIPTOR</span>
<a name="l00587"></a><a class="code" href="group__usb__dev__mux.html#ga20b4a9a7aedc6b7c1748b2a5dc9a809d">00587</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__usb__dev__mux.html#ga20b4a9a7aedc6b7c1748b2a5dc9a809d" title="Application-specific hook for retrieving a USB String descriptor.">app_usb_get_string_descriptor</a>(<span class="keyword">struct</span> udc *udc,
<a name="l00588"></a>00588                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req, <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> index,
<a name="l00589"></a>00589                 <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> langid, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> len)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591         <span class="comment">/* String descriptors need application support */</span>
<a name="l00592"></a>00592         <span class="keywordflow">return</span> -1;
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 <span class="preprocessor">#endif</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span>
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="keyword">static</span> <span class="keywordtype">int</span> udm_prep_config_desc(<span class="keyword">struct</span> udm_config *config,
<a name="l00599"></a>00599                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req,
<a name="l00600"></a>00600                 <span class="keyword">enum</span> <a class="code" href="group__usb__protocol__group.html#ga59ba7bbb99177a622f3c073fc48b7bc5" title="USB device speed.">usb_device_speed</a> speed, <span class="keywordtype">size_t</span> max_len)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602         <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>            *iface;
<a name="l00603"></a>00603         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>                   *<a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>;
<a name="l00604"></a>00604         <span class="keywordtype">size_t</span>                          buf_len;
<a name="l00605"></a>00605         <span class="keywordtype">size_t</span>                          total_len;
<a name="l00606"></a>00606         <span class="keywordtype">size_t</span>                          len;
<a name="l00607"></a>00607         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                    i;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609         total_len = <span class="keyword">sizeof</span>(config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>);
<a name="l00610"></a>00610         len = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(max_len, total_len);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         buffer = &amp;udm_desc_buf;
<a name="l00613"></a>00613         <a class="code" href="group__buffer__group.html#ga08e06f378926444e51a796c70ab9037b" title="Initialize a buffer for transmitting data.">buffer_init_tx</a>(buffer, &amp;config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>, len);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         req-&gt;<a class="code" href="structusb__request.html#a8d437c59170791ca1598e440a4d4a353" title="Function to be called when this request is completed.">req_done</a> = udm_config_desc_sent;
<a name="l00616"></a>00616         req-&gt;<a class="code" href="structusb__request.html#ad96153dfc05da2ba35e7a815d43504d4" title="Arbitrary data pointer associated with this request, for use by the submitter.">context</a> = config;
<a name="l00617"></a>00617         <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, buffer);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keywordflow">for</span> (i = 0; i &lt; udm_nr_interfaces(config); i++) {
<a name="l00620"></a>00620                 <span class="keywordtype">size_t</span>  remaining_len;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622                 remaining_len = max_len - len;
<a name="l00623"></a>00623                 iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[i];
<a name="l00624"></a>00624                 buf_len = iface-&gt;<a class="code" href="structudm__interface.html#ae2b0c1480350800ae4f9d3ce12fa9b58" title="Get the interface descriptor.">get_iface_descriptor</a>(iface, req, speed,
<a name="l00625"></a>00625                                 remaining_len);
<a name="l00626"></a>00626                 total_len += buf_len;
<a name="l00627"></a>00627                 len += <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(buf_len, remaining_len);
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.wTotalLength = <a class="code" href="group__byte__order__group.html#gaa0dabdefd84fa1180f9a332e8e34a73f" title="Convert a 16-bit word from native to little endian byte order.">cpu_to_le16</a>(total_len);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <span class="keywordflow">return</span> len;
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="keyword">static</span> <span class="keywordtype">int</span> udm_enable_config(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> udm_config *config)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            nr_interfaces;
<a name="l00638"></a>00638         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            i;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: enabling configuration %u...\n&quot;</span>,
<a name="l00641"></a>00641                         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bConfigurationValue);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         nr_interfaces = udm_nr_interfaces(config);
<a name="l00644"></a>00644         <span class="keywordflow">for</span> (i = 0; i &lt; nr_interfaces; i++) {
<a name="l00645"></a>00645                 <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>    *iface;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647                 iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[i];
<a name="l00648"></a>00648                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;  - enabling interface %u...\n&quot;</span>, i);
<a name="l00649"></a>00649                 <span class="keywordflow">if</span> (iface-&gt;<a class="code" href="structudm__interface.html#ac5955f73bfd920b0959a5ed5cd490f69" title="Enable the interface.">enable</a>(udc, iface, 0))
<a name="l00650"></a>00650                         <span class="keywordflow">goto</span> fail;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <span class="keywordflow">return</span> 0;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 fail:
<a name="l00656"></a>00656         <a class="code" href="group__debug__console.html#ga5332230e4299334865900b442421e35b" title="Display a error message.">dbg_error</a>(<span class="stringliteral">&quot;udm: failed to enable configuration %u, interface %u\n&quot;</span>,
<a name="l00657"></a>00657                         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bConfigurationValue, i);
<a name="l00658"></a>00658         <span class="keywordflow">while</span> (i-- &gt; 0) {
<a name="l00659"></a>00659                 <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>    *iface;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661                 iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[i];
<a name="l00662"></a>00662                 iface-&gt;<a class="code" href="structudm__interface.html#a03b2e2027da9c64763becfb188d6b4c6" title="Disable the interface.">disable</a>(udc, iface);
<a name="l00663"></a>00663         }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665         <span class="keywordflow">return</span> -1;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 <span class="keyword">static</span> <span class="keywordtype">void</span> udm_disable_config(<span class="keyword">struct</span> udc *udc, <span class="keyword">struct</span> udm_config *config)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            nr_interfaces;
<a name="l00671"></a>00671         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            i;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keywordflow">if</span> (!config)
<a name="l00674"></a>00674                 <span class="keywordflow">return</span>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: disabling configuration %u\n&quot;</span>,
<a name="l00677"></a>00677                         config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bConfigurationValue);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679         nr_interfaces = udm_nr_interfaces(config);
<a name="l00680"></a>00680         <span class="keywordflow">for</span> (i = 0; i &lt; nr_interfaces; i++) {
<a name="l00681"></a>00681                 <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>    *iface;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683                 iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[i];
<a name="l00684"></a>00684                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;  - disabling interface %u...\n&quot;</span>, i);
<a name="l00685"></a>00685                 iface-&gt;<a class="code" href="structudm__interface.html#a03b2e2027da9c64763becfb188d6b4c6" title="Disable the interface.">disable</a>(udc, iface);
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="preprocessor">#if 0</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> udm_prep_string_desc(<span class="keyword">struct</span> udc *udc,
<a name="l00691"></a>00691                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req, <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> desc_index,
<a name="l00692"></a>00692                 <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> langid, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> len)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694         <span class="keyword">struct </span><a class="code" href="structusb__string__descriptor.html" title="A standard USB string descriptor.">usb_string_descriptor</a>    *desc;
<a name="l00695"></a>00695         <span class="keyword">struct </span>buffer                   *buf;
<a name="l00696"></a>00696         <span class="keyword">const</span> <span class="keywordtype">char</span>                      *str;
<a name="l00697"></a>00697         <a class="code" href="cpu_2mega_2include_2cpu_2physmem_8h.html#aaf5dda50732dd08c2496ce37ad95b0cd" title="Type representing a physical address.">phys_addr_t</a>                     desc_phys;
<a name="l00698"></a>00698         <span class="keywordtype">int</span>                             str_len;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (desc_index &gt;= USB_NR_STRINGS)
<a name="l00701"></a>00701                 <span class="keywordflow">return</span> -1;
<a name="l00702"></a>00702         <span class="keywordflow">if</span> (desc_index != USB_STRING_LANGID &amp;&amp; langid != USB_DEV_LANGID)
<a name="l00703"></a>00703                 <span class="keywordflow">return</span> -1;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         str = usb_dev_string_table[desc_index];
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (!str)
<a name="l00707"></a>00707                 <span class="keywordflow">return</span> -1;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709         desc = <a class="code" href="group__dmapool__generic__group.html#ga3aa00b0494ff313396081bddfb87bbaf" title="Allocate an object from the generic DMA pools.">dma_alloc</a>(&amp;desc_phys, USB_MAX_DESC_SIZE);
<a name="l00710"></a>00710         <span class="keywordflow">if</span> (!desc)
<a name="l00711"></a>00711                 <span class="keywordflow">return</span> -1;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         desc-&gt;bDescriptorType = USB_DT_STRING;
<a name="l00714"></a>00714         <span class="keywordflow">if</span> (desc_index == USB_STRING_LANGID) {
<a name="l00715"></a>00715                 desc-&gt;bString[0] = <a class="code" href="group__byte__order__group.html#ga54d648861a1120a3f8d6255e9cf54125" title="Create a 16-bit little endian constant.">LE16</a>(USB_DEV_LANGID);
<a name="l00716"></a>00716                 desc-&gt;bLength = 4;
<a name="l00717"></a>00717         } <span class="keywordflow">else</span> {
<a name="l00718"></a>00718                 str_len = ascii_to_usb_str(str, desc-&gt;bString,
<a name="l00719"></a>00719                                 USB_MAX_DESC_SIZE - 2);
<a name="l00720"></a>00720                 desc-&gt;bLength = str_len + 2;
<a name="l00721"></a>00721         }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         buf = &amp;udm_desc_buf;
<a name="l00724"></a>00724         <a class="code" href="group__buffer__group.html#ga717929837d4f4ba917aee09943a35263" title="Initialize an already-DMA-mapped buffer for transmitting data.">buffer_init_tx_mapped</a>(buf, desc, desc_phys, <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(desc-&gt;bLength, len));
<a name="l00725"></a>00725         <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, buf);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         req-&gt;<a class="code" href="structusb__request.html#a8d437c59170791ca1598e440a4d4a353" title="Function to be called when this request is completed.">req_done</a> = udm_string_desc_in_done;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>;
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 <span class="preprocessor">#endif</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>
<a name="l00734"></a>00734 
<a name="l00740"></a>00740 <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__usb__dev__core__group.html#ga87e8b45006847b28ba394d1daeb5331b" title="Handle a standard GET_DESCRIPTOR request.">usb_dev_get_descriptor</a>(<span class="keyword">struct</span> udc *udc, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> value,
<a name="l00741"></a>00741                 <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> index, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> len)
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743         <span class="keyword">struct </span>udm_config       *config;
<a name="l00744"></a>00744         <span class="keyword">struct </span><a class="code" href="structusb__request.html" title="A USB request.">usb_request</a>      *req;
<a name="l00745"></a>00745         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            desc_index;
<a name="l00746"></a>00746         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            desc_type;
<a name="l00747"></a>00747         <span class="keywordtype">int</span>                     buf_len = -1;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: get descriptor v%04x i%04x l%04x\n&quot;</span>,
<a name="l00750"></a>00750                         value, index, len);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752         req = &amp;udm_control_req;
<a name="l00753"></a>00753         <a class="code" href="group__usb__request__group.html#ga94fdae85da696787911c520913048a78" title="Initialize a USB request.">usb_req_init</a>(req);
<a name="l00754"></a>00754         req-&gt;<a class="code" href="structusb__request.html#a8d437c59170791ca1598e440a4d4a353" title="Function to be called when this request is completed.">req_done</a> = udm_ctrl_in_done;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         desc_type = value &gt;&gt; 8;
<a name="l00757"></a>00757         desc_index = value &amp; 0xff;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <span class="keywordflow">switch</span> (desc_type) {
<a name="l00760"></a>00760         <span class="keywordflow">case</span> USB_DT_DEVICE:
<a name="l00761"></a>00761                 buf_len = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(len, <span class="keyword">sizeof</span>(udm_device_desc));
<a name="l00762"></a>00762                 <a class="code" href="group__buffer__group.html#ga08e06f378926444e51a796c70ab9037b" title="Initialize a buffer for transmitting data.">buffer_init_tx</a>(&amp;udm_desc_buf, &amp;udm_device_desc,
<a name="l00763"></a>00763                                 buf_len);
<a name="l00764"></a>00764                 <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, &amp;udm_desc_buf);
<a name="l00765"></a>00765                 <span class="keywordflow">break</span>;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <span class="keywordflow">case</span> USB_DT_CONFIGURATION:
<a name="l00768"></a>00768                 <span class="keywordflow">if</span> (desc_index &gt;= APP_USB_DEVICE_NR_CONFIGS)
<a name="l00769"></a>00769                         <span class="keywordflow">return</span> -1;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771                 config = udm_config[desc_index];
<a name="l00772"></a>00772                 config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bDescriptorType = desc_type;
<a name="l00773"></a>00773                 buf_len = udm_prep_config_desc(config, req,
<a name="l00774"></a>00774                                 udc-&gt;<a class="code" href="structudc.html#ab62f68f5fbcecf656dacae8e6ca6825e" title="The speed that we&amp;#39;re currently operating at.">speed</a>, len);
<a name="l00775"></a>00775                 <span class="keywordflow">break</span>;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="preprocessor">#ifdef CONFIG_UDC_HIGH_SPEED</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span>        <span class="keywordflow">case</span> USB_DT_DEVICE_QUALIFIER:
<a name="l00779"></a>00779                 buf_len = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(len, <span class="keyword">sizeof</span>(udm_device_qual));
<a name="l00780"></a>00780                 <a class="code" href="group__buffer__group.html#ga08e06f378926444e51a796c70ab9037b" title="Initialize a buffer for transmitting data.">buffer_init_tx</a>(&amp;udm_desc_buf, &amp;udm_device_qual,
<a name="l00781"></a>00781                                 buf_len);
<a name="l00782"></a>00782                 <a class="code" href="group__usb__request__group.html#ga26a25fb6b9fc952dd70b838d8586c0ae" title="Add a buffer to a USB request.">usb_req_add_buffer</a>(req, &amp;udm_desc_buf);
<a name="l00783"></a>00783                 <span class="keywordflow">break</span>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <span class="keywordflow">case</span> USB_DT_OTHER_SPEED_CONFIGURATION:
<a name="l00786"></a>00786                 <span class="keywordflow">if</span> (desc_index &gt;= APP_USB_DEVICE_NR_CONFIGS)
<a name="l00787"></a>00787                         <span class="keywordflow">return</span> -1;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789                 config = udm_config[desc_index];
<a name="l00790"></a>00790                 config-&gt;<a class="code" href="structudm__config.html#a029986c579cc717b0179b08fe14d7b47" title="The configuration descriptor for this configuration.">desc</a>.bDescriptorType = desc_type;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792                 <span class="keywordflow">if</span> (udc-&gt;<a class="code" href="structudc.html#ab62f68f5fbcecf656dacae8e6ca6825e" title="The speed that we&amp;#39;re currently operating at.">speed</a> == <a class="code" href="group__usb__protocol__group.html#gga59ba7bbb99177a622f3c073fc48b7bc5a57eeede6d769b09c01ac9c9c62fef8c9" title="High speed (480 Mb/s).">USB_SPEED_HIGH</a>)
<a name="l00793"></a>00793                         buf_len = udm_prep_config_desc(config, req,
<a name="l00794"></a>00794                                         <a class="code" href="group__usb__protocol__group.html#gga59ba7bbb99177a622f3c073fc48b7bc5a0f17d0b9928086c6114fea73e08f1780" title="Full speed (12 Mb/s).">USB_SPEED_FULL</a>, len);
<a name="l00795"></a>00795                 <span class="keywordflow">else</span>
<a name="l00796"></a>00796                         buf_len = udm_prep_config_desc(config, req,
<a name="l00797"></a>00797                                         <a class="code" href="group__usb__protocol__group.html#gga59ba7bbb99177a622f3c073fc48b7bc5a57eeede6d769b09c01ac9c9c62fef8c9" title="High speed (480 Mb/s).">USB_SPEED_HIGH</a>, len);
<a name="l00798"></a>00798                 <span class="keywordflow">break</span>;
<a name="l00799"></a>00799 <span class="preprocessor">#endif</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span>
<a name="l00801"></a>00801         <span class="keywordflow">case</span> USB_DT_STRING:
<a name="l00802"></a>00802                 buf_len = <a class="code" href="group__usb__dev__mux.html#ga20b4a9a7aedc6b7c1748b2a5dc9a809d" title="Application-specific hook for retrieving a USB String descriptor.">app_usb_get_string_descriptor</a>(udc, req,
<a name="l00803"></a>00803                                 desc_index, index, len);
<a name="l00804"></a>00804                 <span class="keywordflow">break</span>;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (buf_len &lt; 0)
<a name="l00808"></a>00808                 <span class="keywordflow">return</span> buf_len;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (buf_len &lt; len)
<a name="l00811"></a>00811                 <a class="code" href="group__bitops__group.html#ga8cefd6d3ccb7c621b76b8d58ccfd196e" title="Set bit nr in bitmap.">set_bit</a>(<a class="code" href="group__usb__request__group.html#ggaabafc231ab1432357b1806dc38a9bc68a00921e5c1137831ffbf0bad769fe9039" title="Last packet must be short.">USB_REQ_SHORT_PKT</a>, &amp;req-&gt;<a class="code" href="structusb__request.html#a97740bcdd699b5c1a696f42a23a337a3" title="A bitwise combination of the bits defined by enum usb_request_flag.">flags</a>);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813         <a class="code" href="group__udc__group.html#gad02048aa3cd26a0d5ffa8e06e312fb72" title="Submit an IN request on the default control endpoint.">udc_ep0_submit_in_req</a>(udc, req);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__usb__dev__core__group.html#ga4a51a8d1b52b0c474bd108f53f34986c" title="Set the active configuration.">usb_dev_set_configuration</a>(<span class="keyword">struct</span> udc *udc, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> config_id)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820         <span class="keyword">struct </span>udm_config       *old;
<a name="l00821"></a>00821         <span class="keyword">struct </span>udm_config       *<span class="keyword">new</span>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: set configuration %u\n&quot;</span>, config_id);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         <span class="keywordflow">if</span> (config_id &gt; APP_USB_DEVICE_NR_CONFIGS)
<a name="l00826"></a>00826                 <span class="keywordflow">return</span> -1;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="comment">/* Disable the old configuration, if any */</span>
<a name="l00829"></a>00829         old = udm_get_current_config(udc);
<a name="l00830"></a>00830         udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a> = 0;
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (old)
<a name="l00832"></a>00832                 udm_disable_config(udc, old);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834         <span class="keywordflow">if</span> (config_id == 0)
<a name="l00835"></a>00835                 <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00836"></a>00836 
<a name="l00837"></a>00837         <span class="keyword">new</span> = udm_get_config(config_id);
<a name="l00838"></a>00838         udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a> = config_id;
<a name="l00839"></a>00839         <span class="keywordflow">if</span> (udm_enable_config(udc, <span class="keyword">new</span>)) {
<a name="l00840"></a>00840                 udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a> = 0;
<a name="l00841"></a>00841                 <span class="keywordflow">return</span> -1;
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844         <span class="keywordflow">return</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__usb__dev__core__group.html#ga6cbee0c91abaa976b89f3fdb9861fb52" title="Get the currently active alternate setting of an interface.">usb_dev_get_interface</a>(<span class="keyword">struct</span> udc *udc, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> index)
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849         <span class="keyword">struct </span>udm_config               *config;
<a name="l00850"></a>00850         <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>            *iface;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: get interface %u\n&quot;</span>, index);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         config = udm_get_current_config(udc);
<a name="l00855"></a>00855         <span class="keywordflow">if</span> (!config || index &gt;= udm_nr_interfaces(config))
<a name="l00856"></a>00856                 <span class="keywordflow">return</span> -1;
<a name="l00857"></a>00857 
<a name="l00858"></a>00858         iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[index];
<a name="l00859"></a>00859         <a class="code" href="group__assert__group.html#ga0fae3864357c8f0ddad905cf5c838766" title="Assert that condition is true at build time.">build_assert</a>(<span class="keyword">sizeof</span>(iface-&gt;<a class="code" href="structudm__interface.html#a5698c318660e64dd896777ae8f06449c" title="The current setting of this interface.">cur_setting</a>) == 1);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <a class="code" href="group__udc__group.html#ga2e051f7d27b72d0893fa0eeb7d8fefdb" title="Transmit IN data on the default control endpoint synchronously.">udc_ep0_write_sync</a>(udc, &amp;iface-&gt;<a class="code" href="structudm__interface.html#a5698c318660e64dd896777ae8f06449c" title="The current setting of this interface.">cur_setting</a>, 1);
<a name="l00862"></a>00862         <a class="code" href="group__udc__group.html#gaf10c1032b3770d4168bca3279d99c53c" title="Signal that a status OUT packet is expected on the default control endpoint.">udc_ep0_expect_status</a>(udc);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864         <span class="keywordflow">return</span> 0;
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__usb__dev__core__group.html#gac860eb3e674caa8c38bfed5b26a629db" title="Select an alternate setting for an interface.">usb_dev_set_interface</a>(<span class="keyword">struct</span> udc *udc, <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> index,
<a name="l00868"></a>00868                 <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> altsetting)
<a name="l00869"></a>00869 {
<a name="l00870"></a>00870         <span class="keyword">struct </span>udm_config               *config;
<a name="l00871"></a>00871         <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>            *iface;
<a name="l00872"></a>00872         <span class="keywordtype">int</span>                             ret;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: set interface %u altsetting %u\n&quot;</span>,
<a name="l00875"></a>00875                         index, altsetting);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         config = udm_get_current_config(udc);
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (!config || index &gt;= udm_nr_interfaces(config))
<a name="l00879"></a>00879                 <span class="keywordflow">return</span> -1;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[index];
<a name="l00882"></a>00882         ret = iface-&gt;<a class="code" href="structudm__interface.html#ac5955f73bfd920b0959a5ed5cd490f69" title="Enable the interface.">enable</a>(udc, iface, altsetting);
<a name="l00883"></a>00883         <span class="keywordflow">if</span> (<a class="code" href="group__compiler__group.html#gac082df2dd9a1024f6e8d16a61855d989" title="The expression exp is likely to be true.">likely</a>(!ret))
<a name="l00884"></a>00884                 iface-&gt;<a class="code" href="structudm__interface.html#a5698c318660e64dd896777ae8f06449c" title="The current setting of this interface.">cur_setting</a> = altsetting;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         <span class="keywordflow">return</span> ret;
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889 <span class="keywordtype">void</span> <a class="code" href="group__usb__dev__core__group.html#gae1d65a263ed4a92e38f325176a0e3820" title="Reset the USB device.">usb_dev_reset</a>(<span class="keyword">struct</span> udc *udc)
<a name="l00890"></a>00890 {
<a name="l00891"></a>00891         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udm: reset, speed=%u\n&quot;</span>, udc-&gt;<a class="code" href="structudc.html#ab62f68f5fbcecf656dacae8e6ca6825e" title="The speed that we&amp;#39;re currently operating at.">speed</a>);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         <span class="keywordflow">if</span> (udc-&gt;<a class="code" href="structudc.html#a700a0fda68e68c6c3c2cec20a02c92df" title="Current device configuration value.">config</a>)
<a name="l00894"></a>00894                 <a class="code" href="group__usb__dev__core__group.html#ga4a51a8d1b52b0c474bd108f53f34986c" title="Set the active configuration.">usb_dev_set_configuration</a>(udc, 0);
<a name="l00895"></a>00895 }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897 <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__usb__dev__core__group.html#gaaae4b9c7341bb875e7d11f8befcd9d54" title="Handle a class- or vendor-defined setup request.">usb_dev_process_setup_request</a>(<span class="keyword">struct</span> udc *udc,
<a name="l00898"></a>00898                 <span class="keyword">struct</span> <a class="code" href="structusb__setup__req.html" title="A USB Device SETUP request.">usb_setup_req</a> *req)
<a name="l00899"></a>00899 {
<a name="l00900"></a>00900         <span class="keyword">struct </span>udm_config               *config;
<a name="l00901"></a>00901         <span class="keyword">struct </span><a class="code" href="structudm__interface.html" title="A USB device interface.">udm_interface</a>            *iface;
<a name="l00902"></a>00902         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>                        index = <a class="code" href="group__byte__order__group.html#ga687180d38fb1df3756a55129bc2bc843" title="Convert a 16-bit word from little endian to native byte order.">le16_to_cpu</a>(req-&gt;wIndex);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         <span class="keywordflow">if</span> (<a class="code" href="group__usb__protocol__group.html#gaf91052b7d8ad4aa2541f6dd59ac7df14" title="Return the recipient of the SETUP request req.">usb_setup_recipient</a>(req) != USB_RECIP_INTERFACE) {
<a name="l00905"></a>00905                 <a class="code" href="group__debug__console.html#ga1e39d164d3d05177c7793b1311f6d093" title="Display a warning message.">dbg_warning</a>(<span class="stringliteral">&quot;udm: bad request (bmRequestType: %u)\n&quot;</span>,
<a name="l00906"></a>00906                                 req-&gt;bmRequestType);
<a name="l00907"></a>00907                 <span class="keywordflow">return</span> -1;
<a name="l00908"></a>00908         }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         config = udm_get_current_config(udc);
<a name="l00911"></a>00911         <span class="keywordflow">if</span> (!config || index &gt;= udm_nr_interfaces(config)) {
<a name="l00912"></a>00912                 <a class="code" href="group__debug__console.html#ga1e39d164d3d05177c7793b1311f6d093" title="Display a warning message.">dbg_warning</a>(<span class="stringliteral">&quot;udm: bad interface %u\n&quot;</span>, index);
<a name="l00913"></a>00913                 <span class="keywordflow">return</span> -1;
<a name="l00914"></a>00914         }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916         iface = config-&gt;<a class="code" href="structudm__config.html#a211827047caabe29fc9be426adc506c5" title="The interfaces available when this configuration is active.">interface</a>[index];
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (!iface-&gt;<a class="code" href="structudm__interface.html#a0378683b6ca0cde9fee555d02c231018" title="Handle a control request directed at an interface.">setup</a>)
<a name="l00918"></a>00918                 <span class="keywordflow">return</span> -1;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920         <span class="keywordflow">return</span> iface-&gt;<a class="code" href="structudm__interface.html#a0378683b6ca0cde9fee555d02c231018" title="Handle a control request directed at an interface.">setup</a>(udc, iface, req);
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:10:34 2010 for xplain-bc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
