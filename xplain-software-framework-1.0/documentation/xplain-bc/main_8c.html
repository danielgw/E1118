<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>xplain-bc: apps/xplain-bc/main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>apps/xplain-bc/main.c File Reference</h1>
<p>Main source file for Xplain series board controller.  
<a href="#_details">More...</a></p>
<code>#include &lt;<a class="el" href="board_2xplain-bc_2include_2board_2led_8h_source.html">led.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="chip_2at90usb1287_2include_2chip_2gpio_8h_source.html">gpio.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="board_8h_source.html">board.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="debug_8h_source.html">debug.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="cpu_2mega_2include_2cpu_2dmapool_8h_source.html">dmapool.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="mainloop_8h_source.html">mainloop.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="sys_8h_source.html">clk/sys.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="dev__mux_8h_source.html">usb/dev_mux.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="request_8h_source.html">usb/request.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="udc_8h_source.html">usb/udc.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="main_8c_source.html">xplain-bc.h</a>&quot;</code><br/>
<code>#include &lt;<a class="el" href="board_2xplain-bc_2include_2board_2spi_8h_source.html">spi.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="workqueue_8h_source.html">workqueue.h</a>&gt;</code><br/>

<p><a href="main_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#afb6000fb4c463d1f8df987a62eedb8dd">app_usb_mode_worker</a> (struct <a class="el" href="structworkqueue__task.html">workqueue_task</a> *task)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check USB mode switch input line and enable or disable the USB interface.  <a href="#afb6000fb4c463d1f8df987a62eedb8dd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#aafed65d02491f0b6e59f0e03332d26f7">app_dataflash_ready</a> (struct <a class="el" href="structworkqueue__task.html">workqueue_task</a> *task)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set SPI lines as input (slave mode) and release XMEGA reset line.  <a href="#aafed65d02491f0b6e59f0e03332d26f7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Xplain board controller application.  <a href="#a840291bc02cba5474a4cb46a9b9566fe"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Main source file for Xplain series board controller. </p>
<p>Copyright (C) 2009 - 2010 Atmel Corporation. All rights reserved. </p>

<p>Definition in file <a class="el" href="main_8c_source.html">main.c</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aafed65d02491f0b6e59f0e03332d26f7"></a><!-- doxytag: member="main.c::app_dataflash_ready" ref="aafed65d02491f0b6e59f0e03332d26f7" args="(struct workqueue_task *task)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void app_dataflash_ready </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structworkqueue__task.html">workqueue_task</a> *&nbsp;</td>
          <td class="paramname"> <em>task</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Set SPI lines as input (slave mode) and release XMEGA reset line. </p>
<p>This worker function will set the SPI lines in input mode (slave mode) and release the XMEGA reset line. Further it will switch to the main worker function <a class="el" href="main_8c.html#afb6000fb4c463d1f8df987a62eedb8dd">app_usb_mode_worker</a> and add that worker function to the queue. </p>

<p>Definition at line <a class="el" href="main_8c_source.html#l00130">130</a> of file <a class="el" href="main_8c_source.html">main.c</a>.</p>

<p>References <a class="el" href="main_8c_source.html#l00073">app_usb_mode_worker()</a>, <a class="el" href="init_8c_source.html#l00085">board_gpio_mcu_reset()</a>, <a class="el" href="init_8c_source.html#l00107">board_gpio_set_spi_master_mode()</a>, <a class="el" href="workqueue_8c_source.html#l00047">main_workqueue</a>, <a class="el" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41">workqueue_add_task()</a>, and <a class="el" href="workqueue_8h_source.html#l00127">workqueue_task_set_work_func()</a>.</p>

<p>Referenced by <a class="el" href="main_8c_source.html#l00148">main()</a>.</p>

</div>
</div>
<a class="anchor" id="afb6000fb4c463d1f8df987a62eedb8dd"></a><!-- doxytag: member="main.c::app_usb_mode_worker" ref="afb6000fb4c463d1f8df987a62eedb8dd" args="(struct workqueue_task *task)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void app_usb_mode_worker </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structworkqueue__task.html">workqueue_task</a> *&nbsp;</td>
          <td class="paramname"> <em>task</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check USB mode switch input line and enable or disable the USB interface. </p>
<p>This function will read the USB mode switch input line and disable or enable the USB interface as needed. If MSC is enabled and input line is high, MSC will be disabled and SPI lines set as input (slave mode). In addition the red LED will be deactivated to indicate MSC is no longer available. Finally the XMEGA chip is released from reset.</p>
<p>When MSC is not enabled and the USB mode switch line is low the worker function will set the SPI lines in output mode (master mode) and enable the USB interface. In addition the red LED will be actived to indicate MSC is available. Finally the XMEGA chip is held in reset to get synchronized access to the flash memory. </p>

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>Rewrite to use GPIO level change interrupt to trigger USB mode switching task. </dd></dl>
</p>

<p>Definition at line <a class="el" href="main_8c_source.html#l00073">73</a> of file <a class="el" href="main_8c_source.html">main.c</a>.</p>

<p>References <a class="el" href="init_8c_source.html#l00096">board_gpio_is_usb_msc_mode()</a>, <a class="el" href="init_8c_source.html#l00085">board_gpio_mcu_reset()</a>, <a class="el" href="init_8c_source.html#l00107">board_gpio_set_spi_master_mode()</a>, <a class="el" href="workqueue_8c_source.html#l00047">main_workqueue</a>, <a class="el" href="status__codes_8h_source.html#l00076">OPERATION_IN_PROGRESS</a>, <a class="el" href="group__udc__group.html#gaf04e5a797dcee2ea5f0d436d65bffb82">udc_attach()</a>, <a class="el" href="group__udc__group.html#ga2fb2c7968f76bdf322f434682aa3343f">udc_detach()</a>, and <a class="el" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41">workqueue_add_task()</a>.</p>

<p>Referenced by <a class="el" href="main_8c_source.html#l00130">app_dataflash_ready()</a>, and <a class="el" href="main_8c_source.html#l00148">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a840291bc02cba5474a4cb46a9b9566fe"></a><!-- doxytag: member="main.c::main" ref="a840291bc02cba5474a4cb46a9b9566fe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Xplain board controller application. </p>
<p>This application will enable or disable the USB mass-storage class (MSC) interface given an input on the USB mode switch input line. The main microcontroller on the Xplain board is held in reset while the board controller has the MSC interface enabled to ensure synchronouse access. </p>

<p>Definition at line <a class="el" href="main_8c_source.html#l00148">148</a> of file <a class="el" href="main_8c_source.html">main.c</a>.</p>

<p>References <a class="el" href="main_8c_source.html#l00130">app_dataflash_ready()</a>, <a class="el" href="main_8c_source.html#l00073">app_usb_mode_worker()</a>, <a class="el" href="init_8c_source.html#l00096">board_gpio_is_usb_msc_mode()</a>, <a class="el" href="buffer_8c_source.html#l00129">buffer_pool_init()</a>, <a class="el" href="compiler-gcc_8h_source.html#l00042">cpu_irq_enable</a>, <a class="el" href="apps_2xplain-bc_2dataflash_8c_source.html#l00051">dataflash_init()</a>, <a class="el" href="debug_8h_source.html#l00238">dbg_info</a>, <a class="el" href="debug_8h_source.html#l00220">dbg_panic</a>, <a class="el" href="workqueue_8c_source.html#l00047">main_workqueue</a>, <a class="el" href="mainloop_8h_source.html#l00063">mainloop_run()</a>, <a class="el" href="sysclk_8h_source.html#l00118">sysclk_init()</a>, <a class="el" href="at90usb__core_8c_source.html#l00426">udc_init()</a>, <a class="el" href="request_8c_source.html#l00099">usb_init()</a>, <a class="el" href="workqueue_8h_source.html#l00109">workqueue_init()</a>, <a class="el" href="workqueue_8h_source.html#l00144">workqueue_task_init()</a>, and <a class="el" href="workqueue_8h_source.html#l00127">workqueue_task_set_work_func()</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:10:34 2010 for xplain-bc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
