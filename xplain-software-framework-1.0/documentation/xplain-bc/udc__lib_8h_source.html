<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>xplain-bc: include/usb/udc_lib.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>include/usb/udc_lib.h</h1><a href="udc__lib_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00034"></a>00034 <span class="preprocessor">#ifndef USB_UDC_LIB_H_INCLUDED</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#define USB_UDC_LIB_H_INCLUDED</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="slist_8h.html" title="Singly linked list implementation.">slist.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2string_8h.html" title="Standard string operations for AVR.">string.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="Type definitions used throughout the library.">types.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="request_8h.html" title="USB request structure and associated helper functions.">usb/request.h</a>&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">struct </span><a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>;
<a name="l00043"></a>00043 <span class="keyword">struct </span><a class="code" href="structusb__setup__req.html" title="A USB Device SETUP request.">usb_setup_req</a>;
<a name="l00044"></a>00044 
<a name="l00058"></a>00058 
<a name="l00072"></a>00072 <span class="keyword">extern</span> <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__udc__group.html#ga945f4e427b8ec40a3b8ef6f119abf2bb" title="Enter Test Mode.">udc_enter_test_mode</a>(<span class="keyword">struct</span> <a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mode);
<a name="l00073"></a>00073 
<a name="l00087"></a>00087 <span class="keyword">extern</span> <a class="code" href="types_8h.html#a933a3d656c26da40d944fa70ea43a72e" title="Status return value.">status_t</a> <a class="code" href="group__udc__group.html#ga47e1324a894e87760dc7571aca5c5d97" title="Handle a USB SETUP request.">udc_lib_process_setup_request</a>(<span class="keyword">struct</span> <a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>,
<a name="l00088"></a>00088                 <span class="keyword">struct</span> <a class="code" href="structusb__setup__req.html" title="A USB Device SETUP request.">usb_setup_req</a> *req);
<a name="l00089"></a>00089 
<a name="l00091"></a>00091 
<a name="l00103"></a>00103 
<a name="l00107"></a><a class="code" href="structudc__fifo.html">00107</a> <span class="keyword">struct </span><a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> {
<a name="l00108"></a><a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0">00108</a>         <span class="keywordtype">size_t</span>          <a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a>;     
<a name="l00109"></a><a class="code" href="structudc__fifo.html#a0245e24506b003ed0df7147b8e3fc7d7">00109</a>         <span class="keywordtype">size_t</span>          <a class="code" href="structudc__fifo.html#a0245e24506b003ed0df7147b8e3fc7d7" title="Size of the FIFO aperture.">size</a>;           
<a name="l00110"></a>00110 
<a name="l00116"></a><a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83">00116</a>         <span class="keywordtype">bool</span>            <a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83" title="True if a Zero-Length Packet is to be sent by the UDC driver at the next opportunity...">send_zlp</a>;
<a name="l00117"></a>00117 };
<a name="l00118"></a>00118 
<a name="l00125"></a><a class="code" href="group__udc__group.html#gab91e80428caf302bcfacfbca28d336f4">00125</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__udc__group.html#gab91e80428caf302bcfacfbca28d336f4" title="Initialize the internal state of the FIFO.">udc_fifo_init</a>(<span class="keyword">struct</span> <a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> *fifo, <span class="keywordtype">size_t</span> aperture_size)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127         fifo-&gt;<a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a> = 0;
<a name="l00128"></a>00128         fifo-&gt;<a class="code" href="structudc__fifo.html#a0245e24506b003ed0df7147b8e3fc7d7" title="Size of the FIFO aperture.">size</a> = aperture_size;
<a name="l00129"></a>00129         fifo-&gt;<a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83" title="True if a Zero-Length Packet is to be sent by the UDC driver at the next opportunity...">send_zlp</a> = <span class="keyword">false</span>;
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00143"></a><a class="code" href="group__udc__group.html#gaef744d41d8db003ac56743f20612ebe3">00143</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group__udc__group.html#gaef744d41d8db003ac56743f20612ebe3" title="Return true if the UDC driver is to send a Zero-Length Packet once the controller...">udc_fifo_zlp_is_pending</a>(<span class="keyword">struct</span> <a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> *fifo,
<a name="l00144"></a>00144                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146         <span class="keywordflow">return</span> fifo-&gt;<a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83" title="True if a Zero-Length Packet is to be sent by the UDC driver at the next opportunity...">send_zlp</a>;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00156"></a><a class="code" href="group__udc__group.html#ga3b4139a11478b3e959096efd0c735947">00156</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__udc__group.html#ga3b4139a11478b3e959096efd0c735947" title="Notify the FIFO accessors that a ZLP has been queued, so it is not pending anymore...">udc_fifo_zlp_clear_pending</a>(<span class="keyword">struct</span> <a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> *fifo,
<a name="l00157"></a>00157                 <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159         fifo-&gt;<a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83" title="True if a Zero-Length Packet is to be sent by the UDC driver at the next opportunity...">send_zlp</a> = <span class="keyword">false</span>;
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00183"></a><a class="code" href="group__udc__group.html#gac300be830500073ae3cf0ff981de721f">00183</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__udc__group.html#gac300be830500073ae3cf0ff981de721f" title="Copy data from one or more buffers into the FIFO.">udc_fifo_write_data</a>(<span class="keywordtype">void</span> *dest, <span class="keyword">struct</span> <a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> *fifo,
<a name="l00184"></a>00184                 <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *done_list, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>   *buf;
<a name="l00187"></a>00187         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    bytes_written;
<a name="l00188"></a>00188         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    buf_offset;
<a name="l00189"></a>00189         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    fifo_size;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         buf = <a class="code" href="group__buffer__group.html#ga204cf3ab1d8dc73993f3d68c08743bee" title="Return the first buffer in list and remove it.">buf_list_pop_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>);
<a name="l00192"></a>00192         buf_offset = fifo-&gt;<a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a>;
<a name="l00193"></a>00193         fifo_size = fifo-&gt;<a class="code" href="structudc__fifo.html#a0245e24506b003ed0df7147b8e3fc7d7" title="Size of the FIFO aperture.">size</a>;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="keywordflow">for</span> (bytes_written = 0; bytes_written &lt; fifo_size; ) {
<a name="l00196"></a>00196                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    nbytes;
<a name="l00197"></a>00197                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    buf_len;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 buf_len = buf-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>;
<a name="l00200"></a>00200                 nbytes = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(fifo_size - bytes_written, buf_len - buf_offset);
<a name="l00201"></a>00201                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udc write: dst %p src %p off %u nbytes %u\n&quot;</span>,
<a name="l00202"></a>00202                                 (<span class="keywordtype">char</span> *)dest + bytes_written,
<a name="l00203"></a>00203                                 buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>, buf_offset, nbytes);
<a name="l00204"></a>00204                 <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>((<span class="keywordtype">char</span> *)dest + bytes_written,
<a name="l00205"></a>00205                                 (<span class="keyword">const</span> <span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a> + buf_offset,
<a name="l00206"></a>00206                                 nbytes);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208                 buf_offset += nbytes;
<a name="l00209"></a>00209                 bytes_written += nbytes;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211                 <span class="keywordflow">if</span> (buf_offset == buf_len) {
<a name="l00212"></a>00212                         buf_offset = 0;
<a name="l00213"></a>00213                         <a class="code" href="slist_8h.html#acd0f70535b445ece86170eb70bd54365" title="Insert node as the last node in list.">slist_insert_tail</a>(done_list, &amp;buf-&gt;<a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00214"></a>00214                         <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>)) {
<a name="l00215"></a>00215                                 <span class="keywordflow">if</span> (bytes_written == fifo_size
<a name="l00216"></a>00216                                                 &amp;&amp; <a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__usb__request__group.html#ggaabafc231ab1432357b1806dc38a9bc68a00921e5c1137831ffbf0bad769fe9039" title="Last packet must be short.">USB_REQ_SHORT_PKT</a>,
<a name="l00217"></a>00217                                                         &amp;req-&gt;<a class="code" href="structusb__request.html#a97740bcdd699b5c1a696f42a23a337a3" title="A bitwise combination of the bits defined by enum usb_request_flag.">flags</a>))
<a name="l00218"></a>00218                                         fifo-&gt;<a class="code" href="structudc__fifo.html#acf0fd60fb988aa7c4162250af34aea83" title="True if a Zero-Length Packet is to be sent by the UDC driver at the next opportunity...">send_zlp</a> = <span class="keyword">true</span>;
<a name="l00219"></a>00219                                 <span class="keywordflow">goto</span> done;
<a name="l00220"></a>00220                         }
<a name="l00221"></a>00221                         buf = <a class="code" href="group__buffer__group.html#ga204cf3ab1d8dc73993f3d68c08743bee" title="Return the first buffer in list and remove it.">buf_list_pop_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>);
<a name="l00222"></a>00222                 }
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225         <span class="comment">/* Put the last unfinished buffer back on the queue */</span>
<a name="l00226"></a>00226         <a class="code" href="slist_8h.html#a283d1c311589668ab29935f3729ff561" title="Insert node as the first node in list.">slist_insert_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>, &amp;buf-&gt;<a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 done:
<a name="l00229"></a>00229         fifo-&gt;<a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a> = buf_offset;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">return</span> bytes_written;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00257"></a><a class="code" href="group__udc__group.html#ga5c876e3c1048711e448bbe1d4bfa12d6">00257</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="group__udc__group.html#ga5c876e3c1048711e448bbe1d4bfa12d6" title="Copy data from the FIFO into one or more buffers.">udc_fifo_read_data</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src,
<a name="l00258"></a>00258                 <span class="keyword">struct</span> <a class="code" href="structudc__fifo.html" title="Internal state variables used by the FIFO accessors.">udc_fifo</a> *fifo, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fifo_nbytes,
<a name="l00259"></a>00259                 <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *done_bufs, <span class="keyword">struct</span> <a class="code" href="structusb__request.html" title="A USB request.">usb_request</a> *req)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>   *buf;
<a name="l00262"></a>00262         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    bytes_read;
<a name="l00263"></a>00263         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    buf_offset;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(fifo_nbytes &lt;= fifo-&gt;size);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         buf = <a class="code" href="group__buffer__group.html#ga204cf3ab1d8dc73993f3d68c08743bee" title="Return the first buffer in list and remove it.">buf_list_pop_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>);
<a name="l00268"></a>00268         buf_offset = fifo-&gt;<a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a>;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="keywordflow">for</span> (bytes_read = 0; bytes_read &lt; fifo_nbytes; ) {
<a name="l00271"></a>00271                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    nbytes;
<a name="l00272"></a>00272                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    buf_len;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274                 buf_len = buf-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>;
<a name="l00275"></a>00275                 nbytes = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(fifo_nbytes - bytes_read, buf_len - buf_offset);
<a name="l00276"></a>00276                 <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;udc read: dst %p src %p off %u nbytes %u\n&quot;</span>,
<a name="l00277"></a>00277                                 buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)src + bytes_read,
<a name="l00278"></a>00278                                 buf_offset, nbytes);
<a name="l00279"></a>00279                 <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>((<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a> + buf_offset,
<a name="l00280"></a>00280                                 (<span class="keyword">const</span> <span class="keywordtype">char</span> *)src + bytes_read, nbytes);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282                 buf_offset += nbytes;
<a name="l00283"></a>00283                 bytes_read += nbytes;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285                 <span class="keywordflow">if</span> (buf_offset == buf_len) {
<a name="l00286"></a>00286                         buf_offset = 0;
<a name="l00287"></a>00287                         <a class="code" href="slist_8h.html#acd0f70535b445ece86170eb70bd54365" title="Insert node as the last node in list.">slist_insert_tail</a>(done_bufs, &amp;buf-&gt;<a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00288"></a>00288                         <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>))
<a name="l00289"></a>00289                                 <span class="keywordflow">goto</span> done;
<a name="l00290"></a>00290                         buf = <a class="code" href="group__buffer__group.html#ga204cf3ab1d8dc73993f3d68c08743bee" title="Return the first buffer in list and remove it.">buf_list_pop_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>);
<a name="l00291"></a>00291                 }
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="comment">/* Put the last unfinished buffer back on the queue */</span>
<a name="l00295"></a>00295         <a class="code" href="slist_8h.html#a283d1c311589668ab29935f3729ff561" title="Insert node as the first node in list.">slist_insert_head</a>(&amp;req-&gt;<a class="code" href="structusb__request.html#ad8d283292cbc9e9706fd85f218accf2c" title="List of buffers associated with this request.">buf_list</a>, &amp;buf-&gt;<a class="code" href="structbuffer.html#acbbd1843f34b7bf1d832b9a2a7215305">node</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 done:
<a name="l00298"></a>00298         fifo-&gt;<a class="code" href="structudc__fifo.html#ab865d3bf883766b15131171ad74737f0" title="Offset into the head buffer.">buf_offset</a> = buf_offset;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">return</span> bytes_read;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 <span class="preprocessor">#endif </span><span class="comment">/* USB_UDC_LIB_H_INCLUDED */</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:10:34 2010 for xplain-bc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
