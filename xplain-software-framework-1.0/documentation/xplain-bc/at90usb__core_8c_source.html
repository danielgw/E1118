<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>xplain-bc: drivers/usb/at90usb/at90usb_core.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>drivers/usb/at90usb/at90usb_core.c</h1><a href="at90usb__core_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html" title="Run-time and build-time assertion support.">assert.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html" title="Debug console.">debug.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2intc_8h.html" title="AVR-specific internal interrupt handling.">intc.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2mega_2include_2cpu_2physmem_8h.html" title="AVR Mega-specific physical memory definitions.">physmem.h</a>&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;stdbool.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2interrupt_8h.html" title="AVR-specific interrupt masking/unmasking.">interrupt.h</a>&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html" title="System clock management.">clk/sys.h</a>&gt;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="clk_8h.html" title="AT90USB1287 clock control.">chip/clk.h</a>&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;<a class="code" href="chip_2at90usb1287_2include_2chip_2regs_8h.html" title="Register definitions for the AT90USB1287.">chip/regs.h</a>&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;<a class="code" href="at90usb_8h.html" title="USB chip specific capabilities.">chip/at90usb.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;<a class="code" href="irq-map_8h.html" title="INTC chip specific interrupt vector IDs.">chip/irq-map.h</a>&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;<a class="code" href="cpu_2mega_2include_2cpu_2io_8h.html" title="ATmega I/O read/write functions.">cpu/io.h</a>&gt;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;<a class="code" href="udc_8h.html" title="USB Device Controller interface.">usb/udc.h</a>&gt;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;<a class="code" href="usb_8h.html" title="Application-specific USB configuration.">app/usb.h</a>&gt;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="at90usb__internal_8h.html" title="AT90USB driver: Internal functions and definitions.">at90usb_internal.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="at90usb__regs_8h.html" title="AT90USB USB register definitions.">at90usb_regs.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">/* Configuration sanity-checks. */</span>
<a name="l00074"></a>00074 <span class="preprocessor">#if defined(CONFIG_UDC) &amp;&amp; !defined(CHIP_AT90USB_HAS_DEVICE)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor"># error AT90USB: This chip does not have a Device Controller</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#if defined(CONFIG_AT90USB_OTG) &amp;&amp; !defined(CHIP_AT90USB_HAS_OTG)</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor"># error AT90USB: This chip does not support USB On-The-Go</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00089"></a>00089 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00090"></a><a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c">00090</a> <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a> *<a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *<a class="code" href="structat90usb__udc.html#a524890f05a123ec6caacc875b3045fdf" title="Pointer to the USB controller.">at90usb</a>)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092 <span class="preprocessor">#ifdef CONFIG_UDC</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>        <span class="keywordflow">return</span> at90usb-&gt;udc;
<a name="l00094"></a>00094 <span class="preprocessor">#else</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>        <span class="keywordflow">return</span> NULL;
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>}
<a name="l00098"></a>00098 
<a name="l00107"></a>00107 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00108"></a><a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4">00108</a> <span class="keyword">struct </span><a class="code" href="structat90usb__host.html">at90usb_host</a> *<a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *at90usb)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110         <span class="keywordflow">return</span> NULL;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00121"></a><a class="code" href="at90usb__core_8c.html#a3d4b0f6af272b4207289df925d55a70c">00121</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="at90usb__core_8c.html#a3d4b0f6af272b4207289df925d55a70c" title="Get the AT90USB OTG struct if USB OTG mode is enabled.">at90usb_is_otg</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *at90usb)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123 <span class="preprocessor">#ifdef CONFIG_AT90USB_OTG</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00125"></a>00125 <span class="preprocessor">#else</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00127"></a>00127 <span class="preprocessor">#endif</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>}
<a name="l00129"></a>00129 
<a name="l00139"></a><a class="code" href="at90usb__core_8c.html#a2e88374f477fa839b220272a15430958">00139</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#a2e88374f477fa839b220272a15430958" title="Check VBUS and notify the UDC about the status.">at90usb_check_vbus</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *at90usb)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141         <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a> *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> = <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="keywordflow">if</span> (avr_read_reg8(USBSTA) &amp; <a class="code" href="at90usb__regs_8h.html#aa127782c7a7d68a6120c1f3122e10586" title="VBus flag.">AT90USB_USBSTA_VBUS</a>)
<a name="l00144"></a>00144                 <a class="code" href="group__udc__group.html#gabf8d919c60a8135a89d37e3036cfb459" title="Signal that a high Vbus level has been detected.">at90usb_udc_vbus_on</a>(udc);
<a name="l00145"></a>00145         <span class="keywordflow">else</span>
<a name="l00146"></a>00146                 <a class="code" href="group__udc__group.html#ga59d6920f3d1da0b8c3f5eeecac367589" title="Signal that a low Vbus level has been detected.">at90usb_udc_vbus_off</a>(udc);
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00158"></a><a class="code" href="at90usb__core_8c.html#a432d9252a87825ebd2bcd21966a38b5c">00158</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#a432d9252a87825ebd2bcd21966a38b5c" title="Enter USB device mode.">at90usb_enter_device_mode</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *<a class="code" href="structat90usb__udc.html#a524890f05a123ec6caacc875b3045fdf" title="Pointer to the USB controller.">at90usb</a>)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160         <span class="keyword">struct </span><a class="code" href="structat90usb__host.html">at90usb_host</a>     *host = <a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb);
<a name="l00161"></a>00161         <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a>      *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> = <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;AT90USB: Entering device mode...\n&quot;</span>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a62727ae025bb7d732ef60d18fe6c4e7b" title="Check if the AT90USB host controller is enabled.">at90usb_host_is_enabled</a>(host))
<a name="l00166"></a>00166                 at90usb_host_disable(host);
<a name="l00167"></a>00167         <span class="keywordflow">if</span> (!<a class="code" href="at90usb__internal_8h.html#a05f9b6cf4d21b918905185c3a0c72243" title="Check if the AT90USB UDC controller is enabled.">at90usb_udc_is_enabled</a>(udc))
<a name="l00168"></a>00168                 <a class="code" href="at90usb__internal_8h.html#a6e0c10c084530c8400097899000e36b1" title="Enable the AT90USB UDC controller.">at90usb_udc_enable</a>(udc);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         avr_write_reg8(USBINT, avr_read_reg8(USBINT) &amp; ~<a class="code" href="at90usb__regs_8h.html#a1b4e1bf5901b965d2be4d0bde80f00b6" title="IVBUS transition interrupt flag.">AT90USB_USBINT_VBUSTI</a>);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <a class="code" href="at90usb__core_8c.html#a2e88374f477fa839b220272a15430958" title="Check VBUS and notify the UDC about the status.">at90usb_check_vbus</a>(at90usb);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         avr_write_reg8(USBCON, avr_read_reg8(USBCON) | <a class="code" href="at90usb__regs_8h.html#a07db79087dcf811ec81bd74ee6b729ef" title="VBUS transition interrupt enable.">AT90USB_USBCON_VBUSTE</a>);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <a class="code" href="group__debug__console.html#ga92394a5c4bbfe2864b7ea1cb488cd3dd" title="Display a verbose debugging message.">dbg_verbose</a>(<span class="stringliteral">&quot;AT90USB: USBCON=%02x\n&quot;</span>, avr_read_reg8(USBCON));
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00187"></a><a class="code" href="at90usb__core_8c.html#a3748e6c8f97f3ab0cdc3478d3505ff6b">00187</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#a3748e6c8f97f3ab0cdc3478d3505ff6b" title="Enter USB host mode.">at90usb_enter_host_mode</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *<a class="code" href="structat90usb__udc.html#a524890f05a123ec6caacc875b3045fdf" title="Pointer to the USB controller.">at90usb</a>)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189         <span class="keyword">struct </span><a class="code" href="structat90usb__host.html">at90usb_host</a>     *host = <a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb);
<a name="l00190"></a>00190         <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a>      *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> = <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb);
<a name="l00191"></a>00191 
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (host) {
<a name="l00193"></a>00193                 <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a05f9b6cf4d21b918905185c3a0c72243" title="Check if the AT90USB UDC controller is enabled.">at90usb_udc_is_enabled</a>(udc))
<a name="l00194"></a>00194                         <a class="code" href="at90usb__internal_8h.html#a529169ef5b14c266284c1c110fea5e0e" title="Disable the AT90USB UDC controller.">at90usb_udc_disable</a>(udc);
<a name="l00195"></a>00195                 <span class="keywordflow">if</span> (!<a class="code" href="at90usb__internal_8h.html#a62727ae025bb7d732ef60d18fe6c4e7b" title="Check if the AT90USB host controller is enabled.">at90usb_host_is_enabled</a>(host))
<a name="l00196"></a>00196                         at90usb_host_enable(host);
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00209"></a><a class="code" href="at90usb__core_8c.html#ab7ab7327b8289521a0e6b5c831d90da5">00209</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#ab7ab7327b8289521a0e6b5c831d90da5" title="Check the state of the USB OTG ID pin.">at90usb_check_id</a>(<span class="keyword">struct</span> <a class="code" href="structat90usb__controller.html">at90usb_controller</a> *<a class="code" href="structat90usb__udc.html#a524890f05a123ec6caacc875b3045fdf" title="Pointer to the USB controller.">at90usb</a>)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211         <span class="keywordflow">if</span> (avr_read_reg8(USBSTA) &amp; <a class="code" href="at90usb__regs_8h.html#ae9d2003bbdf147adca360e0d18558cd7" title="IUD pin flag.">AT90USB_USBSTA_ID</a>)
<a name="l00212"></a>00212                 <a class="code" href="at90usb__core_8c.html#a432d9252a87825ebd2bcd21966a38b5c" title="Enter USB device mode.">at90usb_enter_device_mode</a>(at90usb);
<a name="l00213"></a>00213         <span class="keywordflow">else</span>
<a name="l00214"></a>00214                 <a class="code" href="at90usb__core_8c.html#a3748e6c8f97f3ab0cdc3478d3505ff6b" title="Enter USB host mode.">at90usb_enter_host_mode</a>(at90usb);
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a> the_at90usb_controller;
<a name="l00218"></a>00218 
<a name="l00230"></a><a class="code" href="at90usb__core_8c.html#ae9472c859c6762edc1fecfb70902e4c9">00230</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#ae9472c859c6762edc1fecfb70902e4c9" title="AT90USB general interrupt handler.">at90usb_generic_interrupt</a>(<span class="keywordtype">void</span> *data)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232         <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a>       *at90usb = data;
<a name="l00233"></a>00233         <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a>              *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>;
<a name="l00234"></a>00234         <span class="keyword">struct </span><a class="code" href="structat90usb__host.html">at90usb_host</a>             *hostb;
<a name="l00235"></a>00235         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                         reg;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         reg = avr_read_reg8(USBINT);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a3d4b0f6af272b4207289df925d55a70c" title="Get the AT90USB OTG struct if USB OTG mode is enabled.">at90usb_is_otg</a>(at90usb)) {
<a name="l00240"></a>00240                 <span class="keywordflow">if</span> (reg &amp; <a class="code" href="at90usb__regs_8h.html#a6c9401e72ea687ff3e8e4c7734ff4f05" title="D transition interrupt flag.">AT90USB_USBINT_IDTI</a>) {
<a name="l00241"></a>00241                         avr_write_reg8(USBINT, reg &amp; ~AT90USB_USBINT_IDTI);
<a name="l00242"></a>00242                         <a class="code" href="at90usb__core_8c.html#ab7ab7327b8289521a0e6b5c831d90da5" title="Check the state of the USB OTG ID pin.">at90usb_check_id</a>(at90usb);
<a name="l00243"></a>00243                 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245                 <span class="comment">/* TODO: More OTG stuff */</span>
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         udc = <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb);
<a name="l00249"></a>00249         <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a05f9b6cf4d21b918905185c3a0c72243" title="Check if the AT90USB UDC controller is enabled.">at90usb_udc_is_enabled</a>(udc)) {
<a name="l00250"></a>00250                 <span class="keywordflow">if</span> (reg &amp; <a class="code" href="at90usb__regs_8h.html#a1b4e1bf5901b965d2be4d0bde80f00b6" title="IVBUS transition interrupt flag.">AT90USB_USBINT_VBUSTI</a>) {
<a name="l00251"></a>00251                         avr_write_reg8(USBINT, reg &amp; ~AT90USB_USBINT_VBUSTI);
<a name="l00252"></a>00252                         <a class="code" href="at90usb__core_8c.html#a2e88374f477fa839b220272a15430958" title="Check VBUS and notify the UDC about the status.">at90usb_check_vbus</a>(at90usb);
<a name="l00253"></a>00253                 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                 <span class="keywordflow">if</span> (avr_read_reg8(UDINT) &amp; avr_read_reg8(UDIEN)) {
<a name="l00256"></a>00256                         avr_write_reg8(UDIEN, avr_read_reg8(UDIEN)
<a name="l00257"></a>00257                                         &amp; ~avr_read_reg8(UDINT));
<a name="l00258"></a>00258                         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, &amp;udc-&gt;<a class="code" href="structat90usb__udc.html#aebf47ac0beaac4c1dde8fc98ba95ef50" title="UDC work queue.">task</a>);
<a name="l00259"></a>00259                 }
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         hostb = <a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb);
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a62727ae025bb7d732ef60d18fe6c4e7b" title="Check if the AT90USB host controller is enabled.">at90usb_host_is_enabled</a>(hostb)) {
<a name="l00264"></a>00264                 <span class="comment">/* TODO: More HOST stuff */</span>
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 <a class="code" href="group__intc__group.html#ga4f2ab9f2c27790a07d35d81fb9e917ad" title="Define an interrupt handler for an integrated peripheral.">INTC_DEFINE_HANDLER</a>(USB_GEN_IRQ, <a class="code" href="at90usb__core_8c.html#ae9472c859c6762edc1fecfb70902e4c9" title="AT90USB general interrupt handler.">at90usb_generic_interrupt</a>, 0);
<a name="l00268"></a>00268 
<a name="l00280"></a><a class="code" href="at90usb__core_8c.html#a7f4689b72d7d53b07870e3019804b556">00280</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="at90usb__core_8c.html#a7f4689b72d7d53b07870e3019804b556" title="AT90USB endpoint/pipe interrupt handler.">at90usb_ep_interrupt</a>(<span class="keywordtype">void</span> *data)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282         <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a>       *at90usb = data;
<a name="l00283"></a>00283         <span class="keyword">struct </span><a class="code" href="structat90usb__udc.html">at90usb_udc</a>              *<a class="code" href="structudc.html" title="A USB Device Controller.">udc</a>;
<a name="l00284"></a>00284         <span class="keyword">struct </span><a class="code" href="structat90usb__host.html">at90usb_host</a>             *hostb;
<a name="l00285"></a>00285         <span class="comment">/* Shadow current active endpoint. */</span>
<a name="l00286"></a>00286         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                         uenum = avr_read_reg8(UENUM);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a3d4b0f6af272b4207289df925d55a70c" title="Get the AT90USB OTG struct if USB OTG mode is enabled.">at90usb_is_otg</a>(at90usb)) {
<a name="l00289"></a>00289                 <span class="comment">/* TODO: More OTG stuff? */</span>
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         udc = <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb);
<a name="l00293"></a>00293         <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a05f9b6cf4d21b918905185c3a0c72243" title="Check if the AT90USB UDC controller is enabled.">at90usb_udc_is_enabled</a>(udc)) {
<a name="l00294"></a>00294                 <a class="code" href="group__udc__group.html#gaece2b19e35a4a25398b7e8a9f81f9d28" title="Endpoint identifier.">usb_ep_id_t</a>     ep_id;
<a name="l00295"></a>00295                 <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>         ueint = avr_read_reg8(UEINT);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                 <span class="keywordflow">for</span> (ep_id = 0; ep_id &lt; APP_UDC_NR_ENDPOINTS; ep_id++) {
<a name="l00298"></a>00298                         <span class="keywordflow">if</span> (ueint &amp; <a class="code" href="at90usb__regs_8h.html#a26382863383b03ce7a93c7caa9cb323b" title="Endpoint interrupts.">AT90USB_UEINT_EP</a>(ep_id)) {
<a name="l00299"></a>00299                                 <span class="keyword">struct </span><a class="code" href="structat90usb__udc__ep.html">at90usb_udc_ep</a> *ep = &amp;udc-&gt;<a class="code" href="structat90usb__udc.html#a3f8e7b2e75a2e1834de3f60eb20e8359" title="Array of EPs.">ep</a>[ep_id];
<a name="l00300"></a>00300                                 avr_write_reg8(UENUM, ep_id);
<a name="l00301"></a>00301                                 ep-&gt;<a class="code" href="structat90usb__udc__ep.html#a7f2da754211df207fa6f34209c5139ca" title="Shadow variable of the EP UEIENX register.">ueienx</a> = avr_read_reg8(UEIENX);
<a name="l00302"></a>00302                                 avr_write_reg8(UEIENX, ep-&gt;<a class="code" href="structat90usb__udc__ep.html#a7f2da754211df207fa6f34209c5139ca" title="Shadow variable of the EP UEIENX register.">ueienx</a>
<a name="l00303"></a>00303                                                 &amp; ~avr_read_reg8(UEINTX));
<a name="l00304"></a>00304                                 <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>,
<a name="l00305"></a>00305                                                 &amp;ep-&gt;<a class="code" href="structat90usb__udc__ep.html#a46be98b0f2b43244d7155ddb1ea62bb9" title="EP work queue.">task</a>);
<a name="l00306"></a>00306                         }
<a name="l00307"></a>00307                 }
<a name="l00308"></a>00308         }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         hostb = <a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb);
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (<a class="code" href="at90usb__internal_8h.html#a62727ae025bb7d732ef60d18fe6c4e7b" title="Check if the AT90USB host controller is enabled.">at90usb_host_is_enabled</a>(hostb)) {
<a name="l00312"></a>00312                 <span class="comment">/* TODO: More HOST stuff? */</span>
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">/* Restore the endpoint to what it was before the interrupt. */</span>
<a name="l00316"></a>00316         avr_write_reg8(UENUM, uenum);
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 <a class="code" href="group__intc__group.html#ga4f2ab9f2c27790a07d35d81fb9e917ad" title="Define an interrupt handler for an integrated peripheral.">INTC_DEFINE_HANDLER</a>(USB_EP_IRQ, <a class="code" href="at90usb__core_8c.html#a7f4689b72d7d53b07870e3019804b556" title="AT90USB endpoint/pipe interrupt handler.">at90usb_ep_interrupt</a>, 0);
<a name="l00319"></a>00319 
<a name="l00336"></a><a class="code" href="at90usb__core_8c.html#ac0f08a34d777a18f8a6dd4543fe1246c">00336</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a> *<a class="code" href="at90usb__core_8c.html#ac0f08a34d777a18f8a6dd4543fe1246c" title="Initialize the AT90USB controller.">at90usb_init</a>(<span class="keywordtype">void</span>)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338         <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a>       *at90usb = &amp;the_at90usb_controller;
<a name="l00339"></a>00339         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                         usbcon;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">/*</span>
<a name="l00342"></a>00342 <span class="comment">         * Only do the initialization once. We might get called from</span>
<a name="l00343"></a>00343 <span class="comment">         * udc_init() as well as other initialization functions.</span>
<a name="l00344"></a>00344 <span class="comment">         */</span>
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb) || <a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb))
<a name="l00346"></a>00346                 <span class="keywordflow">return</span> at90usb;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         <a class="code" href="group__sysclk__group.html#ga6e9d5c5dc25b65c71fc5dc271cfbe94b" title="Enable a module clock derived from the system clock.">sysclk_enable_module</a>(<a class="code" href="group__sysclk__group.html#ga0acdf4ca4b306373eb79b5fbc7409be7" title="USB controller.">SYSCLK_USB</a>);
<a name="l00349"></a>00349         <a class="code" href="group__intc__group.html#ga4b818bc80ff7d5822c645b002943b644" title="Set up an interrupt handler.">intc_setup_handler</a>(USB_GEN_IRQ, 0, at90usb);
<a name="l00350"></a>00350         <a class="code" href="group__intc__group.html#ga4b818bc80ff7d5822c645b002943b644" title="Set up an interrupt handler.">intc_setup_handler</a>(USB_EP_IRQ, 0, at90usb);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="preprocessor">#ifdef CONFIG_UDC</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>        at90usb-&gt;udc = <a class="code" href="group__udc__group.html#ga3cff978366b61d760e6163154af4c8f6" title="Initialize the device part of the AT90USB controller.">at90usb_udc_init</a>();
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (!at90usb-&gt;udc)
<a name="l00355"></a>00355                 <span class="keywordflow">goto</span> err_udc;
<a name="l00356"></a>00356 <span class="preprocessor">#endif</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONFIG_AT90USB_HOST</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>        at90usb-&gt;host = at90usb_host_init();
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (!at90usb-&gt;host)
<a name="l00360"></a>00360                 <span class="keywordflow">goto</span> err_host;
<a name="l00361"></a>00361 <span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>
<a name="l00363"></a>00363         <a class="code" href="clk_8h.html#aced73f32af97f175ef7d372bc7653c6b" title="Enable the AT90USB USB clock, sourced from the internal PLL.">clk_enable_at90usb</a>();
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="comment">/* Keep the FRZCLK bit if set in USBCON. This bit must be held active</span>
<a name="l00366"></a>00366 <span class="comment">         * while the USB peripheral is enabled. And then cleared on a following</span>
<a name="l00367"></a>00367 <span class="comment">         * write to USBCON to enable the USB peripheral. */</span>
<a name="l00368"></a>00368         usbcon = (avr_read_reg8(USBCON) &amp; <a class="code" href="at90usb__regs_8h.html#a2a6dd6e16eb2196640793171d7098f93" title="Freeze USB clock.">AT90USB_USBCON_FRZCLK</a>)
<a name="l00369"></a>00369                 | <a class="code" href="at90usb__regs_8h.html#a62ceb04d7887922ce15f1344b3061e52" title="USB macro enable.">AT90USB_USBCON_USBE</a>
<a name="l00370"></a>00370                 | <a class="code" href="at90usb__regs_8h.html#ad77b582ebb0b86498ece3a0181052736" title="OTG pad enable.">AT90USB_USBCON_OTGPADE</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a3d4b0f6af272b4207289df925d55a70c" title="Get the AT90USB OTG struct if USB OTG mode is enabled.">at90usb_is_otg</a>(at90usb)) {
<a name="l00373"></a>00373                 <span class="comment">/* Full OTG */</span>
<a name="l00374"></a>00374                 usbcon |= <a class="code" href="at90usb__regs_8h.html#a8db47045b8874fe77554f2a138e06d66" title="ID transition interrupt enable.">AT90USB_USBCON_IDTE</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                 avr_write_reg8(UHWCON, <a class="code" href="at90usb__regs_8h.html#ac642ee7af155f44f5dd45adb28d1762e" title="UID pin enable.">AT90USB_UHWCON_UIDE</a>);
<a name="l00377"></a>00377                 avr_write_reg8(USBINT, avr_read_reg8(USBINT)
<a name="l00378"></a>00378                                 &amp; ~<a class="code" href="at90usb__regs_8h.html#a6c9401e72ea687ff3e8e4c7734ff4f05" title="D transition interrupt flag.">AT90USB_USBINT_IDTI</a>);
<a name="l00379"></a>00379                 avr_write_reg8(USBCON, usbcon);
<a name="l00380"></a>00380                 avr_write_reg8(USBCON, usbcon &amp; ~<a class="code" href="at90usb__regs_8h.html#a2a6dd6e16eb2196640793171d7098f93" title="Freeze USB clock.">AT90USB_USBCON_FRZCLK</a>);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                 <a class="code" href="at90usb__core_8c.html#ab7ab7327b8289521a0e6b5c831d90da5" title="Check the state of the USB OTG ID pin.">at90usb_check_id</a>(at90usb);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                 <span class="comment">/* TODO: initialize HNP, SRP handling, etc. */</span>
<a name="l00385"></a>00385         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb)) {
<a name="l00386"></a>00386                 <span class="comment">/* Device only */</span>
<a name="l00387"></a>00387                 avr_write_reg8(UHWCON, <a class="code" href="at90usb__regs_8h.html#a7dd2e01a5287cf9f674ab6f3018074e4" title="USB mode.">AT90USB_UHWCON_UIMOD</a>);
<a name="l00388"></a>00388                 avr_write_reg8(USBCON, usbcon);
<a name="l00389"></a>00389                 avr_write_reg8(USBCON, usbcon &amp; ~<a class="code" href="at90usb__regs_8h.html#a2a6dd6e16eb2196640793171d7098f93" title="Freeze USB clock.">AT90USB_USBCON_FRZCLK</a>);
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                 <a class="code" href="at90usb__core_8c.html#a432d9252a87825ebd2bcd21966a38b5c" title="Enter USB device mode.">at90usb_enter_device_mode</a>(at90usb);
<a name="l00392"></a>00392         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="at90usb__core_8c.html#a48cd0d38b0b1d25e5a21b219b188eff4" title="Get the AT90USB host struct if USB host mode is enabled.">at90usb_get_host</a>(at90usb)) {
<a name="l00393"></a>00393                 <span class="comment">/* Host only */</span>
<a name="l00394"></a>00394                 avr_write_reg8(UHWCON, <a class="code" href="at90usb__regs_8h.html#a4721c9881c018c744ab3cb44fb93725c" title="USB pad regulator enable.">AT90USB_UHWCON_UVREGE</a>);
<a name="l00395"></a>00395                 avr_write_reg8(USBCON, usbcon);
<a name="l00396"></a>00396                 avr_write_reg8(USBCON, usbcon &amp; ~<a class="code" href="at90usb__regs_8h.html#a2a6dd6e16eb2196640793171d7098f93" title="Freeze USB clock.">AT90USB_USBCON_FRZCLK</a>);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398                 <a class="code" href="at90usb__core_8c.html#a3748e6c8f97f3ab0cdc3478d3505ff6b" title="Enter USB host mode.">at90usb_enter_host_mode</a>(at90usb);
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="keywordflow">return</span> at90usb;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="preprocessor">#ifdef CONFIG_AT90USB_HOST</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>err_host:
<a name="l00405"></a>00405         <a class="code" href="group__udc__group.html#ga260d2f316b9a1bbc5e0f528a337f3015" title="Shut down the device part of the AT90USB controller.">at90usb_udc_shutdown</a>(<a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb));
<a name="l00406"></a>00406 <span class="preprocessor">#endif</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span><span class="preprocessor">#ifdef CONFIG_UDC</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>err_udc:
<a name="l00409"></a>00409 <span class="preprocessor">#endif</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>        <span class="keywordflow">return</span> NULL;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00426"></a><a class="code" href="group__udc__group.html#gae92092dc5b5aca35223380ca7cfb5e1b">00426</a> <span class="keyword">struct </span><a class="code" href="structudc.html" title="A USB Device Controller.">udc</a> *<a class="code" href="group__udc__group.html#gae92092dc5b5aca35223380ca7cfb5e1b" title="Initialize the USB Device Controller.">udc_init</a>(<span class="keywordtype">void</span>)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428         <span class="keyword">struct </span><a class="code" href="structat90usb__controller.html">at90usb_controller</a> *at90usb;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         at90usb = <a class="code" href="at90usb__core_8c.html#ac0f08a34d777a18f8a6dd4543fe1246c" title="Initialize the AT90USB controller.">at90usb_init</a>();
<a name="l00431"></a>00431         <span class="keywordflow">if</span> (!at90usb)
<a name="l00432"></a>00432                 <span class="keywordflow">return</span> NULL;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <span class="keywordflow">return</span> &amp;<a class="code" href="at90usb__core_8c.html#a5e059bcb36d1cb1ad5b0cb40c3f8891c" title="Get the AT90USB UDC struct if UDC mode is enabled.">at90usb_get_udc</a>(at90usb)-&gt;<a class="code" href="structat90usb__udc.html#acb2b2b775d2487cd343617bc2e8058fe" title="The UDC controller.">udc</a>;
<a name="l00435"></a>00435 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:10:34 2010 for xplain-bc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
