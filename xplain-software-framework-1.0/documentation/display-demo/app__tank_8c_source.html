<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-demo: apps/display-demo/app_tank.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>apps/display-demo/app_tank.c</h1><a href="app__tank_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="assert_8h.html" title="Run-time and build-time assertion support.">assert.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="gfx_8h.html" title="General graphics routines header file.">gfx/gfx.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="include_2gfx_2win_8h.html" title="Graphical Window system.">gfx/win.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="include_2gfx_2wtk_8h.html" title="Graphical Widget toolkit.">gfx/wtk.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="include_2gfx_2sysfont_8h.html" title="Graphical Window system.">gfx/sysfont.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="mainloop_8h.html" title="Main loop processing.">mainloop.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="include_2membag_8h.html" title="Memory bag allocator.">membag.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="board_2xplain_2include_2board_2physmem_8h.html" title="Board specific physical memory definitions.">physmem.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="status__codes_8h.html" title="Status code definitions.">status_codes.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="arch_2avr8_2include_2arch_2string_8h.html" title="Standard string operations for AVR.">string.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="chip_2atxmega128a1_2include_2chip_2timer_8h.html" title="ATxmega128A1 chip-specific Timer definitions.">timer.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="util_8h.html" title="Misc utility functions and definitions.">util.h</a>&gt;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="app__tank_8h.html" title="Display demo process control application.">app_tank.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="app__desktop_8h.html" title="Display demo desktop application.">app_desktop.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="file__loader_8h.html" title="Display Xplained image loader.">file_loader.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="group__apps__tank__group.html#gafd302b6035f5bc21566c805c131d3a4d">00068</a> <span class="preprocessor">#define COLOR_WIN_BACKGROUND     GFX_COLOR(0, 0, 0)</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a><a class="code" href="group__apps__tank__group.html#ga07fd9d8f4c8ec6b8c48b37c3a1b4141c">00070</a> <span class="preprocessor">#define COLOR_LEVEL_FILL          GFX_COLOR(0, 0, 255)</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a><a class="code" href="group__apps__tank__group.html#gabe26b649868b497cb8a6ad0eb3dec3c0">00072</a> <span class="preprocessor">#define COLOR_LEVEL_BACKGROUND    GFX_COLOR(32, 32, 32)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="group__apps__tank__group.html#gaea4b3d4651065f33a8f91d21e6719611">00074</a> <span class="preprocessor">#define COLOR_DEMAND_NORMAL      GFX_COLOR(64, 192, 64)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="group__apps__tank__group.html#gaad4b2fdb1d1eac06faad798251622e99">00076</a> <span class="preprocessor">#define COLOR_DEMAND_CRITICAL    GFX_COLOR(192, 64, 64)</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="group__apps__tank__group.html#gaf834ed1f96c77cac6e7eb784862c4169">00078</a> <span class="preprocessor">#define COLOR_DEMAND_BACKGROUND  GFX_COLOR(32, 32, 32)</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00081"></a>00081 
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="group__apps__tank__group.html#gaf441238943296076659931176d606125">00089</a> <span class="preprocessor">#define VALUE_LEVEL_MAXIMUM             127</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>
<a name="l00091"></a><a class="code" href="group__apps__tank__group.html#gaf4de491885c74588f7b5dc6e0c2fd79c">00091</a> <span class="preprocessor">#define VALUE_LEVEL_INITIAL             0</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a><a class="code" href="group__apps__tank__group.html#gae36894d97b2a2b23eb8e0945bf338ea8">00093</a> <span class="preprocessor">#define VALUE_SUPPLY_MAXIMUM           VALUE_LEVEL_MAXIMUM</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a><a class="code" href="group__apps__tank__group.html#ga1fee1cdf8bc28ab1bfbef86344f796b6">00095</a> <span class="preprocessor">#define VALUE_SUPPLY_INITIAL           (VALUE_SUPPLY_MAXIMUM / 2)</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a><a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851">00097</a> <span class="preprocessor">#define VALUE_DEMAND_MAXIMUM           VALUE_LEVEL_MAXIMUM</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>
<a name="l00099"></a><a class="code" href="group__apps__tank__group.html#gab26081646d7a02b13135bd110d732e35">00099</a> <span class="preprocessor">#define VALUE_DEMAND_INITIAL           0</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00102"></a>00102 
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="group__apps__tank__group.html#ga4e417160b7d37901dc8d3c9271dfc2a6">00110</a> <span class="preprocessor">#define WIDGET_LEVEL_SIZE_X              52</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="group__apps__tank__group.html#ga9bfd544726b998104038cf026677a731">00112</a> <span class="preprocessor">#define WIDGET_LEVEL_SIZE_Y              121</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>
<a name="l00114"></a><a class="code" href="group__apps__tank__group.html#gaaf7b13894f0872ef96a94b110269d2dd">00114</a> <span class="preprocessor">#define WIDGET_LEVEL_POSITION_X          134</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>
<a name="l00116"></a><a class="code" href="group__apps__tank__group.html#gaad2f85c8a07383886d98430ac5590bdd">00116</a> <span class="preprocessor">#define WIDGET_LEVEL_POSITION_Y          59</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00119"></a><a class="code" href="group__apps__tank__group.html#gacb68259d194d48b58edcbf4f52e2a8c0">00119</a> <span class="preprocessor">#define WIDGET_SUPPLY_SIZE_X            37</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a><a class="code" href="group__apps__tank__group.html#gab529fb56b5e762d9a3ad7d9d658e74a4">00121</a> <span class="preprocessor">#define WIDGET_SUPPLY_SIZE_Y            105</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a><a class="code" href="group__apps__tank__group.html#ga6d894a03c8a7b2f2fa2f84b5bf7f0e66">00123</a> <span class="preprocessor">#define WIDGET_SUPPLY_POSITION_X        39</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>
<a name="l00125"></a><a class="code" href="group__apps__tank__group.html#gafea33d6d75ec1f26c3bb57f0abdbb23d">00125</a> <span class="preprocessor">#define WIDGET_SUPPLY_POSITION_Y        85</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="group__apps__tank__group.html#ga02f8b128a5d4fba1977873548d63a7a3">00128</a> <span class="preprocessor">#define WIDGET_DEMAND_SIZE_X            20</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00130"></a><a class="code" href="group__apps__tank__group.html#gafbd239e7ea8d3a5252392b7514b975ea">00130</a> <span class="preprocessor">#define WIDGET_DEMAND_SIZE_Y            45</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00132"></a><a class="code" href="group__apps__tank__group.html#ga4d61f2a8b0f57934bcebb72ad736d6c7">00132</a> <span class="preprocessor">#define WIDGET_DEMAND_POSITION_X        250</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span>
<a name="l00134"></a><a class="code" href="group__apps__tank__group.html#gacea06d037d26b33ddb37680b9d5742c5">00134</a> <span class="preprocessor">#define WIDGET_DEMAND_POSITION_Y        100</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>
<a name="l00137"></a>00137 
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="group__apps__tank__group.html#gad1fc80ba02d339b52460ae7a3d7bdafc">00145</a> <span class="preprocessor">#define BITMAP_BACKGROUND_FILENAME      &quot;p_tankbg&quot;</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>
<a name="l00147"></a><a class="code" href="group__apps__tank__group.html#ga40631618718869c60ee1bdf55f77e5f0">00147</a> <span class="preprocessor">#define BITMAP_BACKGROUND_SIZE_X        320</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="group__apps__tank__group.html#gab884dbcc70f60fed0444bc936f3f9b87">00149</a> <span class="preprocessor">#define BITMAP_BACKGROUND_SIZE_Y        240</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span>
<a name="l00151"></a><a class="code" href="group__apps__tank__group.html#ga25776f547b170688b1c42913ad1656c0">00151</a> <span class="preprocessor">#define BITMAP_BACKGROUND_POSITION_X    0</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>
<a name="l00153"></a><a class="code" href="group__apps__tank__group.html#gab4dea6e2d3dd1c192ff7c45cffe081b5">00153</a> <span class="preprocessor">#define BITMAP_BACKGROUND_POSITION_Y    0</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>
<a name="l00156"></a><a class="code" href="group__apps__tank__group.html#gaa8af4926612d09c2857f08a784d5ad95">00156</a> <span class="preprocessor">#define BITMAP_RED_LIGHT_FILENAME       &quot;p_lgtred&quot;</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>
<a name="l00158"></a><a class="code" href="group__apps__tank__group.html#ga235a10b5f5cebb8dd369378facdc60a5">00158</a> <span class="preprocessor">#define BITMAP_GREEN_LIGHT_FILENAME     &quot;p_lgtgrn&quot;</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>
<a name="l00160"></a><a class="code" href="group__apps__tank__group.html#ga1e32b475f3c1164ebfbfc653fff1a1e9">00160</a> <span class="preprocessor">#define BITMAP_LIGHT_SIZE_X             38</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>
<a name="l00162"></a><a class="code" href="group__apps__tank__group.html#ga13096596ae0459eee44ed97a46df8e90">00162</a> <span class="preprocessor">#define BITMAP_LIGHT_SIZE_Y             38</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>
<a name="l00164"></a><a class="code" href="group__apps__tank__group.html#ga1b49ae7c221c57daa9930d950b0fb1db">00164</a> <span class="preprocessor">#define BITMAP_LIGHT_POSITION_X         241</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>
<a name="l00166"></a><a class="code" href="group__apps__tank__group.html#ga7560cecfe5009db21cbc7408b9382c57">00166</a> <span class="preprocessor">#define BITMAP_LIGHT_POSITION_Y         26</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>
<a name="l00169"></a>00169 
<a name="l00182"></a><a class="code" href="group__apps__tank__group.html#gaf4021b95b18dc511ba274a310fe66d08">00182</a> <span class="preprocessor">#define TICK_RATE                       30</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00190"></a><a class="code" href="group__apps__tank__group.html#gaf7d2a374ba8e1f467684f6af15307204">00190</a> <span class="preprocessor">#define TICKS_PER_RANDOM_UPDATE         9</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>
<a name="l00193"></a>00193 
<a name="l00195"></a><a class="code" href="group__apps__tank__group.html#ga454060f2b9c2a7f895443e4e67b0415b">00195</a> <span class="keyword">enum</span> <a class="code" href="group__apps__tank__group.html#ga454060f2b9c2a7f895443e4e67b0415b" title="States for the application loader task.">tank_loader_state</a> {
<a name="l00197"></a><a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415bafcee5fbb65b7383c8ec0d90ddbae4d60">00197</a>         <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415bafcee5fbb65b7383c8ec0d90ddbae4d60" title="Red alarm light bitmap will be loaded to hugemem.">LOAD_RED_LIGHT</a>,
<a name="l00199"></a><a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba45a2b5b0d4835d578fb221b792260c9f">00199</a>         <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba45a2b5b0d4835d578fb221b792260c9f" title="Green alarm light bitmap will be loaded to hugemem.">LOAD_GREEN_LIGHT</a>,
<a name="l00201"></a><a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba6ddfc4348b67e07b146d131fbefe1262">00201</a>         <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba6ddfc4348b67e07b146d131fbefe1262" title="Background bitmap will be shown.">LOAD_BACKGROUND</a>,
<a name="l00203"></a><a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415badf18c9dec2b78395e76466e99987be8f">00203</a>         <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415badf18c9dec2b78395e76466e99987be8f" title="The application&amp;#39;s widgets will be shown, and its timer started.">LOAD_FINISHED</a>,
<a name="l00204"></a>00204 };
<a name="l00205"></a>00205 
<a name="l00212"></a><a class="code" href="group__apps__tank__group.html#ga25e6e4a67f94320d9984a34119dec146">00212</a> <span class="keyword">enum</span> <a class="code" href="group__apps__tank__group.html#ga25e6e4a67f94320d9984a34119dec146" title="Enumeration of bitmaps to load to hugemem.">tank_bitmap_id</a> {
<a name="l00214"></a><a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232">00214</a>         <a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>,
<a name="l00216"></a><a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba">00216</a>         <a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>,
<a name="l00218"></a><a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146aa288c003eb360f96a7bdab005043d51e">00218</a>         <a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146aa288c003eb360f96a7bdab005043d51e" title="Total number of bitmaps loaded to hugemem.">NR_OF_BITMAPS</a>,
<a name="l00219"></a>00219 };
<a name="l00220"></a>00220 
<a name="l00227"></a><a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22">00227</a> <span class="keyword">static</span> <a class="code" href="group__hugemem__group.html#gad1f5b6899e22cd9bc4787ad502314968" title="Type to use for pointers to huge memory.">hugemem_ptr_t</a> <a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146aa288c003eb360f96a7bdab005043d51e" title="Total number of bitmaps loaded to hugemem.">NR_OF_BITMAPS</a>];
<a name="l00228"></a>00228 
<a name="l00237"></a><a class="code" href="group__apps__tank__group.html#ga9c67ad111c5d786be5639fc2d489aa2e">00237</a> <span class="keyword">enum</span> <a class="code" href="group__apps__tank__group.html#ga9c67ad111c5d786be5639fc2d489aa2e" title="Event command ID for application widgets.">tank_command_id</a> {
<a name="l00239"></a><a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea93c1ce1fac89139d9f4df4b6db21b1cc">00239</a>         <a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea93c1ce1fac89139d9f4df4b6db21b1cc" title="Command event value to use for supply-slider.">CMD_NONE</a>,
<a name="l00241"></a><a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea423988140dabaa461f133924ca772294">00241</a>         <a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea423988140dabaa461f133924ca772294" title="Command event value to use for exit-button.">CMD_EXIT</a>,
<a name="l00242"></a>00242 };
<a name="l00243"></a>00243 
<a name="l00245"></a><a class="code" href="structtank__context.html">00245</a> <span class="keyword">struct </span><a class="code" href="structtank__context.html" title="Context for the water tank application.">tank_context</a> {
<a name="l00247"></a><a class="code" href="structtank__context.html#a04484bd9c748dd821153a410fd3cb3b6">00247</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a>   *<a class="code" href="structtank__context.html#a04484bd9c748dd821153a410fd3cb3b6" title="Pointer to the workqueue task of the application.">task</a>;
<a name="l00249"></a><a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50">00249</a>         <span class="keyword">struct </span><a class="code" href="structwtk__basic__frame.html" title="Basic frame control struct.">wtk_basic_frame</a>  *<a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50" title="Pointer to the main frame of the application.">frame</a>;
<a name="l00251"></a><a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0">00251</a>         <span class="keyword">struct </span><a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a>             <a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0" title="Copy of the sysfont before it is modified by the application.">old_sysfont</a>;
<a name="l00253"></a><a class="code" href="structtank__context.html#acc91a428c412cf2afeb28ea2c01dfd75">00253</a>         <span class="keyword">struct </span><a class="code" href="structwtk__progress__bar.html" title="Progress bar control struct.">wtk_progress_bar</a> *<a class="code" href="structtank__context.html#acc91a428c412cf2afeb28ea2c01dfd75" title="Pointer to progress bar widget for tank level.">level</a>;
<a name="l00255"></a><a class="code" href="structtank__context.html#a6ebf2dd95b3c57f2a7fe1386e2f978ec">00255</a>         <span class="keyword">struct </span><a class="code" href="structwtk__slider.html" title="Slider control struct.">wtk_slider</a>       *<a class="code" href="structtank__context.html#a6ebf2dd95b3c57f2a7fe1386e2f978ec" title="Pointer to slider widget for supply.">supply</a>;
<a name="l00257"></a><a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad">00257</a>         <span class="keyword">struct </span><a class="code" href="structwtk__progress__bar.html" title="Progress bar control struct.">wtk_progress_bar</a> *<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a>;
<a name="l00259"></a><a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2">00259</a>         <span class="keyword">struct </span><a class="code" href="structtimer.html" title="Timer data.">timer</a>            <a class="code" href="structtimer.html" title="Timer data.">timer</a>;
<a name="l00261"></a><a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2">00261</a>         <span class="keyword">enum</span> <a class="code" href="group__apps__tank__group.html#ga454060f2b9c2a7f895443e4e67b0415b" title="States for the application loader task.">tank_loader_state</a>  <a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a>;
<a name="l00263"></a><a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea">00263</a>         <span class="keywordtype">bool</span>                    <a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a>;
<a name="l00265"></a><a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea">00265</a>         <span class="keywordtype">bool</span>                    <a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a>;
<a name="l00267"></a><a class="code" href="structtank__context.html#a2222308c6354e52b1e9c93eae57d300b">00267</a>         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>                <a class="code" href="structtank__context.html#a2222308c6354e52b1e9c93eae57d300b" title="Timer delay needed for application tick rate.">timer_delay</a>;
<a name="l00269"></a><a class="code" href="structtank__context.html#a4c9affa8e08787d8871d4a6b9a425d00">00269</a>         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>                <a class="code" href="structtank__context.html#a4c9affa8e08787d8871d4a6b9a425d00" title="Tick count until update of random variable.">rand_ticks</a>;
<a name="l00271"></a><a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0">00271</a>         <a class="code" href="group__stdint__group.html#gafd12020da5a235dfcf0c3c748fb5baed" title="32-bit signed integer">int32_t</a>                 <a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0" title="Random variable to get time-varying water demand.">rand</a>;
<a name="l00273"></a><a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2">00273</a>         <span class="keyword">struct </span><a class="code" href="structgfx__bitmap.html" title="Storage structure for bitmap pixel data and metadata.">gfx_bitmap</a>       <a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146aa288c003eb360f96a7bdab005043d51e" title="Total number of bitmaps loaded to hugemem.">NR_OF_BITMAPS</a>];
<a name="l00274"></a>00274 };
<a name="l00275"></a>00275 
<a name="l00283"></a><a class="code" href="group__apps__tank__group.html#ga7fb664d01f225008b6bce6041df7b295">00283</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structtank__context.html" title="Context for the water tank application.">tank_context</a> *<a class="code" href="group__apps__tank__group.html#ga7fb664d01f225008b6bce6041df7b295" title="Pointer to water tank application context.">tank_ctx</a>;
<a name="l00284"></a>00284 
<a name="l00298"></a><a class="code" href="group__apps__tank__group.html#ga055a10b82bfea70f9f4d029ff5252d58">00298</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="group__apps__tank__group.html#ga055a10b82bfea70f9f4d029ff5252d58" title="Command event handler for the application&amp;#39;s frame.">tank_frame_handler</a>(<span class="keyword">struct</span> <a class="code" href="structwtk__basic__frame.html" title="Basic frame control struct.">wtk_basic_frame</a> *basic_frame,
<a name="l00299"></a>00299                 <a class="code" href="group__gfx__win.html#ga53f0ed533fce454af67e765764d7eb5f" title="Custom data, can be used as a data pointer or data depending on the application.">win_command_t</a> command_data)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301         <span class="keywordflow">switch</span> ((<span class="keyword">enum</span> <a class="code" href="group__apps__tank__group.html#ga9c67ad111c5d786be5639fc2d489aa2e" title="Event command ID for application widgets.">tank_command_id</a>)(<a class="code" href="group__stdint__group.html#ga2f2d463af0e2a9da3ecdd102ce312832" title="Unsigned integer type capable of holding a pointer.">uintptr_t</a>)command_data) {
<a name="l00302"></a>00302         <span class="keywordflow">case</span> <a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea423988140dabaa461f133924ca772294" title="Command event value to use for exit-button.">CMD_EXIT</a>:
<a name="l00303"></a>00303                 <span class="comment">// Stop the application timer first.</span>
<a name="l00304"></a>00304                 <a class="code" href="group__timer__group.html#ga590ac9452b480e00dfc03987c4d68bd6" title="Stop the timer.">timer_stop</a>(CONFIG_TIMER_ID, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2" title="Timer struct needed for the timer driver.">timer</a>);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306                 <span class="comment">// Free all memory and return to desktop.</span>
<a name="l00307"></a>00307                 <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0" title="Copy of the sysfont before it is modified by the application.">old_sysfont</a>,
<a name="l00308"></a>00308                                 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a>));
<a name="l00309"></a>00309                 <a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27" title="Free previously allocated memory.">membag_free</a>(tank_ctx);
<a name="l00310"></a>00310                 tank_ctx = NULL;
<a name="l00311"></a>00311                 <a class="code" href="group__app__desktop__group.html#ga3b0b29a4aaa11773cb5ccddedd80dab5" title="Restart desktop.">app_desktop_restart</a>();
<a name="l00312"></a>00312                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="keywordflow">default</span>:
<a name="l00315"></a>00315                 <span class="keywordflow">break</span>;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00333"></a><a class="code" href="group__apps__tank__group.html#ga29edfa5836f371d57caa0426d291446a">00333</a> <span class="keyword">static</span> <a class="code" href="group__stdint__group.html#gafd12020da5a235dfcf0c3c748fb5baed" title="32-bit signed integer">int32_t</a> <a class="code" href="group__apps__tank__group.html#ga29edfa5836f371d57caa0426d291446a" title="Compute new random value via a logistic map.">tank_logistic_map</a>(<a class="code" href="group__stdint__group.html#gafd12020da5a235dfcf0c3c748fb5baed" title="32-bit signed integer">int32_t</a> <a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0" title="Random variable to get time-varying water demand.">rand</a>)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335         <span class="comment">/* Ensure that the current value will not map to 0, as the logistic map</span>
<a name="l00336"></a>00336 <span class="comment">         * will then get &quot;stuck&quot;.</span>
<a name="l00337"></a>00337 <span class="comment">         */</span>
<a name="l00338"></a>00338         rand = <a class="code" href="group__utility__group.html#ga6a4c72168033c8278d76e922bbf66e15" title="Get the highest of two signed values.">max_s</a>(rand, 1);
<a name="l00339"></a>00339         rand = <a class="code" href="group__utility__group.html#gac81b8d89d970e54bfae7a83f7067a961" title="Get the lowest of two signed values.">min_s</a>(rand, <a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851" title="Maximum value of demand.">VALUE_DEMAND_MAXIMUM</a> - 1);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">/* Map to a new value with the logistic function.</span>
<a name="l00342"></a>00342 <span class="comment">         * See application description for explanation.</span>
<a name="l00343"></a>00343 <span class="comment">         */</span>
<a name="l00344"></a>00344         rand *= <a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851" title="Maximum value of demand.">VALUE_DEMAND_MAXIMUM</a> - rand;
<a name="l00345"></a>00345         rand *= 79;
<a name="l00346"></a>00346         rand /= <a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851" title="Maximum value of demand.">VALUE_DEMAND_MAXIMUM</a> * 20;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         <span class="keywordflow">return</span> rand;
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00371"></a><a class="code" href="group__apps__tank__group.html#ga333ec630fa3dbb2bd9fb13dddde68321">00371</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__apps__tank__group.html#ga333ec630fa3dbb2bd9fb13dddde68321" title="Application worker function.">tank_worker</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structtank__context.html#a04484bd9c748dd821153a410fd3cb3b6" title="Pointer to the workqueue task of the application.">task</a>)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373         <span class="keyword">struct </span><a class="code" href="structgfx__bitmap.html" title="Storage structure for bitmap pixel data and metadata.">gfx_bitmap</a>   *alarm_bitmap = NULL;
<a name="l00374"></a>00374         <span class="keywordtype">bool</span>                alarm_update = <span class="keyword">false</span>;
<a name="l00375"></a>00375         <a class="code" href="group__stdint__group.html#gafd12020da5a235dfcf0c3c748fb5baed" title="32-bit signed integer">int32_t</a>             rand;
<a name="l00376"></a>00376         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>             supply;
<a name="l00377"></a>00377         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a>            demand;
<a name="l00378"></a>00378         <a class="code" href="group__stdint__group.html#ga2140805d08462d474b82ddc8d1c2f3e6" title="16-bit signed integer">int16_t</a>             flow;
<a name="l00379"></a>00379         <a class="code" href="group__stdint__group.html#ga2140805d08462d474b82ddc8d1c2f3e6" title="16-bit signed integer">int16_t</a>             level;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="comment">// Quit immediately if application context has been cleared.</span>
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (!tank_ctx) {
<a name="l00383"></a>00383                 <span class="keywordflow">return</span>;
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="comment">// Get current values of the process parameters.</span>
<a name="l00387"></a>00387         level = <a class="code" href="group__gfx__wtk__progress__bar.html#ga7cd64f7bb87a00217d721e4c8104431f" title="Get progress bar value.">wtk_progress_bar_get_value</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#acc91a428c412cf2afeb28ea2c01dfd75" title="Pointer to progress bar widget for tank level.">level</a>);
<a name="l00388"></a>00388         supply = <a class="code" href="group__gfx__wtk__slider.html#ga685ad61e500fe87c9a50b4353fc926f6" title="Get slider value.">wtk_slider_get_value</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a6ebf2dd95b3c57f2a7fe1386e2f978ec" title="Pointer to slider widget for supply.">supply</a>);
<a name="l00389"></a>00389         demand = <a class="code" href="group__gfx__wtk__progress__bar.html#ga7cd64f7bb87a00217d721e4c8104431f" title="Get progress bar value.">wtk_progress_bar_get_value</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a>);
<a name="l00390"></a>00390         rand = tank_ctx-&gt;<a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0" title="Random variable to get time-varying water demand.">rand</a>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="comment">// Update the random variable if enough ticks have passed.</span>
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (--(tank_ctx-&gt;<a class="code" href="structtank__context.html#a4c9affa8e08787d8871d4a6b9a425d00" title="Tick count until update of random variable.">rand_ticks</a>) == 0) {
<a name="l00394"></a>00394                 tank_ctx-&gt;<a class="code" href="structtank__context.html#a4c9affa8e08787d8871d4a6b9a425d00" title="Tick count until update of random variable.">rand_ticks</a> = <a class="code" href="group__apps__tank__group.html#gaf7d2a374ba8e1f467684f6af15307204" title="Application ticks between each update of random variable.">TICKS_PER_RANDOM_UPDATE</a>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396                 <span class="comment">// Flip some LSBs to help avoid a stuck process.</span>
<a name="l00397"></a>00397                 rand ^= demand &amp; 0x03;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399                 <span class="comment">// Compute new random value and store it for next iteration.</span>
<a name="l00400"></a>00400                 rand = <a class="code" href="group__apps__tank__group.html#ga29edfa5836f371d57caa0426d291446a" title="Compute new random value via a logistic map.">tank_logistic_map</a>(rand);
<a name="l00401"></a>00401                 tank_ctx-&gt;<a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0" title="Random variable to get time-varying water demand.">rand</a> = rand;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <span class="comment">// Now, compute the new demand from a weighted scheme.</span>
<a name="l00405"></a>00405         demand = rand + (2 * demand) + level;
<a name="l00406"></a>00406         demand /= 4;
<a name="l00407"></a>00407         demand = <a class="code" href="group__utility__group.html#gac379f8059c0eaa99d04c1f3bf481a67d" title="Get the lowest of two unsigned values.">min_u</a>(demand, <a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851" title="Maximum value of demand.">VALUE_DEMAND_MAXIMUM</a>);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="comment">/* Compute the total flow and scale it down for a smoother</span>
<a name="l00410"></a>00410 <span class="comment">         * simulation.</span>
<a name="l00411"></a>00411 <span class="comment">         */</span>
<a name="l00412"></a>00412         flow = supply;
<a name="l00413"></a>00413         flow -= demand;
<a name="l00414"></a>00414         flow /= 4;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="comment">// Compute new level for the tank.</span>
<a name="l00417"></a>00417         level += flow;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="comment">/* Update the demand indicator. Change its color if the demand</span>
<a name="l00420"></a>00420 <span class="comment">         * exceeds the supply and available water in the tank.</span>
<a name="l00421"></a>00421 <span class="comment">         */</span>
<a name="l00422"></a>00422         <span class="keywordflow">if</span> (level &lt;= 0) {
<a name="l00423"></a>00423                 <span class="keywordflow">if</span> (!tank_ctx-&gt;<a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a>) {
<a name="l00424"></a>00424                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a> = <span class="keyword">true</span>;
<a name="l00425"></a>00425                         <a class="code" href="group__gfx__wtk__progress__bar.html#gac7c179fd9df3697c0350568f3e60acb3" title="Set new progress bar colors.">wtk_progress_bar_set_colors</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a>,
<a name="l00426"></a>00426                                         <a class="code" href="group__apps__tank__group.html#gaad4b2fdb1d1eac06faad798251622e99" title="Critical fill color for demand indicator.">COLOR_DEMAND_CRITICAL</a>,
<a name="l00427"></a>00427                                         <a class="code" href="group__apps__tank__group.html#gaf834ed1f96c77cac6e7eb784862c4169" title="Background color for demand indicator.">COLOR_DEMAND_BACKGROUND</a>);
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429                 level = 0;
<a name="l00430"></a>00430         } <span class="keywordflow">else</span> {
<a name="l00431"></a>00431                 <span class="keywordflow">if</span> (tank_ctx-&gt;<a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a>) {
<a name="l00432"></a>00432                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a> = <span class="keyword">false</span>;
<a name="l00433"></a>00433                         <a class="code" href="group__gfx__wtk__progress__bar.html#gac7c179fd9df3697c0350568f3e60acb3" title="Set new progress bar colors.">wtk_progress_bar_set_colors</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a>,
<a name="l00434"></a>00434                                         <a class="code" href="group__apps__tank__group.html#gaea4b3d4651065f33a8f91d21e6719611" title="Normal fill color for demand indicator.">COLOR_DEMAND_NORMAL</a>,
<a name="l00435"></a>00435                                         <a class="code" href="group__apps__tank__group.html#gaf834ed1f96c77cac6e7eb784862c4169" title="Background color for demand indicator.">COLOR_DEMAND_BACKGROUND</a>);
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438         <a class="code" href="group__gfx__wtk__progress__bar.html#ga36d595cfd3afc89055a8033c43b5b54a" title="Set new progress bar value.">wtk_progress_bar_set_value</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a>, demand);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         <span class="comment">/* Update the tank level indicator.</span>
<a name="l00441"></a>00441 <span class="comment">         * The level of the tank cannot exceed the defined maximum,</span>
<a name="l00442"></a>00442 <span class="comment">         * and its alarm light must be updated whenever this level</span>
<a name="l00443"></a>00443 <span class="comment">         * is crossed.</span>
<a name="l00444"></a>00444 <span class="comment">         */</span>
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (level &gt;= <a class="code" href="group__apps__tank__group.html#gaf441238943296076659931176d606125" title="Maximum level of tank.">VALUE_LEVEL_MAXIMUM</a>) {
<a name="l00446"></a>00446                 <span class="keywordflow">if</span> (!tank_ctx-&gt;<a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a>) {
<a name="l00447"></a>00447                         tank_ctx-&gt;<a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a> = <span class="keyword">true</span>;
<a name="l00448"></a>00448                         alarm_update = <span class="keyword">true</span>;
<a name="l00449"></a>00449                         alarm_bitmap = &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>];
<a name="l00450"></a>00450                 }
<a name="l00451"></a>00451                 level = <a class="code" href="group__apps__tank__group.html#gaf441238943296076659931176d606125" title="Maximum level of tank.">VALUE_LEVEL_MAXIMUM</a>;
<a name="l00452"></a>00452         } <span class="keywordflow">else</span> {
<a name="l00453"></a>00453                 <span class="keywordflow">if</span> (tank_ctx-&gt;<a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a>) {
<a name="l00454"></a>00454                         tank_ctx-&gt;<a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a> = <span class="keyword">false</span>;
<a name="l00455"></a>00455                         alarm_update = <span class="keyword">true</span>;
<a name="l00456"></a>00456                         alarm_bitmap = &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>];
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459         <a class="code" href="group__gfx__wtk__progress__bar.html#ga36d595cfd3afc89055a8033c43b5b54a" title="Set new progress bar value.">wtk_progress_bar_set_value</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#acc91a428c412cf2afeb28ea2c01dfd75" title="Pointer to progress bar widget for tank level.">level</a>, level);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         <span class="comment">/* If a level alarm update occurred, set up clipping area and draw</span>
<a name="l00462"></a>00462 <span class="comment">         * the new alarm light bitmap.</span>
<a name="l00463"></a>00463 <span class="comment">         */</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (alarm_update) {
<a name="l00465"></a>00465 <span class="preprocessor">#ifdef CONFIG_GFX_USE_CLIPPING</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>                <a class="code" href="group__gfx__gfx.html#gae49753292f3bea04f21414bb2e505b7e" title="Set the clipping region.">gfx_set_clipping</a>(<a class="code" href="group__apps__tank__group.html#ga1b49ae7c221c57daa9930d950b0fb1db" title="X coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_X</a>,
<a name="l00467"></a>00467                                 <a class="code" href="group__apps__tank__group.html#ga7560cecfe5009db21cbc7408b9382c57" title="Y coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_Y</a>,
<a name="l00468"></a>00468                                 <a class="code" href="group__apps__tank__group.html#ga1b49ae7c221c57daa9930d950b0fb1db" title="X coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_X</a>
<a name="l00469"></a>00469                                         + <a class="code" href="group__apps__tank__group.html#ga1e32b475f3c1164ebfbfc653fff1a1e9" title="Width of alarm light bitmap.">BITMAP_LIGHT_SIZE_X</a> - 1,
<a name="l00470"></a>00470                                 <a class="code" href="group__apps__tank__group.html#ga7560cecfe5009db21cbc7408b9382c57" title="Y coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_Y</a>
<a name="l00471"></a>00471                                         + <a class="code" href="group__apps__tank__group.html#ga13096596ae0459eee44ed97a46df8e90" title="Height of alarm light bitmap.">BITMAP_LIGHT_SIZE_Y</a> - 1
<a name="l00472"></a>00472                                 );
<a name="l00473"></a>00473 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_GFX_USE_CLIPPING */</span>
<a name="l00474"></a>00474                 <a class="code" href="group__gfx__gfx.html#ga3816207e8aec5fd4c885e2f7e327d961" title="Draw a bitmap.">gfx_draw_bitmap</a>(alarm_bitmap,
<a name="l00475"></a>00475                                 <a class="code" href="group__apps__tank__group.html#ga1b49ae7c221c57daa9930d950b0fb1db" title="X coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_X</a>,
<a name="l00476"></a>00476                                 <a class="code" href="group__apps__tank__group.html#ga7560cecfe5009db21cbc7408b9382c57" title="Y coordinate of alarm light bitmap.">BITMAP_LIGHT_POSITION_Y</a>);
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00488"></a><a class="code" href="group__apps__tank__group.html#ga32d46064a29ac6910ab002cf80216028">00488</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__apps__tank__group.html#ga32d46064a29ac6910ab002cf80216028" title="Application timer callback function.">tank_timer_callback</a>(<span class="keyword">struct</span> <a class="code" href="structtimer.html" title="Timer data.">timer</a> *<a class="code" href="structtimer.html" title="Timer data.">timer</a>)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490         <a class="code" href="group__timer__group.html#ga99bcf5cf0bc4c7eda6af86fdf5b6c65e" title="Set timer alarm.">timer_set_alarm</a>(CONFIG_TIMER_ID, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2" title="Timer struct needed for the timer driver.">timer</a>,
<a name="l00491"></a>00491                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a2222308c6354e52b1e9c93eae57d300b" title="Timer delay needed for application tick rate.">timer_delay</a>);
<a name="l00492"></a>00492         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, tank_ctx-&gt;<a class="code" href="structtank__context.html#a04484bd9c748dd821153a410fd3cb3b6" title="Pointer to the workqueue task of the application.">task</a>);
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00506"></a><a class="code" href="group__apps__tank__group.html#ga4b4d4bc2bb99c43381b8b7ce72146cce">00506</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__apps__tank__group.html#ga4b4d4bc2bb99c43381b8b7ce72146cce" title="Application loader.">tank_loader</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508         <span class="keyword">enum</span> <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151">status_code</a>    result;
<a name="l00509"></a>00509         <a class="code" href="group__hugemem__group.html#gad1f5b6899e22cd9bc4787ad502314968" title="Type to use for pointers to huge memory.">hugemem_ptr_t</a>       bitmap_data;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="comment">/* Handle the individual bitmap load states.</span>
<a name="l00512"></a>00512 <span class="comment">         *</span>
<a name="l00513"></a>00513 <span class="comment">         * All states, except LOAD_FINISHED, will cause the current workqueue</span>
<a name="l00514"></a>00514 <span class="comment">         * task to be re-enqueued after loading of the corresponding bitmap has</span>
<a name="l00515"></a>00515 <span class="comment">         * completed. This task worker will thus go through the states in</span>
<a name="l00516"></a>00516 <span class="comment">         * sequence.</span>
<a name="l00517"></a>00517 <span class="comment">         */</span>
<a name="l00518"></a>00518         <span class="keywordflow">switch</span> (tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a>) {
<a name="l00519"></a>00519         <span class="keywordflow">case</span> <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415bafcee5fbb65b7383c8ec0d90ddbae4d60" title="Red alarm light bitmap will be loaded to hugemem.">LOAD_RED_LIGHT</a>:
<a name="l00520"></a>00520                 <span class="comment">// Enqueue loading of the red alarm light bitmap.</span>
<a name="l00521"></a>00521                 bitmap_data = <a class="code" href="group__appsutil__fileloader__group.html#ga59f1795314559770cbb9868dab8b0789" title="Allocate space in hugemem and load an image into it.">load_file_to_hugemem</a>(<a class="code" href="group__apps__tank__group.html#gaa8af4926612d09c2857f08a784d5ad95" title="Filename of red alarm light bitmap.">BITMAP_RED_LIGHT_FILENAME</a>,
<a name="l00522"></a>00522                                 task);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524                 <span class="comment">/* If memory could be allocated for the bitmap, update the</span>
<a name="l00525"></a>00525 <span class="comment">                 * pointer in the bitmap metadata and set next load state.</span>
<a name="l00526"></a>00526 <span class="comment">                 * Otherwise, exit the application load error.</span>
<a name="l00527"></a>00527 <span class="comment">                 */</span>
<a name="l00528"></a>00528                 <span class="keywordflow">if</span> (bitmap_data != <a class="code" href="group__hugemem__group.html#ga8dab999972d482f52b57f8c7d9d7e414" title="Hugemem null pointer, similar to NULL, but works across different platforms.">HUGEMEM_NULL</a>) {
<a name="l00529"></a>00529                         <a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>] = bitmap_data;
<a name="l00530"></a>00530                         tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>].data.hugemem =
<a name="l00531"></a>00531                                         bitmap_data;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a> = <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba45a2b5b0d4835d578fb221b792260c9f" title="Green alarm light bitmap will be loaded to hugemem.">LOAD_GREEN_LIGHT</a>;
<a name="l00534"></a>00534                 } <span class="keywordflow">else</span> {
<a name="l00535"></a>00535                         <span class="keywordflow">goto</span> exit_load_error;
<a name="l00536"></a>00536                 }
<a name="l00537"></a>00537                 <span class="keywordflow">break</span>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         <span class="keywordflow">case</span> <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba45a2b5b0d4835d578fb221b792260c9f" title="Green alarm light bitmap will be loaded to hugemem.">LOAD_GREEN_LIGHT</a>:
<a name="l00540"></a>00540                 bitmap_data = <a class="code" href="group__appsutil__fileloader__group.html#ga59f1795314559770cbb9868dab8b0789" title="Allocate space in hugemem and load an image into it.">load_file_to_hugemem</a>(<a class="code" href="group__apps__tank__group.html#ga235a10b5f5cebb8dd369378facdc60a5" title="Filename of green alarm light bitmap.">BITMAP_GREEN_LIGHT_FILENAME</a>,
<a name="l00541"></a>00541                                 task);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                 <span class="keywordflow">if</span> (bitmap_data != <a class="code" href="group__hugemem__group.html#ga8dab999972d482f52b57f8c7d9d7e414" title="Hugemem null pointer, similar to NULL, but works across different platforms.">HUGEMEM_NULL</a>) {
<a name="l00544"></a>00544                         <a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>] = bitmap_data;
<a name="l00545"></a>00545                         tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>].data.hugemem
<a name="l00546"></a>00546                                         = bitmap_data;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a> = <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba6ddfc4348b67e07b146d131fbefe1262" title="Background bitmap will be shown.">LOAD_BACKGROUND</a>;
<a name="l00549"></a>00549                 } <span class="keywordflow">else</span> {
<a name="l00550"></a>00550                         <span class="keywordflow">goto</span> exit_load_error;
<a name="l00551"></a>00551                 }
<a name="l00552"></a>00552                 <span class="keywordflow">break</span>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="keywordflow">case</span> <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba6ddfc4348b67e07b146d131fbefe1262" title="Background bitmap will be shown.">LOAD_BACKGROUND</a>:
<a name="l00555"></a>00555                 <span class="comment">// Now load the background image.</span>
<a name="l00556"></a>00556                 result = <a class="code" href="group__appsutil__fileloader__group.html#gac9ce98d283b3435ab545a59efd9439f1" title="Load file data directly to screen.">load_file_to_screen</a>(<a class="code" href="group__apps__tank__group.html#gad1fc80ba02d339b52460ae7a3d7bdafc" title="Filename of background bitmap.">BITMAP_BACKGROUND_FILENAME</a>,
<a name="l00557"></a>00557                                 <a class="code" href="group__apps__tank__group.html#ga25776f547b170688b1c42913ad1656c0" title="X coordinate of background bitmap.">BITMAP_BACKGROUND_POSITION_X</a>,
<a name="l00558"></a>00558                                 <a class="code" href="group__apps__tank__group.html#gab4dea6e2d3dd1c192ff7c45cffe081b5" title="Y coordinate of background bitmap.">BITMAP_BACKGROUND_POSITION_Y</a>,
<a name="l00559"></a>00559                                 <a class="code" href="group__apps__tank__group.html#ga40631618718869c60ee1bdf55f77e5f0" title="Width of background bitmap.">BITMAP_BACKGROUND_SIZE_X</a>,
<a name="l00560"></a>00560                                 <a class="code" href="group__apps__tank__group.html#gab884dbcc70f60fed0444bc936f3f9b87" title="Height of background bitmap.">BITMAP_BACKGROUND_SIZE_Y</a>, task);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                 <span class="keywordflow">if</span> (result == <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>) {
<a name="l00563"></a>00563                         tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a> = <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415badf18c9dec2b78395e76466e99987be8f" title="The application&amp;#39;s widgets will be shown, and its timer started.">LOAD_FINISHED</a>;
<a name="l00564"></a>00564                 } <span class="keywordflow">else</span> {
<a name="l00565"></a>00565                         <span class="keywordflow">goto</span> exit_load_error;
<a name="l00566"></a>00566                 }
<a name="l00567"></a>00567                 <span class="keywordflow">break</span>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="keywordflow">case</span> <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415badf18c9dec2b78395e76466e99987be8f" title="The application&amp;#39;s widgets will be shown, and its timer started.">LOAD_FINISHED</a>:
<a name="l00570"></a>00570                 <span class="comment">// Now show the application&#39;s frame. This will draw all widgets.</span>
<a name="l00571"></a>00571                 <a class="code" href="group__gfx__win.html#gacf174cc778747a982b36cbe05e0d247d" title="Show window. Will draw it on screen if parent is visible as well.">win_show</a>(<a class="code" href="group__gfx__wtk__basic__frame.html#ga288ea10860d82def003800b19222ab0c" title="Get reference to basic frame window.">wtk_basic_frame_as_child</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50" title="Pointer to the main frame of the application.">frame</a>));
<a name="l00572"></a>00572 
<a name="l00573"></a>00573                 <span class="comment">// Set the worker function that updates the application.</span>
<a name="l00574"></a>00574                 <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(task, <a class="code" href="group__apps__tank__group.html#ga333ec630fa3dbb2bd9fb13dddde68321" title="Application worker function.">tank_worker</a>);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                 <span class="comment">// Set the timer alarm to trigger application updates.</span>
<a name="l00577"></a>00577                 <a class="code" href="group__timer__group.html#gab0f2bb4f901226817d72d06b683777eb" title="Start the timer.">timer_start</a>(CONFIG_TIMER_ID, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2" title="Timer struct needed for the timer driver.">timer</a>);
<a name="l00578"></a>00578                 <a class="code" href="group__timer__group.html#ga99bcf5cf0bc4c7eda6af86fdf5b6c65e" title="Set timer alarm.">timer_set_alarm</a>(CONFIG_TIMER_ID, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2" title="Timer struct needed for the timer driver.">timer</a>,
<a name="l00579"></a>00579                                 tank_ctx-&gt;<a class="code" href="structtank__context.html#a2222308c6354e52b1e9c93eae57d300b" title="Timer delay needed for application tick rate.">timer_delay</a>);
<a name="l00580"></a>00580                 <span class="keywordflow">break</span>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <span class="keywordflow">default</span>:
<a name="l00583"></a>00583                 <span class="comment">// Should not end up here.</span>
<a name="l00584"></a>00584                 <a class="code" href="group__assert__group.html#ga3ac92363f706f624b3ff8b5489f8af05" title="Assert that the case value will never need to be handled.">unhandled_case</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a>);
<a name="l00585"></a>00585                 <span class="keywordflow">break</span>;
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">return</span>;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="comment">// If a load error occurred, go back to the desktop.</span>
<a name="l00591"></a>00591 exit_load_error:
<a name="l00592"></a>00592         <a class="code" href="group__gfx__win.html#ga518fd778a7f6c3b7ae2e296e074e743f" title="Destroy a window and its contents including children, freeing up memory.">win_destroy</a>(<a class="code" href="group__gfx__wtk__basic__frame.html#ga288ea10860d82def003800b19222ab0c" title="Get reference to basic frame window.">wtk_basic_frame_as_child</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50" title="Pointer to the main frame of the application.">frame</a>));
<a name="l00593"></a>00593         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0" title="Copy of the sysfont before it is modified by the application.">old_sysfont</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a>));
<a name="l00594"></a>00594         <a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27" title="Free previously allocated memory.">membag_free</a>(tank_ctx);
<a name="l00595"></a>00595         tank_ctx = NULL;
<a name="l00596"></a>00596         <a class="code" href="group__app__desktop__group.html#ga3b0b29a4aaa11773cb5ccddedd80dab5" title="Restart desktop.">app_desktop_restart</a>();
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00618"></a><a class="code" href="group__apps__tank__group.html#ga7eda97a6fc540ab023d10588aa28732e">00618</a> <span class="keywordtype">void</span> <a class="code" href="group__apps__tank__group.html#ga7eda97a6fc540ab023d10588aa28732e" title="Launch the water tank application.">app_tank_launch</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620         <span class="keyword">struct </span><a class="code" href="structwin__attributes.html" title="Window attribute data.">win_attributes</a>    attr;
<a name="l00621"></a>00621         <span class="keyword">struct </span><a class="code" href="structwin__window.html" title="Window control data.">win_window</a>        *win;
<a name="l00622"></a>00622         <span class="keyword">struct </span><a class="code" href="structgfx__bitmap.html" title="Storage structure for bitmap pixel data and metadata.">gfx_bitmap</a>        bitmap;
<a name="l00623"></a>00623         <span class="keyword">struct </span><a class="code" href="structwtk__basic__frame.html" title="Basic frame control struct.">wtk_basic_frame</a>   *frame;
<a name="l00624"></a>00624         <span class="keyword">struct </span><a class="code" href="structwtk__slider.html" title="Slider control struct.">wtk_slider</a>        *slider;
<a name="l00625"></a>00625         <span class="keyword">struct </span><a class="code" href="structwtk__button.html">wtk_button</a>        *button;
<a name="l00626"></a>00626         <span class="keyword">struct </span><a class="code" href="structwtk__progress__bar.html" title="Progress bar control struct.">wtk_progress_bar</a>  *pbar;
<a name="l00627"></a>00627         <span class="keyword">struct </span><a class="code" href="structtimer.html" title="Timer data.">timer</a>             *<a class="code" href="structtimer.html" title="Timer data.">timer</a>;
<a name="l00628"></a>00628         <a class="code" href="group__timer__xmega__group.html#ga846389f68c68d6bc2f6344b16eb84165" title="Driver internal timer resolution type.">timer_res_t</a>              timer_res;
<a name="l00629"></a>00629         <a class="code" href="group__stdint__group.html#ga09a1e304d66d35dd47daffee9731edaa" title="32-bit unsigned integer">uint32_t</a>                 timer_clk;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(task);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">// Clear the screen right away.</span>
<a name="l00634"></a>00634 <span class="preprocessor">#ifdef CONFIG_GFX_USE_CLIPPING</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span>        <a class="code" href="group__gfx__gfx.html#gae49753292f3bea04f21414bb2e505b7e" title="Set the clipping region.">gfx_set_clipping</a>(0, 0, <a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>(), <a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>());
<a name="l00636"></a>00636 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_GFX_USE_CLIPPING */</span>
<a name="l00637"></a>00637         <a class="code" href="group__gfx__gfx.html#gac466c148896f0b12a313294560e3c10c" title="Draw a filled rectangle.">gfx_draw_filled_rect</a>(0, 0, <a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>(), <a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>(),
<a name="l00638"></a>00638                         <a class="code" href="group__apps__tank__group.html#gafd302b6035f5bc21566c805c131d3a4d" title="Color to initially fill screen with.">COLOR_WIN_BACKGROUND</a>);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="comment">// Allocate the application context first.</span>
<a name="l00641"></a>00641         tank_ctx = <a class="code" href="group__membag__group.html#gad2210e38b675715afcd6e1f154ba2ecd" title="Allocate memory.">membag_alloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtank__context.html" title="Context for the water tank application.">tank_context</a>));
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (!tank_ctx)
<a name="l00643"></a>00643                 <span class="keywordflow">goto</span> exit_no_context;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645         <span class="comment">// Use larger sysfont for this app.</span>
<a name="l00646"></a>00646         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0" title="Copy of the sysfont before it is modified by the application.">old_sysfont</a>, &amp;<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a>));
<a name="l00647"></a>00647         <a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>.<a class="code" href="structfont.html#a93930e293fe0c2a740da28bbd8f1a46d" title="Number of times characters are scaled up when being drawn.">scale</a> = 2;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         <span class="comment">// Create a basic frame to contain the widgets.</span>
<a name="l00650"></a>00650         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.x = 0;
<a name="l00651"></a>00651         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.y = 0;
<a name="l00652"></a>00652         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.x = <a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>();
<a name="l00653"></a>00653         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.y = <a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>();
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         frame = <a class="code" href="group__gfx__wtk__basic__frame.html#ga2ef82bf721f8db8440ef4bdaa5e9a982" title="Create basic frame widget.">wtk_basic_frame_create</a>(<a class="code" href="group__gfx__win.html#gabb0c95ee3810418e2dff2264aac277fa" title="Get pointer to root window, i.e. desktop window.">win_get_root</a>(), &amp;attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>, NULL,
<a name="l00656"></a>00656                         NULL, <a class="code" href="group__apps__tank__group.html#ga055a10b82bfea70f9f4d029ff5252d58" title="Command event handler for the application&amp;#39;s frame.">tank_frame_handler</a>, NULL);
<a name="l00657"></a>00657         <span class="keywordflow">if</span> (!frame) {
<a name="l00658"></a>00658                 <span class="keywordflow">goto</span> exit_no_frame;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         tank_ctx-&gt;<a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50" title="Pointer to the main frame of the application.">frame</a> = frame;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="comment">// Get the frame&#39;s window to use as parent for widgets.</span>
<a name="l00663"></a>00663         win = <a class="code" href="group__gfx__wtk__basic__frame.html#ga288ea10860d82def003800b19222ab0c" title="Get reference to basic frame window.">wtk_basic_frame_as_child</a>(frame);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665         <span class="comment">// Initialize the application timer.</span>
<a name="l00666"></a>00666         timer = &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a62ffa445f1dca18bc5f41e3b9a1009f2" title="Timer struct needed for the timer driver.">timer</a>;
<a name="l00667"></a>00667         <a class="code" href="group__timer__group.html#ga258c7ae0c4f9ffb72ca8dd28d34e78d1" title="Timer initialization.">timer_init</a>(CONFIG_TIMER_ID, timer, <a class="code" href="group__apps__tank__group.html#ga32d46064a29ac6910ab002cf80216028" title="Application timer callback function.">tank_timer_callback</a>);
<a name="l00668"></a>00668         timer_res = <a class="code" href="group__timer__group.html#gad5e3c0958bdd6c47513a9751ad340bbc" title="Generate a timer resolution configuration.">timer_set_resolution</a>(CONFIG_TIMER_ID, timer,
<a name="l00669"></a>00669                         <a class="code" href="group__apps__tank__group.html#gaf4021b95b18dc511ba274a310fe66d08" title="Application tick rate.">TICK_RATE</a>);
<a name="l00670"></a>00670         <a class="code" href="group__timer__group.html#ga9b6dab6d3c270cfa7a19fab34e6e121a" title="Set a timer resolution.">timer_write_resolution</a>(CONFIG_TIMER_ID, timer, timer_res);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="comment">// Get the timer alarm delay to use for the configured tick rate.</span>
<a name="l00673"></a>00673         timer_clk = <a class="code" href="group__timer__group.html#ga21f6055136e82c90855ec5b3cb2e7ba1" title="Convert the timer resolution configuration to ticks per second.">timer_get_resolution</a>(CONFIG_TIMER_ID, timer, timer_res);
<a name="l00674"></a>00674         tank_ctx-&gt;<a class="code" href="structtank__context.html#a2222308c6354e52b1e9c93eae57d300b" title="Timer delay needed for application tick rate.">timer_delay</a> = timer_clk / <a class="code" href="group__apps__tank__group.html#gaf4021b95b18dc511ba274a310fe66d08" title="Application tick rate.">TICK_RATE</a>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <span class="comment">// Initialize random variable and tick count.</span>
<a name="l00677"></a>00677         tank_ctx-&gt;<a class="code" href="structtank__context.html#af071e2372aa8fd8b85f45ecafbb0fef0" title="Random variable to get time-varying water demand.">rand</a> = 1;
<a name="l00678"></a>00678         tank_ctx-&gt;<a class="code" href="structtank__context.html#a4c9affa8e08787d8871d4a6b9a425d00" title="Tick count until update of random variable.">rand_ticks</a> = <a class="code" href="group__apps__tank__group.html#gaf7d2a374ba8e1f467684f6af15307204" title="Application ticks between each update of random variable.">TICKS_PER_RANDOM_UPDATE</a>;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="comment">// Create the supply slider.</span>
<a name="l00681"></a>00681         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.x = <a class="code" href="group__apps__tank__group.html#ga6d894a03c8a7b2f2fa2f84b5bf7f0e66" title="X coordinate of slider for supply.">WIDGET_SUPPLY_POSITION_X</a>;
<a name="l00682"></a>00682         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.y = <a class="code" href="group__apps__tank__group.html#gafea33d6d75ec1f26c3bb57f0abdbb23d" title="Y coordinate of slider for supply.">WIDGET_SUPPLY_POSITION_Y</a>;
<a name="l00683"></a>00683         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.x = <a class="code" href="group__apps__tank__group.html#gacb68259d194d48b58edcbf4f52e2a8c0" title="Height of slider for supply.">WIDGET_SUPPLY_SIZE_X</a>;
<a name="l00684"></a>00684         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.y = <a class="code" href="group__apps__tank__group.html#gab529fb56b5e762d9a3ad7d9d658e74a4" title="Width of slider for supply.">WIDGET_SUPPLY_SIZE_Y</a>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         slider = <a class="code" href="group__gfx__wtk__slider.html#ga9e568e682198071b0ed1d0baba6d24d3" title="Create a new slider widget.">wtk_slider_create</a>(win, &amp;attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>, <a class="code" href="group__apps__tank__group.html#gae36894d97b2a2b23eb8e0945bf338ea8" title="Maximum value of supply.">VALUE_SUPPLY_MAXIMUM</a>,
<a name="l00687"></a>00687                         <a class="code" href="group__apps__tank__group.html#ga1fee1cdf8bc28ab1bfbef86344f796b6" title="Initial value of supply.">VALUE_SUPPLY_INITIAL</a>, <a class="code" href="group__gfx__wtk__slider__options.html#gad8beb09fb293768c3ec0466683751e6b" title="Slider is vertically oriented.">WTK_SLIDER_VERTICAL</a> |
<a name="l00688"></a>00688                                         <a class="code" href="group__gfx__wtk__slider__options.html#ga1b1590b78df6ab7cf3145d14803b6229" title="Slider value is inverted.">WTK_SLIDER_INVERT</a>, <a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea93c1ce1fac89139d9f4df4b6db21b1cc" title="Command event value to use for supply-slider.">CMD_NONE</a>);
<a name="l00689"></a>00689         <span class="keywordflow">if</span> (!slider) {
<a name="l00690"></a>00690                 <span class="keywordflow">goto</span> exit_no_widget;
<a name="l00691"></a>00691         }
<a name="l00692"></a>00692         tank_ctx-&gt;<a class="code" href="structtank__context.html#a6ebf2dd95b3c57f2a7fe1386e2f978ec" title="Pointer to slider widget for supply.">supply</a> = slider;
<a name="l00693"></a>00693         <a class="code" href="group__gfx__win.html#gacf174cc778747a982b36cbe05e0d247d" title="Show window. Will draw it on screen if parent is visible as well.">win_show</a>(<a class="code" href="group__gfx__wtk__slider.html#ga7955edfc3a1e4fd85e155949189a9c35" title="Get pointer to slider window.">wtk_slider_as_child</a>(slider));
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         <span class="comment">// Create the tank level progress bar.</span>
<a name="l00696"></a>00696         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.x = <a class="code" href="group__apps__tank__group.html#gaaf7b13894f0872ef96a94b110269d2dd" title="X coordinate of progress bar for tank level.">WIDGET_LEVEL_POSITION_X</a>;
<a name="l00697"></a>00697         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.y = <a class="code" href="group__apps__tank__group.html#gaad2f85c8a07383886d98430ac5590bdd" title="Y coordinate of progress bar for tank level.">WIDGET_LEVEL_POSITION_Y</a>;
<a name="l00698"></a>00698         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.x = <a class="code" href="group__apps__tank__group.html#ga4e417160b7d37901dc8d3c9271dfc2a6" title="Height of progress bar for tank level.">WIDGET_LEVEL_SIZE_X</a>;
<a name="l00699"></a>00699         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.y = <a class="code" href="group__apps__tank__group.html#ga9bfd544726b998104038cf026677a731" title="Width of progress bar for tank level.">WIDGET_LEVEL_SIZE_Y</a>;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         pbar = <a class="code" href="group__gfx__wtk__progress__bar.html#ga3b925edcf34ed73651f04299a8cd0df2" title="Create a new progress bar widget.">wtk_progress_bar_create</a>(win, &amp;attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>, <a class="code" href="group__apps__tank__group.html#gaf441238943296076659931176d606125" title="Maximum level of tank.">VALUE_LEVEL_MAXIMUM</a>,
<a name="l00702"></a>00702                         <a class="code" href="group__apps__tank__group.html#gaf4de491885c74588f7b5dc6e0c2fd79c" title="Initial level of tank.">VALUE_LEVEL_INITIAL</a>, <a class="code" href="group__apps__tank__group.html#ga07fd9d8f4c8ec6b8c48b37c3a1b4141c" title="Fill color for tank level indicator.">COLOR_LEVEL_FILL</a>,
<a name="l00703"></a>00703                         <a class="code" href="group__apps__tank__group.html#gabe26b649868b497cb8a6ad0eb3dec3c0" title="Background color for tank level indicator.">COLOR_LEVEL_BACKGROUND</a>, <a class="code" href="group__gfx__wtk__progress__bar__options.html#ga2f2862c6b095d5faef54c37ec7be18c5" title="Progress bar is vertically oriented.">WTK_PROGRESS_BAR_VERTICAL</a> |
<a name="l00704"></a>00704                                         <a class="code" href="group__gfx__wtk__progress__bar__options.html#ga00d31cbef5aa0333e3f9373967ce6a01" title="Progress bar is inverted.">WTK_PROGRESS_BAR_INVERT</a>);
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (!pbar) {
<a name="l00706"></a>00706                 <span class="keywordflow">goto</span> exit_no_widget;
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708         tank_ctx-&gt;<a class="code" href="structtank__context.html#acc91a428c412cf2afeb28ea2c01dfd75" title="Pointer to progress bar widget for tank level.">level</a> = pbar;
<a name="l00709"></a>00709         <a class="code" href="group__gfx__win.html#gacf174cc778747a982b36cbe05e0d247d" title="Show window. Will draw it on screen if parent is visible as well.">win_show</a>(<a class="code" href="group__gfx__wtk__progress__bar.html#gafcf4eb0256b04636cec97f7b084371fd" title="Get pointer to progress bar window.">wtk_progress_bar_as_child</a>(pbar));
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="comment">// Create the demand progress bar.</span>
<a name="l00712"></a>00712         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.x = <a class="code" href="group__apps__tank__group.html#ga4d61f2a8b0f57934bcebb72ad736d6c7" title="X coordinate of progress bar for demand indication.">WIDGET_DEMAND_POSITION_X</a>;
<a name="l00713"></a>00713         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.y = <a class="code" href="group__apps__tank__group.html#gacea06d037d26b33ddb37680b9d5742c5" title="Y coordinator of progress bar for demand indication.">WIDGET_DEMAND_POSITION_Y</a>;
<a name="l00714"></a>00714         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.x = <a class="code" href="group__apps__tank__group.html#ga02f8b128a5d4fba1977873548d63a7a3" title="Height of progress bar for demand indication.">WIDGET_DEMAND_SIZE_X</a>;
<a name="l00715"></a>00715         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.y = <a class="code" href="group__apps__tank__group.html#gafbd239e7ea8d3a5252392b7514b975ea" title="Width of progress bar for demand indication.">WIDGET_DEMAND_SIZE_Y</a>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         pbar = <a class="code" href="group__gfx__wtk__progress__bar.html#ga3b925edcf34ed73651f04299a8cd0df2" title="Create a new progress bar widget.">wtk_progress_bar_create</a>(win, &amp;attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>, <a class="code" href="group__apps__tank__group.html#ga53d3eb9ad5638506ecc190a2412c8851" title="Maximum value of demand.">VALUE_DEMAND_MAXIMUM</a>,
<a name="l00718"></a>00718                         <a class="code" href="group__apps__tank__group.html#gab26081646d7a02b13135bd110d732e35" title="Initial value of demand.">VALUE_DEMAND_INITIAL</a>, <a class="code" href="group__apps__tank__group.html#gaea4b3d4651065f33a8f91d21e6719611" title="Normal fill color for demand indicator.">COLOR_DEMAND_NORMAL</a>,
<a name="l00719"></a>00719                         <a class="code" href="group__apps__tank__group.html#gaf834ed1f96c77cac6e7eb784862c4169" title="Background color for demand indicator.">COLOR_DEMAND_BACKGROUND</a>, <a class="code" href="group__gfx__wtk__progress__bar__options.html#ga2f2862c6b095d5faef54c37ec7be18c5" title="Progress bar is vertically oriented.">WTK_PROGRESS_BAR_VERTICAL</a> |
<a name="l00720"></a>00720                                         <a class="code" href="group__gfx__wtk__progress__bar__options.html#ga00d31cbef5aa0333e3f9373967ce6a01" title="Progress bar is inverted.">WTK_PROGRESS_BAR_INVERT</a>);
<a name="l00721"></a>00721         <span class="keywordflow">if</span> (!pbar) {
<a name="l00722"></a>00722                 <span class="keywordflow">goto</span> exit_no_widget;
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         tank_ctx-&gt;<a class="code" href="structtank__context.html#a8d5a665aa8d7dd91299b90f6c8044cad" title="Pointer to progress bar widget for demand.">demand</a> = pbar;
<a name="l00725"></a>00725         <a class="code" href="group__gfx__win.html#gacf174cc778747a982b36cbe05e0d247d" title="Show window. Will draw it on screen if parent is visible as well.">win_show</a>(<a class="code" href="group__gfx__wtk__progress__bar.html#gafcf4eb0256b04636cec97f7b084371fd" title="Get pointer to progress bar window.">wtk_progress_bar_as_child</a>(pbar));
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         <span class="comment">// Create the exit button with the standard settings.</span>
<a name="l00728"></a>00728         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.x = <a class="code" href="group__app__desktop__group.html#ga5bbdd8d99101726755ec0409b134c2a3" title="Common application exit button position.">APP_EXIT_BUTTON_POS_X</a>;
<a name="l00729"></a>00729         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#a69c7b4744c2bd3c7135847feb9ee5504" title="Top-left corner of area.">pos</a>.y = <a class="code" href="group__app__desktop__group.html#gacb8ee3f83aa45ade6b1a42e4fa3cdf3e" title="Common application exit button position.">APP_EXIT_BUTTON_POS_Y</a>;
<a name="l00730"></a>00730         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.x = <a class="code" href="group__app__desktop__group.html#ga143dc232ad4bf9b5f0a1abab1807dae9" title="Common application exit button size.">APP_EXIT_BUTTON_SIZE_X</a>;
<a name="l00731"></a>00731         attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>.<a class="code" href="structwin__area.html#afb961948c18ea282b2c4ea2d06542540" title="Width and height of area.">size</a>.y = <a class="code" href="group__app__desktop__group.html#gad91551723f80d14a01e432a0573977f4" title="Common application exit button size.">APP_EXIT_BUTTON_SIZE_Y</a>;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         button = <a class="code" href="group__gfx__wtk__button.html#gaebe80c65856294eab28bb29264e2bd64">wtk_button_create</a>(win, &amp;attr.<a class="code" href="structwin__attributes.html#a37c5f9ad4e8f35c8817cdccd321cb4a7" title="Position and size of window, relative to parent.">area</a>, <a class="code" href="group__app__desktop__group.html#gafbd2c3cda74c4c7efee584275f4ca26e" title="Common application exit button text.">APP_EXIT_BUTTON_TEXT</a>,
<a name="l00734"></a>00734                         (<a class="code" href="group__gfx__win.html#ga53f0ed533fce454af67e765764d7eb5f" title="Custom data, can be used as a data pointer or data depending on the application.">win_command_t</a>)<a class="code" href="group__apps__tank__group.html#gga9c67ad111c5d786be5639fc2d489aa2ea423988140dabaa461f133924ca772294" title="Command event value to use for exit-button.">CMD_EXIT</a>);
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (!button) {
<a name="l00736"></a>00736                 <span class="keywordflow">goto</span> exit_no_widget;
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738         <a class="code" href="group__gfx__win.html#gacf174cc778747a982b36cbe05e0d247d" title="Show window. Will draw it on screen if parent is visible as well.">win_show</a>(<a class="code" href="group__gfx__wtk__button.html#ga5fc0cc848622a1e21f00648be089ae63">wtk_button_as_child</a>(button));
<a name="l00739"></a>00739 
<a name="l00740"></a>00740         <span class="comment">// Set the tank alarm to trigger initial drawing of alarm light.</span>
<a name="l00741"></a>00741         tank_ctx-&gt;<a class="code" href="structtank__context.html#ac3b8dd9ef77ec0bbccefdf2943e0f3ea" title="Flag indicating critical tank level.">level_alarm</a> = <span class="keyword">true</span>;
<a name="l00742"></a>00742         tank_ctx-&gt;<a class="code" href="structtank__context.html#a010b1022af76b54e3b26a7dd5b5c9dea" title="Flag indicating that demand is greater than supply and tank level.">flow_alarm</a> = <span class="keyword">false</span>;
<a name="l00743"></a>00743         tank_ctx-&gt;<a class="code" href="structtank__context.html#a04484bd9c748dd821153a410fd3cb3b6" title="Pointer to the workqueue task of the application.">task</a> = task;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         <span class="comment">/* Initialize bitmap data and set initial application loader state:</span>
<a name="l00746"></a>00746 <span class="comment">         * If the alarm light bitmaps have already been loaded, skip right to</span>
<a name="l00747"></a>00747 <span class="comment">         * loading of the application background bitmap.</span>
<a name="l00748"></a>00748 <span class="comment">         */</span>
<a name="l00749"></a>00749         bitmap.<a class="code" href="structgfx__bitmap.html#a0bdace1fc681832ef145540ce83c13a4" title="Width of bitmap.">width</a> = <a class="code" href="group__apps__tank__group.html#ga1e32b475f3c1164ebfbfc653fff1a1e9" title="Width of alarm light bitmap.">BITMAP_LIGHT_SIZE_X</a>;
<a name="l00750"></a>00750         bitmap.<a class="code" href="structgfx__bitmap.html#a879382a145ebb64bbeb4fac9ba6127e4" title="Height of bitmap.">height</a> = <a class="code" href="group__apps__tank__group.html#ga13096596ae0459eee44ed97a46df8e90" title="Height of alarm light bitmap.">BITMAP_LIGHT_SIZE_Y</a>;
<a name="l00751"></a>00751         bitmap.<a class="code" href="structgfx__bitmap.html#a25e3747161bb4053f91cbaab6bdc216d" title="Bitmap type.">type</a> = BITMAP_HUGEMEM;
<a name="l00752"></a>00752         tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>] = bitmap;
<a name="l00753"></a>00753         tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>] = bitmap;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (<a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146ab441aa813e68492572287be353d2feba" title="ID and index of bitmap for green alarm light.">BITMAP_GREEN_LIGHT</a>]) {
<a name="l00756"></a>00756                 tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a> = <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415ba6ddfc4348b67e07b146d131fbefe1262" title="Background bitmap will be shown.">LOAD_BACKGROUND</a>;
<a name="l00757"></a>00757                 tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>].data.hugemem =
<a name="l00758"></a>00758                                 <a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[<a class="code" href="group__apps__tank__group.html#gga25e6e4a67f94320d9984a34119dec146a886a33c980cf655bb87db0f79743f232" title="ID and index of bitmap for red alarm light.">BITMAP_RED_LIGHT</a>];
<a name="l00759"></a>00759                 tank_ctx-&gt;<a class="code" href="structtank__context.html#ae381ea7040159c2d184175edba51d3c2" title="Metadata for alarm light bitmaps.">bitmaps</a>[BITMAP_GREEN_LIGHT].data.hugemem =
<a name="l00760"></a>00760                                 <a class="code" href="group__apps__tank__group.html#ga9250b563cfe151176f448c4b6de63d22" title="Pointers to bitmap data in hugemem.">tank_bitmap_data</a>[BITMAP_GREEN_LIGHT];
<a name="l00761"></a>00761         } <span class="keywordflow">else</span> {
<a name="l00762"></a>00762                 tank_ctx-&gt;<a class="code" href="structtank__context.html#a48499404483e362c33a2b445577f6cf2" title="State variable for application loader task.">loader_state</a> = <a class="code" href="group__apps__tank__group.html#gga454060f2b9c2a7f895443e4e67b0415bafcee5fbb65b7383c8ec0d90ddbae4d60" title="Red alarm light bitmap will be loaded to hugemem.">LOAD_RED_LIGHT</a>;
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764         <a class="code" href="group__workqueue__group.html#ga3e86382d7bdc644fbc706e7d1ad1ce2d" title="Change the worker function of a task.">workqueue_task_set_work_func</a>(task, <a class="code" href="group__apps__tank__group.html#ga4b4d4bc2bb99c43381b8b7ce72146cce" title="Application loader.">tank_loader</a>);
<a name="l00765"></a>00765         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, task);
<a name="l00766"></a>00766         <span class="keywordflow">return</span>;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         <span class="comment">// Handle allocation errors.</span>
<a name="l00769"></a>00769 exit_no_widget:
<a name="l00770"></a>00770         <a class="code" href="group__gfx__win.html#ga518fd778a7f6c3b7ae2e296e074e743f" title="Destroy a window and its contents including children, freeing up memory.">win_destroy</a>(<a class="code" href="group__gfx__wtk__basic__frame.html#ga288ea10860d82def003800b19222ab0c" title="Get reference to basic frame window.">wtk_basic_frame_as_child</a>(tank_ctx-&gt;<a class="code" href="structtank__context.html#acd40d2ac9dc0488fb6e5bb2b52cfaf50" title="Pointer to the main frame of the application.">frame</a>));
<a name="l00771"></a>00771 exit_no_frame:
<a name="l00772"></a>00772         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>, &amp;tank_ctx-&gt;<a class="code" href="structtank__context.html#a0f2f1def01693ce2225f03f4c1777de0" title="Copy of the sysfont before it is modified by the application.">old_sysfont</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a>));
<a name="l00773"></a>00773         <a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27" title="Free previously allocated memory.">membag_free</a>(tank_ctx);
<a name="l00774"></a>00774 exit_no_context:
<a name="l00775"></a>00775         <a class="code" href="group__app__desktop__group.html#ga3b0b29a4aaa11773cb5ccddedd80dab5" title="Restart desktop.">app_desktop_restart</a>();
<a name="l00776"></a>00776         <span class="keywordflow">return</span>;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Apr 29 14:09:58 2010 for display-demo by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
