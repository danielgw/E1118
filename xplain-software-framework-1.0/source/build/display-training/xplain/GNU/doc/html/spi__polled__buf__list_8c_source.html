<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: drivers/serial/spi/spi_polled_buf_list.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">display-training</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>drivers/serial/spi/spi_polled_buf_list.c</h1>  </div>
</div>
<div class="contents">
<a href="spi__polled__buf__list_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;bitops.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;spi.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;board/spi.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00053"></a><a class="code" href="group__spi__polled__internal__group.html#gac18fa62ed1f8577a5b45e239f73dd37d">00053</a> <span class="keywordtype">void</span> <a class="code" href="group__spi__polled__internal__group.html#gac18fa62ed1f8577a5b45e239f73dd37d" title="Iterate to next buffer in SPI buffer list operation.">spi_polled_next_buffer</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055         <span class="keyword">struct </span><a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a> *spim_poll =
<a name="l00056"></a>00056                 <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(task, <span class="keyword">struct</span> <a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a>, poll_next_buffer);
<a name="l00057"></a>00057         <span class="keyword">struct </span><a class="code" href="structspi__master.html" title="SPI master.">spi_master</a>        *spim = &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#af0f9e37bf21ce4531da11267a76327ed" title="Base spi_master.">base</a>;
<a name="l00058"></a>00058         <span class="keywordtype">size_t</span>                   len = 0;
<a name="l00059"></a>00059         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                  tx_byte = 0;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="keywordflow">if</span> (<a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a9f00d11e7d77bfc6716923d9f10bc63f" title="Read operation.">SPI_OP_READ</a>, &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags)">op</a>)) {
<a name="l00062"></a>00062                 <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#ace6a30ba9a5685bd2945653ce2afc58d" title="Determine if node is the last node in list.">slist_node_is_last</a>(spim_poll-&gt;read_buf_list,
<a name="l00063"></a>00063                                         &amp;spim_poll-&gt;read_buffer-&gt;node))
<a name="l00064"></a>00064                         <span class="keywordflow">goto</span> done;
<a name="l00065"></a>00065                 spim_poll-&gt;read_buffer =
<a name="l00066"></a>00066                         <a class="code" href="group__buffer__group.html#ga8439b1a668345115c12517872dbc1012" title="Return the buffer following buf in the list.">buf_list_peek_next</a>(spim_poll-&gt;read_buffer);
<a name="l00067"></a>00067                 spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a3f5db597b042b2fe66172b7add39cbe9" title="Current read data pointer.">read_data</a> = spim_poll-&gt;read_buffer-&gt;addr.ptr;
<a name="l00068"></a>00068                 len = spim_poll-&gt;read_buffer-&gt;len;
<a name="l00069"></a>00069         }
<a name="l00070"></a>00070         <span class="keywordflow">if</span> (<a class="code" href="group__bitops__group.html#gab6f6195f23a2985c9d6d1520e60ec3ad" title="Test bit nr in bitmap.">test_bit</a>(<a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a3cf63a98dcb6e6b1bf5c05cbce63ae36" title="Write operation.">SPI_OP_WRITE</a>, &amp;spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags)">op</a>)) {
<a name="l00071"></a>00071                 <span class="keywordflow">if</span> (<a class="code" href="slist_8h.html#ace6a30ba9a5685bd2945653ce2afc58d" title="Determine if node is the last node in list.">slist_node_is_last</a>(spim_poll-&gt;write_buf_list,
<a name="l00072"></a>00072                                         &amp;spim_poll-&gt;write_buffer-&gt;node))
<a name="l00073"></a>00073                         <span class="keywordflow">goto</span> done;
<a name="l00074"></a>00074                 spim_poll-&gt;write_buffer =
<a name="l00075"></a>00075                         <a class="code" href="group__buffer__group.html#ga8439b1a668345115c12517872dbc1012" title="Return the buffer following buf in the list.">buf_list_peek_next</a>(spim_poll-&gt;write_buffer);
<a name="l00076"></a>00076                 tx_byte = *(<a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> *)spim_poll-&gt;write_buffer-&gt;addr.ptr;
<a name="l00077"></a>00077                 spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a9fe8f30521218f1f3433f70acc5e69d1" title="Current write data pointer.">write_data</a> =
<a name="l00078"></a>00078                         (<a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> *)spim_poll-&gt;write_buffer-&gt;addr.ptr + 1;
<a name="l00079"></a>00079                 len = spim_poll-&gt;write_buffer-&gt;len;
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081         <a class="code" href="group__spi__polled__internal__group.html#ga17b2b593c9bce17153a2ca5293d10321" title="Start polled SPI transfer.">spi_polled_start</a>(spim, tx_byte, len);
<a name="l00082"></a>00082         <span class="keywordflow">return</span>;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 done:
<a name="l00085"></a>00085         spim-&gt;<a class="code" href="structspi__master.html#aa38b5c0c0431f0697bb3fd31e6325028" title="Number of bytes remaining.">residue</a> = 0;
<a name="l00086"></a>00086         spim-&gt;<a class="code" href="structspi__master.html#a42f99080ac3761deb56f95b35f40dd56" title="Status of last operation.">status</a> = <a class="code" href="status__codes_8h.html#a751c892e5a46b8e7d282085a5a5bf151a7e4a42e3b6dd63708c64cf3db6f69566" title="Success.">STATUS_OK</a>;
<a name="l00087"></a>00087         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, spim-&gt;<a class="code" href="structspi__master.html#a8cc961bbd42bacad8c29a30b4ade5b10" title="Nested workqueue for pending work.">nwq</a>.<a class="code" href="structnested__workqueue.html#a020bb30664c7a6d067da03cb6f938972" title="The currently running task.">current</a>);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00094"></a><a class="code" href="group__spi__polled__internal__group.html#ga3b272ca277292b2c98c81289b3f17f1d">00094</a> <span class="keywordtype">void</span> <a class="code" href="group__spi__polled__internal__group.html#ga3b272ca277292b2c98c81289b3f17f1d">spi_polled_write_buf_list</a>(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *spim, <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *buf_list)
<a name="l00095"></a>00095 {
<a name="l00096"></a>00096         <span class="keyword">struct </span><a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a> *spim_poll = <a class="code" href="group__spi__polled__internal__group.html#gaf0eed58d66bdc0afef8411c2093e4ddc" title="Return SPI master polled from SPI master.">spi_master_polled_of</a>(spim);
<a name="l00097"></a>00097         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>            *<a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>;
<a name="l00098"></a>00098         <span class="keyword">const</span> <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>            *write;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         buffer = <a class="code" href="group__buffer__group.html#ga0e091c061e88c6c38a6f92c1dd2b5671" title="Return the first buffer in list.">buf_list_peek_head</a>(buf_list);
<a name="l00101"></a>00101         write = buffer-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00102"></a>00102         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags)">op</a> = (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a3cf63a98dcb6e6b1bf5c05cbce63ae36" title="Write operation.">SPI_OP_WRITE</a>) | (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a99d87dd9a72ce38800a242d14b222650" title="buffer list operation">SPI_OP_BUFFER</a>);
<a name="l00103"></a>00103         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a9fe8f30521218f1f3433f70acc5e69d1" title="Current write data pointer.">write_data</a> = write + 1;
<a name="l00104"></a>00104         spim_poll-&gt;write_buffer = buffer;
<a name="l00105"></a>00105         spim_poll-&gt;write_buf_list = buf_list;
<a name="l00106"></a>00106         <a class="code" href="group__spi__polled__internal__group.html#ga17b2b593c9bce17153a2ca5293d10321" title="Start polled SPI transfer.">spi_polled_start</a>(spim, *write, buffer-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>);
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00113"></a><a class="code" href="group__spi__polled__internal__group.html#ga76c72ead3f948b525f99ae12e6cccdf3">00113</a> <span class="keywordtype">void</span> <a class="code" href="group__spi__polled__internal__group.html#ga76c72ead3f948b525f99ae12e6cccdf3">spi_polled_read_buf_list</a>(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *spim, <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *buf_list)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115         <span class="keyword">struct </span><a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a> *spim_poll = <a class="code" href="group__spi__polled__internal__group.html#gaf0eed58d66bdc0afef8411c2093e4ddc" title="Return SPI master polled from SPI master.">spi_master_polled_of</a>(spim);
<a name="l00116"></a>00116         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>            *<a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         buffer = <a class="code" href="group__buffer__group.html#ga0e091c061e88c6c38a6f92c1dd2b5671" title="Return the first buffer in list.">buf_list_peek_head</a>(buf_list);
<a name="l00119"></a>00119         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags)">op</a> = (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a9f00d11e7d77bfc6716923d9f10bc63f" title="Read operation.">SPI_OP_READ</a>) | (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a99d87dd9a72ce38800a242d14b222650" title="buffer list operation">SPI_OP_BUFFER</a>);
<a name="l00120"></a>00120         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a3f5db597b042b2fe66172b7add39cbe9" title="Current read data pointer.">read_data</a> = buffer-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00121"></a>00121         spim_poll-&gt;read_buffer = buffer;
<a name="l00122"></a>00122         spim_poll-&gt;read_buf_list = buf_list;
<a name="l00123"></a>00123         <a class="code" href="group__spi__polled__internal__group.html#ga17b2b593c9bce17153a2ca5293d10321" title="Start polled SPI transfer.">spi_polled_start</a>(spim, 0, buffer-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00130"></a><a class="code" href="group__spi__polled__internal__group.html#ga2279b032712b6c5f50d0309ede7013c0">00130</a> <span class="keywordtype">void</span> <a class="code" href="group__spi__polled__internal__group.html#ga2279b032712b6c5f50d0309ede7013c0">spi_polled_exchange_buf_list</a>(<span class="keyword">struct</span> <a class="code" href="structspi__master.html" title="SPI master.">spi_master</a> *spim,
<a name="l00131"></a>00131                 <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *write_buf_list,
<a name="l00132"></a>00132                 <span class="keyword">struct</span> <a class="code" href="structslist.html" title="A singly linked list.">slist</a> *read_buf_list)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134         <span class="keyword">struct </span><a class="code" href="structspi__master__polled.html" title="Polled SPI master defintion.">spi_master_polled</a> *spim_poll = <a class="code" href="group__spi__polled__internal__group.html#gaf0eed58d66bdc0afef8411c2093e4ddc" title="Return SPI master polled from SPI master.">spi_master_polled_of</a>(spim);
<a name="l00135"></a>00135         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>            *write_buffer;
<a name="l00136"></a>00136         <span class="keyword">struct </span><a class="code" href="structbuffer.html" title="A generic data buffer.">buffer</a>            *read_buffer;
<a name="l00137"></a>00137         <span class="keyword">const</span> <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>            *write;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(!<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(write_buf_list));
<a name="l00140"></a>00140         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(!<a class="code" href="slist_8h.html#a48452668d83e04103d667c4ba8eb2899" title="Determine if list is empty.">slist_is_empty</a>(read_buf_list));
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         write_buffer = <a class="code" href="group__buffer__group.html#ga0e091c061e88c6c38a6f92c1dd2b5671" title="Return the first buffer in list.">buf_list_peek_head</a>(write_buf_list);
<a name="l00143"></a>00143         read_buffer = <a class="code" href="group__buffer__group.html#ga0e091c061e88c6c38a6f92c1dd2b5671" title="Return the first buffer in list.">buf_list_peek_head</a>(read_buf_list);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(write_buffer-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a> == read_buffer-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         write = write_buffer-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00148"></a>00148         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a66994b5c3ed7e2af299e805d10156a0f" title="Ongoing operation bitfield (spi_polled_op_flags)">op</a> = (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a3cf63a98dcb6e6b1bf5c05cbce63ae36" title="Write operation.">SPI_OP_WRITE</a>) | (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a9f00d11e7d77bfc6716923d9f10bc63f" title="Read operation.">SPI_OP_READ</a>) |
<a name="l00149"></a>00149                 (1 &lt;&lt; <a class="code" href="group__spi__polled__internal__group.html#gga14c3986a1da7b9a08c85d87b116f3d04a99d87dd9a72ce38800a242d14b222650" title="buffer list operation">SPI_OP_BUFFER</a>);
<a name="l00150"></a>00150         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a9fe8f30521218f1f3433f70acc5e69d1" title="Current write data pointer.">write_data</a> = write + 1;
<a name="l00151"></a>00151         spim_poll-&gt;<a class="code" href="structspi__master__polled.html#a3f5db597b042b2fe66172b7add39cbe9" title="Current read data pointer.">read_data</a> = read_buffer-&gt;<a class="code" href="structbuffer.html#ab403c7e5ef17f099f36f10578e8ca1e7">addr</a>.<a class="code" href="uniondma__addr__t.html#a4926bd45b0b4ed6696524da7226e835e" title="Virtual address.">ptr</a>;
<a name="l00152"></a>00152         spim_poll-&gt;write_buffer = write_buffer;
<a name="l00153"></a>00153         spim_poll-&gt;write_buf_list = write_buf_list;
<a name="l00154"></a>00154         spim_poll-&gt;read_buffer = write_buffer;
<a name="l00155"></a>00155         spim_poll-&gt;read_buf_list = write_buf_list;
<a name="l00156"></a>00156         <a class="code" href="group__spi__polled__internal__group.html#ga17b2b593c9bce17153a2ca5293d10321" title="Start polled SPI transfer.">spi_polled_start</a>(spim, *write, write_buffer-&gt;<a class="code" href="structbuffer.html#a2966e19c7a1355df268a743450746f8e">len</a>);
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Apr 6 2011 09:50:21 for display-training by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
