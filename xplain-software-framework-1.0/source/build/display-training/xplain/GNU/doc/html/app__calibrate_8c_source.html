<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: apps/display-training/app_calibrate.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">display-training</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>apps/display-training/app_calibrate.c</h1>  </div>
</div>
<div class="contents">
<a href="app__calibrate_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;progmem.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;mainloop.h&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;gfx/gfx.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;gfx/win.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;gfx/wtk.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;gfx/sysfont.h&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;touch/touch.h&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="app__calibrate_8h.html" title="Display calibration application.">app_calibrate.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf">00064</a> <span class="preprocessor">#define CAL_OFFSET      40</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1">00066</a> <span class="preprocessor">#define CAL_RADIUS      14</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>
<a name="l00068"></a><a class="code" href="group__app__calibrate__group.html#ga90e5a31e0c865280f63abc1fd21426e2">00068</a> <span class="preprocessor">#define CAL_TRESHOLD    500</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a><a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720">00070</a> <span class="preprocessor">#define CAL_BG_COLOR    GFX_COLOR(0, 32, 128)</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a><a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d">00072</a> <span class="preprocessor">#define CAL_FG_COLOR    GFX_COLOR(0, 255, 0)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00075"></a>00075 
<a name="l00077"></a><a class="code" href="group__app__calibrate__group.html#ga6a010865b10e541735fa2da8f3cd062d">00077</a> <span class="preprocessor">#define abs(a)          (((a) &lt; 0) ? -(a) : (a))</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="structtouch__calibrate__context.html">00080</a> <span class="keyword">struct </span><a class="code" href="structtouch__calibrate__context.html" title="Application context.">touch_calibrate_context</a> {
<a name="l00082"></a><a class="code" href="structtouch__calibrate__context.html#a5b4787408c4b2c0f902d624e19d61061">00082</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a>           <a class="code" href="structtouch__calibrate__context.html#a5b4787408c4b2c0f902d624e19d61061" title="Task used for this application.">task</a>;
<a name="l00084"></a><a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24">00084</a>         <span class="keyword">struct </span><a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a>           *<a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a>;
<a name="l00086"></a><a class="code" href="structtouch__calibrate__context.html#a80e8ea4d110be0b1cab5b6d7cd2f1d3e">00086</a>         <span class="keyword">struct </span><a class="code" href="structtouch__calibration__matrix.html" title="Calibration matrix coefficients.">touch_calibration_matrix</a> <a class="code" href="structtouch__calibrate__context.html#a80e8ea4d110be0b1cab5b6d7cd2f1d3e" title="Calibration matrix to compute.">cal_matrix</a>;
<a name="l00088"></a><a class="code" href="structtouch__calibrate__context.html#ab72e5bddb5b19ba3816e9bef9a91c7a7">00088</a>         <a class="code" href="group__touch__driver__group.html#ga9997e021ac69ab7889d6a480bf6fec36" title="Pointer to touch event handler function.">touch_event_handler_t</a>           <a class="code" href="structtouch__calibrate__context.html#ab72e5bddb5b19ba3816e9bef9a91c7a7" title="Touch event handler to restore when done.">old_handler</a>;
<a name="l00090"></a><a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0">00090</a>         <a class="code" href="group__touch__driver__group.html#gae9fc9c6436f3a1f04aa10efba6b834f6" title="Array to hold calibration points.">touch_calibration_points_t</a>      <a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>;
<a name="l00092"></a><a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f">00092</a>         <span class="keyword">struct </span><a class="code" href="structtouch__event.html" title="Contains touch event type and touch point data.">touch_event</a>              <a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a>;
<a name="l00094"></a><a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15">00094</a>         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a>                         <a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>;
<a name="l00095"></a>00095 };
<a name="l00096"></a>00096 
<a name="l00098"></a><a class="code" href="group__app__calibrate__group.html#ga6d9e958ad9356900b8f16e619a98e504">00098</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structtouch__calibrate__context.html" title="Application context.">touch_calibrate_context</a> *<a class="code" href="group__app__calibrate__group.html#ga6d9e958ad9356900b8f16e619a98e504" title="Context pointer.">calibrate_context</a>;
<a name="l00099"></a>00099 
<a name="l00101"></a><a class="code" href="group__app__calibrate__group.html#ga56fd3cf46d9390ed5b251b3a0abe6c44">00101</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structfont.html" title="Storage structure for font metadata.">font</a> <a class="code" href="group__app__calibrate__group.html#ga56fd3cf46d9390ed5b251b3a0abe6c44" title="Application font in use.">sysfont1x</a>;
<a name="l00102"></a>00102 
<a name="l00108"></a>00108 <span class="keyword">static</span> <a class="code" href="group__app__calibrate__group.html#gac8115c812a85e657f27b81c54614c468" title="Calibration guide text.">DEFINE_PROGMEM</a>(<span class="keywordtype">char</span>, calibrate_help_text[]) =
<a name="l00109"></a>00109                 <span class="stringliteral">&quot;Engage calibration!\n\n\nTouch the dots now!&quot;</span>;
<a name="l00110"></a>00110 
<a name="l00119"></a><a class="code" href="group__app__calibrate__group.html#gaa1bcd5fecd235f3c2bcadddcc342085d">00119</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__app__calibrate__group.html#gaa1bcd5fecd235f3c2bcadddcc342085d" title="Touch event handler.">touch_calibrate_event_handler</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structtouch__event.html" title="Contains touch event type and touch point data.">touch_event</a> *event)
<a name="l00120"></a>00120 {
<a name="l00121"></a>00121         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a> = *event;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00142"></a><a class="code" href="group__app__calibrate__group.html#ga3c0396004f9300488a64034bd1af8975">00142</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__app__calibrate__group.html#ga3c0396004f9300488a64034bd1af8975" title="Application task worker.">touch_calibrate_task_handler</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *task)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144         <a class="code" href="group__stdint__group.html#ga2140805d08462d474b82ddc8d1c2f3e6" title="16-bit signed integer">int16_t</a>                         dx;
<a name="l00145"></a>00145         <a class="code" href="group__stdint__group.html#ga2140805d08462d474b82ddc8d1c2f3e6" title="16-bit signed integer">int16_t</a>                         dy;
<a name="l00146"></a>00146         <span class="keyword">struct </span><a class="code" href="structtouch__calibrate__context.html" title="Application context.">touch_calibrate_context</a>  *cal_ctx;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         cal_ctx = <a class="code" href="group__utility__group.html#gaf8c317a42292b61c93aae91e59118a46" title="Get the containing object.">container_of</a>(task, <span class="keyword">struct</span> <a class="code" href="structtouch__calibrate__context.html" title="Application context.">touch_calibrate_context</a>, task);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         <span class="keywordflow">switch</span> (cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>) {
<a name="l00151"></a>00151         <span class="keywordflow">case</span> 0: <span class="comment">/* Fall through */</span>
<a name="l00152"></a>00152         <span class="keywordflow">case</span> 1:
<a name="l00153"></a>00153         <span class="keywordflow">case</span> 2:
<a name="l00154"></a>00154                 <span class="comment">// Schedule task to run once more</span>
<a name="l00155"></a>00155                 <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, &amp;cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a5b4787408c4b2c0f902d624e19d61061" title="Task used for this application.">task</a>);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157                 <span class="comment">// Run until touch is released</span>
<a name="l00158"></a>00158                 <span class="keywordflow">if</span> (cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a>.<a class="code" href="structtouch__event.html#a8ac186e96ebd8e9053a676ac3a5702ce" title="Type of touch event.">type</a> != TOUCH_RELEASE)
<a name="l00159"></a>00159                         <span class="keywordflow">break</span>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161                 <span class="comment">// Store calibration values</span>
<a name="l00162"></a>00162                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a>.<a class="code" href="structtouch__event.html#a8ac186e96ebd8e9053a676ac3a5702ce" title="Type of touch event.">type</a> = TOUCH_NO_EVENT;
<a name="l00163"></a>00163                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].raw_x =
<a name="l00164"></a>00164                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a>.<a class="code" href="structtouch__event.html#ad360f7b160a8eccf477d16c3bce73759" title="Touch point data for event.">point</a>.<a class="code" href="structtouch__point.html#a8ef6d311ba143a45f94cdccb7aebea27" title="Raw X sample value.">raw_x</a>;
<a name="l00165"></a>00165                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].raw_y =
<a name="l00166"></a>00166                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a163fb48e99f724bbf6ba9edee539254f" title="Previous touch event.">event</a>.<a class="code" href="structtouch__event.html#ad360f7b160a8eccf477d16c3bce73759" title="Touch point data for event.">point</a>.<a class="code" href="structtouch__point.html#a9afa6353d611baa9b4e08c29649f5347" title="Raw Y sample value.">raw_y</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168                 dx = cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a> - 1].raw_x -
<a name="l00169"></a>00169                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].raw_x;
<a name="l00170"></a>00170                 dy = cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a> - 1].raw_y -
<a name="l00171"></a>00171                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].raw_y;
<a name="l00172"></a>00172                 dx = <a class="code" href="group__app__calibrate__group.html#ga6a010865b10e541735fa2da8f3cd062d" title="Convenience macro for getting absolute value of an integer.">abs</a>(dx);
<a name="l00173"></a>00173                 dy = <a class="code" href="group__app__calibrate__group.html#ga6a010865b10e541735fa2da8f3cd062d" title="Convenience macro for getting absolute value of an integer.">abs</a>(dy);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175                 <span class="comment">// If point is too close to the last one, wait for another touch</span>
<a name="l00176"></a>00176                 <span class="keywordflow">if</span> ((dx &lt; <a class="code" href="group__app__calibrate__group.html#ga90e5a31e0c865280f63abc1fd21426e2" title="Threshold for unintended touches on display.">CAL_TRESHOLD</a>) &amp;&amp; (dy &lt; <a class="code" href="group__app__calibrate__group.html#ga90e5a31e0c865280f63abc1fd21426e2" title="Threshold for unintended touches on display.">CAL_TRESHOLD</a>))
<a name="l00177"></a>00177                         <span class="keywordflow">break</span>;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179                 <span class="comment">// Clear old circle before moving on.</span>
<a name="l00180"></a>00180                 <a class="code" href="group__gfx__gfx.html#ga9c4d4bdc20db89b244037bf40b105fb9" title="Draw an outline of a circle or arc.">gfx_draw_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_x,
<a name="l00181"></a>00181                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_y,
<a name="l00182"></a>00182                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a>, <a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720" title="Background color for the application.">CAL_BG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184                 <a class="code" href="group__gfx__gfx.html#gac55aec68e262df67df981b646307bafd" title="Draw a filled circle or sector.">gfx_draw_filled_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_x,
<a name="l00185"></a>00185                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_y,
<a name="l00186"></a>00186                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a> / 4, <a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720" title="Background color for the application.">CAL_BG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188                 <span class="comment">// Move to next point</span>
<a name="l00189"></a>00189                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>++;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                 <span class="comment">/* Skip drawing last circles if we&#39;re done. */</span>
<a name="l00192"></a>00192                 <span class="keywordflow">if</span> (cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a> &gt;= 3)
<a name="l00193"></a>00193                         <span class="keywordflow">break</span>;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195                 <span class="comment">// Draw next circle.</span>
<a name="l00196"></a>00196                 <a class="code" href="group__gfx__gfx.html#ga9c4d4bdc20db89b244037bf40b105fb9" title="Draw an outline of a circle or arc.">gfx_draw_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_x,
<a name="l00197"></a>00197                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_y,
<a name="l00198"></a>00198                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a>, <a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d" title="Foreground color for the application.">CAL_FG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00199"></a>00199                 <a class="code" href="group__gfx__gfx.html#gac55aec68e262df67df981b646307bafd" title="Draw a filled circle or sector.">gfx_draw_filled_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_x,
<a name="l00200"></a>00200                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a>].panel_y,
<a name="l00201"></a>00201                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a> / 4, <a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d" title="Foreground color for the application.">CAL_FG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00202"></a>00202                 <span class="keywordflow">break</span>;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204         <span class="keywordflow">case</span> 3:
<a name="l00205"></a>00205                 <span class="comment">// Calibration completed</span>
<a name="l00206"></a>00206 
<a name="l00207"></a>00207                 <span class="comment">// Clear circle before moving on.</span>
<a name="l00208"></a>00208                 <a class="code" href="group__gfx__gfx.html#ga9c4d4bdc20db89b244037bf40b105fb9" title="Draw an outline of a circle or arc.">gfx_draw_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_x,
<a name="l00209"></a>00209                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_y,
<a name="l00210"></a>00210                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a>, <a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720" title="Background color for the application.">CAL_BG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00211"></a>00211                 <a class="code" href="group__gfx__gfx.html#gac55aec68e262df67df981b646307bafd" title="Draw a filled circle or sector.">gfx_draw_filled_circle</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_x,
<a name="l00212"></a>00212                                 cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_y,
<a name="l00213"></a>00213                                 <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a> / 4, <a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720" title="Background color for the application.">CAL_BG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                 <span class="comment">// Compute and assign the calibration matrix to the driver.</span>
<a name="l00216"></a>00216                 <a class="code" href="group__touch__driver__4wres__group.html#ga0c7d9a5cd00838bb6360d9cc5b0796a4" title="Compute a calibration matrix.">touch_compute_calibration_matrix</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>,
<a name="l00217"></a>00217                                 &amp;cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a80e8ea4d110be0b1cab5b6d7cd2f1d3e" title="Calibration matrix to compute.">cal_matrix</a>);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219                 <a class="code" href="group__touch__driver__4wres__group.html#ga76b43e12776395d5bbc721ada739a1fc" title="Assign a calibration matrix to the driver.">touch_set_calibration_matrix</a>(&amp;cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#a80e8ea4d110be0b1cab5b6d7cd2f1d3e" title="Calibration matrix to compute.">cal_matrix</a>);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                 <span class="comment">// Restore handler</span>
<a name="l00222"></a>00222                 <a class="code" href="group__touch__driver__4wres__group.html#ga9a76767292495609b40c1bc09dd4bca0" title="Set touch event handler for driver.">touch_set_event_handler</a>(cal_ctx-&gt;<a class="code" href="structtouch__calibrate__context.html#ab72e5bddb5b19ba3816e9bef9a91c7a7" title="Touch event handler to restore when done.">old_handler</a>);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224                 <span class="comment">// Can now free memory</span>
<a name="l00225"></a>00225                 <a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27" title="Free previously allocated memory.">membag_free</a>(calibrate_context);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227                 <span class="comment">// Schedule task if available</span>
<a name="l00228"></a>00228                 <span class="keywordflow">if</span> (calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a>) {
<a name="l00229"></a>00229                         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>,
<a name="l00230"></a>00230                                         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a>);
<a name="l00231"></a>00231                 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                 <span class="keywordflow">break</span>;
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00246"></a><a class="code" href="group__app__calibrate__group.html#ga823bf5a1dc2971123d9db629c17dc116">00246</a> <span class="keywordtype">void</span> <a class="code" href="group__app__calibrate__group.html#ga823bf5a1dc2971123d9db629c17dc116" title="Set up calibration.">app_touch_calibrate_setup</a>(<span class="keyword">struct</span> <a class="code" href="structworkqueue__task.html" title="Task to be run from a work queue.">workqueue_task</a> *<a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a>)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248         calibrate_context =
<a name="l00249"></a>00249                         <a class="code" href="group__membag__group.html#gad2210e38b675715afcd6e1f154ba2ecd" title="Allocate memory.">membag_alloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structtouch__calibrate__context.html" title="Application context.">touch_calibrate_context</a>));
<a name="l00250"></a>00250         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(calibrate_context);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">// Use small font for this application.</span>
<a name="l00253"></a>00253         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(&amp;<a class="code" href="group__app__calibrate__group.html#ga56fd3cf46d9390ed5b251b3a0abe6c44" title="Application font in use.">sysfont1x</a>, &amp;<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>, <span class="keyword">sizeof</span>(<a class="code" href="group__gfx__sysfont.html#ga9df1a6a09f606d5fa00dc3a2be10aabb" title="Initialize a basic system font.">sysfont</a>));
<a name="l00254"></a>00254         <a class="code" href="group__app__calibrate__group.html#ga56fd3cf46d9390ed5b251b3a0abe6c44" title="Application font in use.">sysfont1x</a>.<a class="code" href="structfont.html#a93930e293fe0c2a740da28bbd8f1a46d" title="Number of times characters are scaled up when being drawn.">scale</a> = 1;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">// Temporarily replace touch event handler.</span>
<a name="l00257"></a>00257         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#ab72e5bddb5b19ba3816e9bef9a91c7a7" title="Touch event handler to restore when done.">old_handler</a> = <a class="code" href="group__touch__driver__4wres__group.html#ga6df94f5d28e06f919c59c8c5c0ec176e" title="Get current touch event handler from driver.">touch_get_event_handler</a>();
<a name="l00258"></a>00258         <a class="code" href="group__touch__driver__4wres__group.html#ga9a76767292495609b40c1bc09dd4bca0" title="Set touch event handler for driver.">touch_set_event_handler</a>(<a class="code" href="group__app__calibrate__group.html#gaa1bcd5fecd235f3c2bcadddcc342085d" title="Touch event handler.">touch_calibrate_event_handler</a>);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <span class="comment">// Clear the screen and draw the calibration guide text.</span>
<a name="l00261"></a>00261         <a class="code" href="group__gfx__gfx.html#gae49753292f3bea04f21414bb2e505b7e" title="Set the clipping region.">gfx_set_clipping</a>(0, 0, <a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>(), <a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>());
<a name="l00262"></a>00262         <a class="code" href="group__gfx__gfx.html#gac466c148896f0b12a313294560e3c10c" title="Draw a filled rectangle.">gfx_draw_filled_rect</a>(0, 0, <a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>(), <a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>(),
<a name="l00263"></a>00263                         <a class="code" href="group__app__calibrate__group.html#ga8ebedefc3bca2431f8056354fc547720" title="Background color for the application.">CAL_BG_COLOR</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <a class="code" href="group__gfx__gfx.html#ga6793e821c8bcbc7a60f1230522ce1983">gfx_draw_progmem_string</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="group__progmem__group.html#ga65a73dafc06859f3859a5ed574ac9bf0" title="Attribute for indicating that a pointer argument points into program memory rather than data memory...">__progmem_arg</a> *)
<a name="l00266"></a>00266                         &amp;calibrate_help_text, 90, 100, &amp;<a class="code" href="group__app__calibrate__group.html#ga56fd3cf46d9390ed5b251b3a0abe6c44" title="Application font in use.">sysfont1x</a>, <a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d" title="Foreground color for the application.">CAL_FG_COLOR</a>,
<a name="l00267"></a>00267                         <a class="code" href="group__gfx__gfx.html#gab8aa45e3febdfb476408dffba0cc0103" title="Value used as input to font functions to give a transparent background region.">GFX_COLOR_TRANSPARENT</a>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="comment">// Set panel coordinates for all calibration points.</span>
<a name="l00270"></a>00270         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_x =
<a name="l00271"></a>00271                         (<a class="code" href="group__gfx__gfx.html#ga08c77dc3294e612b75aa054f77f22773" title="Return the current width of the screen.">gfx_get_width</a>() - <a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a> - 1);
<a name="l00272"></a>00272         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_y =
<a name="l00273"></a>00273                         (<a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>() - <a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a> - 1);
<a name="l00274"></a>00274         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[1].panel_x = (<a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a>);
<a name="l00275"></a>00275         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[1].panel_y =
<a name="l00276"></a>00276                         (<a class="code" href="group__gfx__gfx.html#ga18bda375fb523cfcb6f41862be5ba7b4" title="Return the current height of the screen.">gfx_get_height</a>() - <a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a> - 1);
<a name="l00277"></a>00277         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_x = (<a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a>);
<a name="l00278"></a>00278         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[2].panel_y = (<a class="code" href="group__app__calibrate__group.html#ga4056e50ecfc59a57bef06e6eb0c5e9cf" title="Offset from the display edges to calibration circles.">CAL_OFFSET</a>);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="comment">// Draw circle for first calibration point.</span>
<a name="l00281"></a>00281         <a class="code" href="group__gfx__gfx.html#ga9c4d4bdc20db89b244037bf40b105fb9" title="Draw an outline of a circle or arc.">gfx_draw_circle</a>(calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_x,
<a name="l00282"></a>00282                         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_y,
<a name="l00283"></a>00283                         <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a>, <a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d" title="Foreground color for the application.">CAL_FG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00284"></a>00284         <a class="code" href="group__gfx__gfx.html#gac55aec68e262df67df981b646307bafd" title="Draw a filled circle or sector.">gfx_draw_filled_circle</a>(calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_x,
<a name="l00285"></a>00285                         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#af590b1d3d4b45fe7ceefe01e8e557aa0" title="Calibration points to sample.">cal_points</a>[0].panel_y,
<a name="l00286"></a>00286                         <a class="code" href="group__app__calibrate__group.html#gac2137fc55b59f7532af8722e560599b1" title="Radius of calibration circles.">CAL_RADIUS</a> / 4, <a class="code" href="group__app__calibrate__group.html#gaaab96fb0aefad5668bd5636af4f7c99d" title="Foreground color for the application.">CAL_FG_COLOR</a>, <a class="code" href="group__gfx__gfx.html#gad283af10f27ea2911968518b9de0d82c" title="Bitmask for drawing whole circle.">GFX_WHOLE</a>);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="comment">// Initialize the calibration state and tasks before scheduling it.</span>
<a name="l00289"></a>00289         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a25cff7f95580c2b7fc6e533e1b88ad15" title="State of the calibration.">state</a> = 0;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a> = <a class="code" href="structtouch__calibrate__context.html#a45d0bcca53703fe7aafdeb0472626a24" title="Task to schedule when done.">completed_task</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <a class="code" href="group__workqueue__group.html#gac6ff4c2fe890595f39cd7d67ce8a26ed" title="Initialize a work queue task.">workqueue_task_init</a>(&amp;calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a5b4787408c4b2c0f902d624e19d61061" title="Task used for this application.">task</a>,
<a name="l00294"></a>00294                         <a class="code" href="group__app__calibrate__group.html#ga3c0396004f9300488a64034bd1af8975" title="Application task worker.">touch_calibrate_task_handler</a>);
<a name="l00295"></a>00295         <a class="code" href="group__workqueue__group.html#gaba0573bf3d1a0201616ec03944ecfd41" title="Add task to work queue.">workqueue_add_task</a>(&amp;<a class="code" href="group__workqueue__group.html#ga6c0de22a1ae8b7797e67df97f23f4707" title="The main work queue.">main_workqueue</a>, &amp;calibrate_context-&gt;<a class="code" href="structtouch__calibrate__context.html#a5b4787408c4b2c0f902d624e19d61061" title="Task used for this application.">task</a>);
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Apr 6 2011 09:50:21 for display-training by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
