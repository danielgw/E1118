<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>display-training: util/membag.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">display-training</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>util/membag.c</h1>  </div>
</div>
<div class="contents">
<a href="membag_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;debug.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;interrupt.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;util.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;physmem.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;mempool.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;membag.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;app/membag.h&gt;</span>
<a name="l00047"></a>00047 
<a name="l00049"></a><a class="code" href="structmembag.html">00049</a> <span class="keyword">struct </span><a class="code" href="structmembag.html" title="Internal structure used by membag to keep track of memory.">membag</a> {
<a name="l00050"></a><a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a">00050</a>         <span class="keywordtype">size_t</span> <a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>; 
<a name="l00051"></a><a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06">00051</a>         <span class="keywordtype">size_t</span> <a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06" title="Total number of blocks.">num_blocks</a>; 
<a name="l00052"></a><a class="code" href="structmembag.html#a9258c8fd532f08e5c447461efd7402b8">00052</a>         <span class="keyword">struct </span><a class="code" href="structphysmem__pool.html" title="A region of available physical memory.">physmem_pool</a> *<a class="code" href="structmembag.html#a9258c8fd532f08e5c447461efd7402b8" title="Pointer to physical pool to allocate mempool from.">phys_pool</a>; 
<a name="l00053"></a><a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b">00053</a>         <span class="keyword">struct </span><a class="code" href="structmem__pool.html" title="Memory pool.">mem_pool</a> <a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>; 
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="structmembag.html#a86a3ff39f2e6ec0358e9ef7330416f0d">00055</a>         <span class="keywordtype">void</span> *<a class="code" href="structmembag.html#a86a3ff39f2e6ec0358e9ef7330416f0d" title="Pointer to start of this bag.">start</a>; 
<a name="l00056"></a><a class="code" href="structmembag.html#a2ef44b49fb243c96e29044cb26e5197c">00056</a>         <span class="keywordtype">void</span> *<a class="code" href="structmembag.html#a2ef44b49fb243c96e29044cb26e5197c" title="Pointer to end of this bag.">end</a>; 
<a name="l00057"></a>00057 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>        <span class="keyword">struct </span>membag_bagstats stats; 
<a name="l00059"></a>00059 <span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>};
<a name="l00061"></a>00061 
<a name="l00073"></a><a class="code" href="membag_8c.html#a8ce87a9fc1294e7b1f9bcca8220d7099">00073</a> <span class="preprocessor">#define MEMBAG(objsize, nr_objs, pool)                  \</span>
<a name="l00074"></a>00074 <span class="preprocessor">        { .block_size = objsize, .num_blocks = nr_objs, .phys_pool = pool }</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="membag_8c.html#ab018970cc1f26ffa9bcc695059d01ecd">00098</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structmembag.html" title="Internal structure used by membag to keep track of memory.">membag</a> <a class="code" href="membag_8c.html#ab018970cc1f26ffa9bcc695059d01ecd" title="Memory bag.">membags</a>[] = {
<a name="l00099"></a>00099         <a class="code" href="apps_2display-training_2include_2app_2membag_8h.html#a2f257b2e7947f72a3a31087820aa9129" title="Set up memory sizes for Memory bag initializer.">APP_MEMBAG_INITIALIZER</a>
<a name="l00100"></a>00100 };
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 
<a name="l00115"></a><a class="code" href="membag_8c.html#a657a455ce1e44e08e6cf7ea22ab22d30">00115</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="membag_8c.html#a657a455ce1e44e08e6cf7ea22ab22d30">membag_pool_init_physmem</a>(<span class="keyword">struct</span> <a class="code" href="structmembag.html" title="Internal structure used by membag to keep track of memory.">membag</a> *mb, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> align_order)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117         <a class="code" href="cpu_2xmega_2include_2cpu_2physmem_8h.html#aaf5dda50732dd08c2496ce37ad95b0cd" title="Type representing a physical address.">phys_addr_t</a>     pool_addr;
<a name="l00118"></a>00118         <span class="keywordtype">size_t</span>          pool_size;
<a name="l00119"></a>00119         <span class="keywordtype">size_t</span>          <a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00120"></a>00120         <span class="keywordtype">void</span>            *pool_vaddr;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(mb);
<a name="l00123"></a>00123         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(mb-&gt;<a class="code" href="structmembag.html#a9258c8fd532f08e5c447461efd7402b8" title="Pointer to physical pool to allocate mempool from.">phys_pool</a>);
<a name="l00124"></a>00124         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(mb-&gt;<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a> &gt; 0);
<a name="l00125"></a>00125         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(mb-&gt;<a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06" title="Total number of blocks.">num_blocks</a> &gt; 0);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         block_size = <a class="code" href="group__utility__group.html#ga35e060c5cac459b8f76e0560894a50a0" title="Round up to the nearest power of two boundary.">round_up</a>(mb-&gt;<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>, align_order);
<a name="l00128"></a>00128         pool_size = mb-&gt;<a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06" title="Total number of blocks.">num_blocks</a> * <a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         pool_addr = <a class="code" href="physmem_8c.html#a8f300364e4a107f36791eb394cf3358f" title="Allocate a region of physical memory.">physmem_alloc</a>(mb-&gt;<a class="code" href="structmembag.html#a9258c8fd532f08e5c447461efd7402b8" title="Pointer to physical pool to allocate mempool from.">phys_pool</a>, pool_size, align_order);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(pool_addr != <a class="code" href="cpu_2xmega_2include_2cpu_2physmem_8h.html#a875b5bbcfcd277b24dd0bf543f8dc960" title="Return value indicating physical memory allocation failure.">PHYSMEM_ALLOC_ERR</a>);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         pool_vaddr = <a class="code" href="physmem__nommu_8h.html#a2101cf442c37528ffd01487d5373553b" title="Map a physical address to a virtual address.">physmem_map</a>(pool_addr, pool_size,
<a name="l00135"></a>00135                         <a class="code" href="physmem__nommu_8h.html#ad0897f344f477b5ba6de77b021c1e724" title="Write-buffering is allowed.">PHYS_MAP_WRBUF</a> | <a class="code" href="physmem__nommu_8h.html#a0ebe2e339fd5f349b76769e85afec630" title="Write-back caching is allowed.">PHYS_MAP_WRBACK</a>);
<a name="l00136"></a>00136         <a class="code" href="group__mempool__group.html#ga3fe315306db90ac9eda83190075bd043" title="Initialize a memory pool.">mem_pool_init</a>(&amp;mb-&gt;<a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>, pool_vaddr, pool_size, mb-&gt;<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>, align_order);
<a name="l00137"></a>00137         mb-&gt;<a class="code" href="structmembag.html#a86a3ff39f2e6ec0358e9ef7330416f0d" title="Pointer to start of this bag.">start</a> = pool_vaddr;
<a name="l00138"></a>00138         mb-&gt;<a class="code" href="structmembag.html#a2ef44b49fb243c96e29044cb26e5197c" title="Pointer to end of this bag.">end</a> = (<a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> *)pool_vaddr + pool_size;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>        mb-&gt;stats.num_free_blocks = mb-&gt;<a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06" title="Total number of blocks.">num_blocks</a>;
<a name="l00142"></a>00142         mb-&gt;stats.max_blocks_used = 0;
<a name="l00143"></a>00143         mb-&gt;stats.min_block_size = <a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00144"></a>00144         mb-&gt;stats.max_block_size = 0;
<a name="l00145"></a>00145         mb-&gt;stats.num_allocations = 0;
<a name="l00146"></a>00146 <span class="preprocessor">#endif</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>}
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 
<a name="l00163"></a><a class="code" href="group__membag__group.html#gafc3a131be20d2f345589430df7e8e815">00163</a> <span class="keywordtype">void</span> <a class="code" href="group__membag__group.html#gafc3a131be20d2f345589430df7e8e815" title="Initialize memory manager before use.">membag_init</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> align_order)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="comment">// Iterate over all bags and allocate them from physical memory</span>
<a name="l00168"></a>00168         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00169"></a>00169                 <a class="code" href="membag_8c.html#a657a455ce1e44e08e6cf7ea22ab22d30">membag_pool_init_physmem</a>(&amp;membags[i], align_order);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00181"></a><a class="code" href="group__membag__group.html#ga7a43e6df2bd28d5fddfd77ddcc622195">00181</a> <span class="keywordtype">size_t</span> <a class="code" href="group__membag__group.html#ga7a43e6df2bd28d5fddfd77ddcc622195" title="Total amount of memory in bytes.">membag_get_total</a>(<span class="keywordtype">void</span>)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183         <span class="keywordtype">size_t</span> total = 0;
<a name="l00184"></a>00184         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> blocks;
<a name="l00185"></a>00185         <a class="code" href="group__stdint__group.html#ga5a8b2dc9e45a9ee81a94ef304fb62505" title="16-bit unsigned integer">uint16_t</a> size;
<a name="l00186"></a>00186         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188         <span class="comment">// Iterate over all bags and sum the total memory available</span>
<a name="l00189"></a>00189         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00190"></a>00190                 size = membags[i].<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00191"></a>00191                 blocks = membags[i].<a class="code" href="structmembag.html#a805acd2457d45a76ee0e03c575627a06" title="Total number of blocks.">num_blocks</a>;
<a name="l00192"></a>00192                 total += size * blocks;
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         <span class="keywordflow">return</span> total;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>
<a name="l00205"></a>00205 <span class="keywordtype">size_t</span> membag_get_free(<span class="keywordtype">void</span>)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207         <span class="keywordtype">size_t</span> <a class="code" href="group__malloc__group.html#ga83d9424f564278d7025fc78abc4a3876" title="Free a memory object previously allocated by malloc().">free</a> = 0;
<a name="l00208"></a>00208         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// Iterate over all bags and sum the free memory available</span>
<a name="l00211"></a>00211         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00212"></a>00212                 free += membags[i].<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a> * membags[i].stats.num_free_blocks;
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">return</span> <a class="code" href="group__malloc__group.html#ga83d9424f564278d7025fc78abc4a3876" title="Free a memory object previously allocated by malloc().">free</a>;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 <span class="preprocessor">#endif</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>
<a name="l00226"></a><a class="code" href="group__membag__group.html#gad799b9cd86950091d94f81e08412a0ed">00226</a> <span class="keywordtype">size_t</span> <a class="code" href="group__membag__group.html#gad799b9cd86950091d94f81e08412a0ed" title="Smallest free block in bytes.">membag_get_smallest_free_block_size</a>(<span class="keywordtype">void</span>)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="comment">// Start at first bag and iterate up to find first available block</span>
<a name="l00231"></a>00231         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00232"></a>00232                 <span class="keywordflow">if</span> (membags[i].<a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>.<a class="code" href="structmem__pool.html#aa54dc9f6b4dbe7538a68086d8c4dd9e7" title="Pointer to the first free object in the pool.">freelist</a>) {
<a name="l00233"></a>00233                         <span class="keywordflow">return</span> membags[i].<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00234"></a>00234                 }
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236         <span class="keywordflow">return</span> 0;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00246"></a><a class="code" href="group__membag__group.html#ga5e90c339c441c6b3240767ad5fa927df">00246</a> <span class="keywordtype">size_t</span> <a class="code" href="group__membag__group.html#ga5e90c339c441c6b3240767ad5fa927df" title="Largest free block size in bytes.">membag_get_largest_free_block_size</a>(<span class="keywordtype">void</span>)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i = <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         <span class="comment">// Start at last bag and iterate down to find first available block</span>
<a name="l00251"></a>00251         <span class="keywordflow">while</span> (i &gt; 0) {
<a name="l00252"></a>00252                 i--;
<a name="l00253"></a>00253                 <span class="keywordflow">if</span> (membags[i].<a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>.<a class="code" href="structmem__pool.html#aa54dc9f6b4dbe7538a68086d8c4dd9e7" title="Pointer to the first free object in the pool.">freelist</a>) {
<a name="l00254"></a>00254                         <span class="keywordflow">return</span> membags[i].<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a>;
<a name="l00255"></a>00255                 }
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257         <span class="keywordflow">return</span> 0;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00270"></a><a class="code" href="group__membag__group.html#gad2210e38b675715afcd6e1f154ba2ecd">00270</a> <span class="keywordtype">void</span> *<a class="code" href="group__membag__group.html#gad2210e38b675715afcd6e1f154ba2ecd" title="Allocate memory.">membag_alloc</a>(<span class="keywordtype">size_t</span> size)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00273"></a>00273         <span class="keywordtype">void</span> *ptr = NULL;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="comment">// Iterate through bags to find smallest available bag</span>
<a name="l00276"></a>00276         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00277"></a>00277                 <span class="comment">// If bag is too small then skip to next bag</span>
<a name="l00278"></a>00278                 <span class="keywordflow">if</span> (membags[i].<a class="code" href="structmembag.html#afd9a9108ecbdba387f54cba3854cc10a" title="Number of bytes per block in this bag.">block_size</a> &lt; size) {
<a name="l00279"></a>00279                         <span class="keywordflow">continue</span>;
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282                 <span class="comment">// Try to allocate memory</span>
<a name="l00283"></a>00283                 ptr = <a class="code" href="group__mempool__group.html#ga5e7c4701fb65890927dc29ae4ee5e5c4" title="Allocate an object from a memory pool.">mem_pool_alloc</a>(&amp;membags[i].<a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285                 <span class="comment">// If allocation failed we continue to the next bag</span>
<a name="l00286"></a>00286                 <span class="keywordflow">if</span> (ptr == NULL) {
<a name="l00287"></a>00287                         <span class="keywordflow">continue</span>;
<a name="l00288"></a>00288                 }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>                membags[i].stats.num_free_blocks--;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293                 <span class="comment">// Update allocations</span>
<a name="l00294"></a>00294                 membags[i].stats.num_allocations++;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                 <span class="comment">// Update high/low watermarks</span>
<a name="l00297"></a>00297                 <span class="keywordflow">if</span> (membags[i].stats.num_allocations &gt;
<a name="l00298"></a>00298                                 membags[i].stats.max_blocks_used) {
<a name="l00299"></a>00299                         membags[i].stats.max_blocks_used =
<a name="l00300"></a>00300                                 membags[i].stats.num_allocations;
<a name="l00301"></a>00301                 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                 <span class="keywordflow">if</span> (size &lt; membags[i].stats.min_block_size) {
<a name="l00304"></a>00304                         membags[i].stats.min_block_size = size;
<a name="l00305"></a>00305                 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307                 <span class="keywordflow">if</span> (size &gt; membags[i].stats.max_block_size) {
<a name="l00308"></a>00308                         membags[i].stats.max_block_size = size;
<a name="l00309"></a>00309                 }
<a name="l00310"></a>00310 <span class="preprocessor">#endif</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>
<a name="l00312"></a>00312                 <span class="comment">// Memory has been allocated, skip any further looping</span>
<a name="l00313"></a>00313                 <span class="keywordflow">break</span>;
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315         <span class="keywordflow">return</span> ptr;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00327"></a><a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27">00327</a> <span class="keywordtype">void</span> <a class="code" href="group__membag__group.html#ga48cbe39bcafbfff70f900aeca0748b27" title="Free previously allocated memory.">membag_free</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329         <a class="code" href="group__stdint__group.html#gae1affc9ca37cfb624959c866a73f83c2" title="8-bit unsigned integer">uint8_t</a> i;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="comment">// Iterate through bags to free memory in correct bag</span>
<a name="l00332"></a>00332         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags); i++) {
<a name="l00333"></a>00333                 <span class="keywordflow">if</span> ((ptr &gt;= membags[i].<a class="code" href="structmembag.html#a86a3ff39f2e6ec0358e9ef7330416f0d" title="Pointer to start of this bag.">start</a>) &amp;&amp; (ptr &lt;= membags[i].<a class="code" href="structmembag.html#a2ef44b49fb243c96e29044cb26e5197c" title="Pointer to end of this bag.">end</a>)) {
<a name="l00334"></a>00334                         <span class="comment">// Found correct bag. Free memory and return</span>
<a name="l00335"></a>00335                         <a class="code" href="group__mempool__group.html#gacf196ba6a68124e0560662840fa8b113" title="Free an object previously allocated from a memory pool.">mem_pool_free</a>(&amp;membags[i].<a class="code" href="structmembag.html#a45a57a092b9ea72d54acb2981e8a112b" title="Memory pool used for allocation.">pool</a>, ptr);
<a name="l00336"></a>00336 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>                        membags[i].stats.num_free_blocks++;
<a name="l00338"></a>00338 <span class="preprocessor">#endif</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span>                        <span class="keywordflow">break</span>;
<a name="l00340"></a>00340                 }
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="preprocessor">#ifdef CONFIG_MEMBAG_USE_TUNING</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>
<a name="l00356"></a>00356 <span class="keywordtype">void</span> membag_get_bag_stats(<span class="keywordtype">size_t</span> bag_no, <span class="keyword">struct</span> membag_bagstats *stats)
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358         <a class="code" href="group__assert__group.html#gacdcc5aaebf3f273c1762f24a6ece2e5e" title="Assert that condition is true at run time.">assert</a>(bag_no &lt; <a class="code" href="group__utility__group.html#gab9129b977a587b50ea801daac75e178f" title="Get the number of elements in array a.">ARRAY_LEN</a>(membags));
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         <a class="code" href="group__string__group.html#gaba088e716bccbc96d42da97e96316df1" title="Copy memory area.">memcpy</a>(stats, &amp;membags[bag_no].stats, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> membag_bagstats));
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Apr 6 2011 09:50:22 for display-training by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
